<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: The Elektra ODBC Backend</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.11.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The Elektra ODBC Backend </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_tutorials_odbc_backend"></a> This tutorial describes how to set up unixODBC on Linux and use Elektra to retrieve configuration data from an <em>SQLite</em> or <em>PostgreSQL</em> database.</p>
<blockquote class="doxtable">
<p>Currently, the <em>backend_odbc</em> plugin is marked as EXPERIMENTAL and only data sources that define a table for <em>metadata</em> are supported. In the future, we plan to also support data sources without metadata tables.</p>
<p>Please be aware that for using metadata, <em>outer joins</em> have to be supported by the ODBC driver. </p>
</blockquote>
<blockquote class="doxtable">
<p>The ODBC backend plugin was tested with unixODBC, but should also work with iODBC and Microsoft ODBC (on Windows). If you are using such an environment, feel free to share you experiences at <a href="https://issues.libelektra.org">https://issues.libelektra.org</a> or extend this tutorial. </p>
</blockquote>
<blockquote class="doxtable">
<p>This tutorial uses SQLite- and PostgreSQL databases as data sources, but ODBC drivers for other data sources are also supported. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md4621"></a>
Overview</h1>
<p>The tutorial covers the following steps:</p>
<ol type="1">
<li>Introduction</li>
<li>Setting up the Databases for Configuration Data</li>
<li>Installing unixODBC</li>
<li>Installing the SQLite and PostgreSQL ODBC Drivers</li>
<li>Creating the ODBC data sources for the Databases</li>
<li>Compiling Elektra with support for the ODBC Backend</li>
<li>Mounting the data sources into the global Key Database (KDB) of Elektra</li>
</ol>
<h1><a class="anchor" id="autotoc_md4622"></a>
1. Introduction</h1>
<h2><a class="anchor" id="autotoc_md4623"></a>
Database scheme</h2>
<p>The basic database scheme is quite simple. You just need a table that contains two columns which can store a text value. Usually, the SQL data types <code>TEXT</code>, <code>CHAR</code> and <code>VARCHAR</code> are used for that purpose. They must contain valid UTF-8 sequences. One column is used for storing the <b>names</b> of the keys, the other one for storing their <b>values</b>. The column where the key-names are stored should be defined as the <em>primary key</em> (PK) for that table.</p>
<p>Next, we have to create a table for storing metadata. The table for the metadata needs at least three columns:</p>
<ul>
<li>A column with the <em>key-name</em> which should be defined as a <em>foreign key</em> (FK) to the PK of the table where the keys are stored.</li>
<li>A column for the <em>name</em> of the metakeys.</li>
<li>A column for the <em>value</em> of the metakeys.</li>
</ul>
<blockquote class="doxtable">
<p>The column for the <b>key-name</b> and the column for the <b>metakey-name</b> together should form the PK of that table. </p>
</blockquote>
<p>Again, all these columns must be defined to store an UTF-8 compatible text. It is allowed that the tables contain more columns, these additional columns are not processed by Elektra, <em>must not</em> be part of a PK and <em>must</em> support NULL- or DEFAULT-values (if you want to add new keys via Elektra).</p>
<p>The following ER-diagram shows the described scheme:</p>
<p><img src="unixODBC.png" alt="" class="inline" title="ER-diagram"/></p>
<h1><a class="anchor" id="autotoc_md4624"></a>
2. Setting up the Databases for Configuration Data</h1>
<p>Before we are getting started with setting up unixODBC, we create the databases and store some configuration data in them.</p>
<blockquote class="doxtable">
<p>This tutorial is neither an introduction to SQL nor to SQLite or PostgreSQL. If you need more information about these topics, there are plenty of resources available.</p>
<p>For downloads and documentation, please visit the respective websites:</p>
<ul>
<li><a href="https://www.sqlite.org">https://www.sqlite.org</a></li>
<li><a href="https://www.postgresql.org">https://www.postgresql.org</a></li>
</ul>
<p>Usually, both database management systems (DBMS) can be installed by the package manager of your operating system. </p>
</blockquote>
<blockquote class="doxtable">
<p>A pre-configured example SQLite database and the SQL-script that was used to create the tables and fill them with some test data is available at /src/plugins/backend_odbc/sampleDb. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md4625"></a>
Preparing the SQLite Database</h2>
<p>As SQLite as a file-based DBMS, we first create a file for the new database. Afterward, we execute the SQL statements to create the tables and insert some tuples. Please note that the command <code>sqlite3</code> may be named differently on your system, especially if you use another version of SQLite.</p>
<div class="fragment"><div class="line">sqlite3 ~/elektraOdbc.db</div>
</div><!-- fragment --><p>Then, the SQLite command prompt is started, where you can enter your SQL statements. We use the statements as defined in /src/plugins/backend_odbc/sampleDb/prepareDB.sql.</p>
<div class="fragment"><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> elektraKeys (</div>
<div class="line">    keyName TEXT <span class="keyword">PRIMARY</span> KEY <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">    keyValue TEXT <span class="keyword">DEFAULT</span> <span class="stringliteral">NULL</span></div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> metaKeys (</div>
<div class="line">    keyName TEXT <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">    metaKeyName TEXT <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">    metaKeyValue TEXT <span class="keyword">DEFAULT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">    <span class="keyword">CONSTRAINT</span> fk_metakeys <span class="keyword">FOREIGN</span> KEY (keyName) <span class="keyword">REFERENCES</span> elektraKeys (keyName),</div>
<div class="line">    <span class="keyword">CONSTRAINT</span> pk_metaKeys <span class="keyword">PRIMARY</span> KEY (keyName, metaKeyName)</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> elektraKeys (keyName, keyValue) <span class="keyword">VALUES</span> (<span class="stringliteral">&#39;sqliteapp1/key1&#39;</span>, <span class="stringliteral">&#39;sqlite val 1.1&#39;</span>);</div>
<div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> elektraKeys (keyName, keyValue) <span class="keyword">VALUES</span> (<span class="stringliteral">&#39;sqliteapp1/key2&#39;</span>, <span class="stringliteral">&#39;sqlite val 1.2&#39;</span>);</div>
<div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> elektraKeys (keyName, keyValue) <span class="keyword">VALUES</span> (<span class="stringliteral">&#39;sqliteapp2/key1&#39;</span>, <span class="stringliteral">&#39;sqlite val 2.1&#39;</span>);</div>
<div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> elektraKeys (keyName, keyValue) <span class="keyword">VALUES</span> (<span class="stringliteral">&#39;sqliteapp2/key2&#39;</span>, <span class="stringliteral">&#39;sqlite val 2.2&#39;</span>);</div>
<div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> elektraKeys (keyName, keyValue) <span class="keyword">VALUES</span> (<span class="stringliteral">&#39;sqliteapp2/key3&#39;</span>, <span class="stringliteral">&#39;sqlite val 2.3&#39;</span>);</div>
<div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> elektraKeys (keyName, keyValue) <span class="keyword">VALUES</span> (<span class="stringliteral">&#39;sqliteapp3/key1&#39;</span>, <span class="stringliteral">&#39;sqlite val 3.1&#39;</span>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> metaKeys (keyName, metaKeyName, metaKeyValue) <span class="keyword">VALUES</span> (<span class="stringliteral">&#39;sqliteapp1/key1&#39;</span>, <span class="stringliteral">&#39;metakey 1.1.1&#39;</span>, <span class="stringliteral">&#39;metaval 1.1.1&#39;</span>);</div>
<div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> metaKeys (keyName, metaKeyName, metaKeyValue) <span class="keyword">VALUES</span> (<span class="stringliteral">&#39;sqliteapp1/key1&#39;</span>, <span class="stringliteral">&#39;metakey 1.1.2&#39;</span>, <span class="stringliteral">&#39;metaval 1.1.2&#39;</span>);</div>
<div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> metaKeys (keyName, metaKeyName, metaKeyValue) <span class="keyword">VALUES</span> (<span class="stringliteral">&#39;sqliteapp1/key1&#39;</span>, <span class="stringliteral">&#39;metakey 1.1.3&#39;</span>, <span class="stringliteral">&#39;metaval 1.1.3&#39;</span>);</div>
<div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> metaKeys (keyName, metaKeyName, metaKeyValue) <span class="keyword">VALUES</span> (<span class="stringliteral">&#39;sqliteapp1/key1&#39;</span>, <span class="stringliteral">&#39;metakey 1.1.4&#39;</span>, <span class="stringliteral">&#39;metaval 1.1.4&#39;</span>);</div>
<div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> metaKeys (keyName, metaKeyName, metaKeyValue) <span class="keyword">VALUES</span> (<span class="stringliteral">&#39;sqliteapp2/key2&#39;</span>, <span class="stringliteral">&#39;metakey 2.2.1&#39;</span>, <span class="stringliteral">&#39;metaval 2.2.1&#39;</span>);</div>
<div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> metaKeys (keyName, metaKeyName, metaKeyValue) <span class="keyword">VALUES</span> (<span class="stringliteral">&#39;sqliteapp2/key2&#39;</span>, <span class="stringliteral">&#39;metakey 2.2.2&#39;</span>, <span class="stringliteral">&#39;metaval 2.2.2&#39;</span>);</div>
<div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> metaKeys (keyName, metaKeyName, metaKeyValue) <span class="keyword">VALUES</span> (<span class="stringliteral">&#39;sqliteapp2/key3&#39;</span>, <span class="stringliteral">&#39;metakey 2.3.1&#39;</span>, <span class="stringliteral">&#39;metaval 2.3.1&#39;</span>);</div>
</div><!-- fragment --><p>With typing <code>.exit</code>, you can leave the SQLite command prompt and return to your shell.</p>
<h2><a class="anchor" id="autotoc_md4626"></a>
Preparing the PostgreSQL Database</h2>
<p>If you want to use PostgreSQL, a bit more initial work is necessary. It is recommended to set up a user account, create a database and then create the tables using similar SQL statements as given above. You can run the PostgreSQL instance locally on the same computer where you use Elektra, but also on another node in the network. With this approach, it is possible to provide a centralized configuration storage for a whole network. As PostgreSQL natively supports transactions and multiple clients, it is also possible to share the same tables between multiple Elektra clients. Another option is to save the configurations for different users in separate tables. When a user logs in on any client PC in the network, the table with the matching configuration data can then, with some scripting, be mounted via Elektra.</p>
<p>If you need detailed information about how to set up and use a PostgreSQL DBMS instance, there is excellent documentation, including tutorials for beginners, available at the <a href="https://www.postgresql.org/docs/current/tutorial.html">PostgreSQL website</a>.</p>
<p>However, for this tutorial, we present a single-user scenario on a local PC.</p>
<h1><a class="anchor" id="autotoc_md4627"></a>
3. Installing unixODBC</h1>
<p>The easiest way to install unixODBC, is to use the package manager of your operating system. For example, in Debian and Ubuntu you can install the package with the following command:</p>
<p><code>sudo apt-get install unixodbc</code></p>
<p>Alternatively, you can also compile the unixODBC package from source. The download is available at <a href="https://www.unixodbc.org">https://www.unixodbc.org</a>. The website also offers some other useful information, like various manuals and a list of supported ODBC drivers. Using drivers not mentioned in that list is in many cases also possible.</p>
<h1><a class="anchor" id="autotoc_md4628"></a>
4. Installing the SQLite and PostgreSQL ODBC Drivers</h1>
<p>The ODBC backend was tested with the following ODBC drivers for unixODBC:</p>
<ul>
<li>SQLite: <a href="http://www.ch-werner.de/sqliteodbc">http://www.ch-werner.de/sqliteodbc</a></li>
<li>PostgreSQL: <a href="https://odbc.postgresql.org">https://odbc.postgresql.org</a></li>
</ul>
<p>The installation of the drivers should be straightforward. Please refer to the instructions on the websites and the downloaded drivers for how to install these ODBC drivers on your system. Maybe the drivers are also offered as packages by the package manager of your OS.</p>
<h1><a class="anchor" id="autotoc_md4629"></a>
5. Creating the ODBC data sources for the Databases</h1>
<p>Now we have to create or edit two configuration files for unixODBC:</p>
<ul>
<li><b>odbcinst.ini:</b> for letting unixODBC know about the drivers and where it can find them</li>
<li><b>odbc.ini:</b> for configuring the actual data sources, which can then be mounted into Elektra's KDB</li>
</ul>
<p>On most systems, these files should be stored at <code>/etc/unixODBC/</code>. The content of the <code>/etc/unixODBC/odbcinst.ini</code> file should look like this:</p>
<div class="fragment"><div class="line">[SQLite]</div>
<div class="line">Description=SQLite ODBC Driver</div>
<div class="line">Driver=/usr/local/lib/libsqlite3odbc.so</div>
<div class="line">Setup=/usr/local/lib/libsqlite3odbc.so</div>
<div class="line">FileUsage=1</div>
<div class="line">Threading=2</div>
<div class="line"> </div>
<div class="line">[Postgresql]</div>
<div class="line">Description=General ODBC for PostgreSQL</div>
<div class="line">Driver=/usr/local/lib/psqlodbca.so</div>
<div class="line">Setup=/usr/lib/libodbcpsqlS.so</div>
<div class="line">Setup64=/usr/lib64/libodbcpsqlS.so</div>
</div><!-- fragment --><p>Please check these paths and adjust them so that they match the place where the drivers and setup libraries are stored on your system. At first, the name of the entry is defined, in our example <code>SQLite</code> and <code>Postgresql</code>, then the configuration for the driver is given.</p>
<p>The <code>Threading=2</code> option enables multithreading support for the SQLite driver. If you don't need to use multiple threads/instances accessing the SQLite ODBC data source in parallel, you can gain a bit of performance by activating the single-threaded mode. In this case you can set <code>Threading=0</code>.</p>
<blockquote class="doxtable">
<p>You have to make sure for yourself that only single-threaded use is present. This setting just disables mutexes in the driver. So if you are not really sure what you are doing, it's safer to enable the multi-thread support!</p>
<p>More information about this setting is available at <a href="https://www.sqlite.org/threadsafe.html">https://www.sqlite.org/threadsafe.html</a>. </p>
</blockquote>
<p>The setting <code>FileUsage=1</code> indicates to unixODBC that the driver is file-based.</p>
<h2><a class="anchor" id="autotoc_md4630"></a>
odbc.ini</h2>
<p>After the driver settings, we have to define the actual ODBC data sources in <code>/etc/unixODBC/odbc.ini</code>. This content of the file should look like this:</p>
<div class="fragment"><div class="line">[Selektra]</div>
<div class="line">Description=SQLite Database for Elektra</div>
<div class="line">Driver=SQLite</div>
<div class="line">Database=/home/user/elektraOdbc.db</div>
<div class="line">Timeout=3500</div>
<div class="line"> </div>
<div class="line">[Pelektra]</div>
<div class="line">Description=Postgresql</div>
<div class="line">Driver=Postgresql</div>
<div class="line">Trace=No</div>
<div class="line">Database=elektraDB</div>
<div class="line">Servername=localhost</div>
<div class="line">Username=elektraUser</div>
<div class="line">Password=elektra</div>
<div class="line">Port=5432</div>
<div class="line">Protocol=6.4</div>
<div class="line">ReadOnly=No</div>
<div class="line">RowVersioning=No</div>
<div class="line">ShowSystemTables=No</div>
<div class="line">ShowOidColumn=No</div>
<div class="line">FakeOidIndex=No</div>
</div><!-- fragment --><p>At first, the data source name is chosen, in our example <code>Selektra</code> and <code>Pelektra</code>, then the configuration values for the data source are defined. The value for the key <code>Driver</code> must match the corresponding name of the entry that is defined in <code>odbcinst.ini</code>.</p>
<h1><a class="anchor" id="autotoc_md4631"></a>
6. Compiling Elektra with support for the ODBC Backend</h1>
<p>The plugin for the ODBC backend is currently marked as <b>EXPERIMENTAL</b> and therefore not built by default.</p>
<p>You must use the correct cmake-parameters for the plugin to be built. If you want to build all plugins, you can just use</p>
<div class="fragment"><div class="line">cmake -DPLUGINS=&quot;ALL&quot; &lt;path to elektra root dir&gt;</div>
</div><!-- fragment --><p>If you want the default behavior and just additionally include the ODBC backend plugin, you can use the following command:</p>
<div class="fragment"><div class="line">cmake -DPLUGINS=&quot;ALL;backend_odbc;-EXPERIMENTAL&quot; &lt;path to elektra root dir&gt;</div>
</div><!-- fragment --><p>Alternatively, you can also use the ncurses-based <code>ccmake</code> tool to define the option. For more information about how to build Elektra, please see <a class="el" href="doc_COMPILE_md.html">/doc/COMPILE.md</a>.</p>
<p>Check the cmake output to be sure that the build system finds the ODBC libraries. Otherwise, the <code>backend_odbc</code> plugin gets automatically excluded.</p>
<h1><a class="anchor" id="autotoc_md4632"></a>
7. Mounting the data sources into the global Key Database (KDB) of Elektra</h1>
<p>Now, we can finally mount our ODBC data sources into the global Key Database (KDB) of Elektra. Currently, a separate command <code>kdb mountOdbc</code> exists for this purpose. Unfortunately, in contrast to the well-known <code>kdb mount</code> for the file-based backend, currently no additional plugins are supported.</p>
<p>However, for now we use the <code>kdb mountOdbc</code> command. If you just type the command without additional arguments, you get some information about how the command works and which arguments are expected.</p>
<blockquote class="doxtable">
<p>Only <code>system:/</code> and <code>user:/</code> namespaces are supported for ODBC mountpoints. </p>
</blockquote>
<p>Finally, we can create the mountpoint for our SQLite database using the <code>kdb mountOdbc</code> command. Further details about the arguments of the command are available in its <a class="el" href="doc_help_kdb-mountOdbc_md.html">man page</a>.</p>
<div class="fragment"><div class="line">kdb mountOdbc Selektra &quot;&quot; &quot;&quot; elektraKeys keyName keyValue metaKeys keyName metaKeyName metaKeyValue &quot;&quot; user:/odbcSqlite</div>
<div class="line"># The new mountpoint for the ODBC data source was successfully created!</div>
</div><!-- fragment --><p>Now we can just access the data like with any other mountpoint.</p>
<div class="fragment"><div class="line">kdb ls user:/odbcSqlite/</div>
<div class="line"># user:/odbcSqlite/sqliteapp1/key1</div>
<div class="line"># user:/odbcSqlite/sqliteapp1/key2</div>
<div class="line"># user:/odbcSqlite/sqliteapp2/key1</div>
<div class="line"># user:/odbcSqlite/sqliteapp2/key2</div>
<div class="line"># user:/odbcSqlite/sqliteapp2/key3</div>
<div class="line"># user:/odbcSqlite/sqliteapp3/key1</div>
<div class="line"> </div>
<div class="line">kdb get /odbcSqlite/sqliteapp1/key1</div>
<div class="line"># sqlite val 1.1</div>
<div class="line"> </div>
<div class="line">kdb set /odbcSqlite/sqliteapp1/key1 newVal</div>
<div class="line">kdb get /odbcSqlite/sqliteapp1/key1</div>
<div class="line"># sqlite newVal</div>
<div class="line"> </div>
<div class="line">kdb meta-show user:/odbcSqlite/sqliteapp1/key1</div>
<div class="line"># metakey 1.1.1: metaval 1.1.1</div>
<div class="line"># metakey 1.1.2: metaval 1.1.2</div>
<div class="line"># metakey 1.1.3: metaval 1.1.3</div>
<div class="line"># metakey 1.1.4: metaval 1.1.4</div>
</div><!-- fragment --><p>For unmounting, there is not an extra command for ODBC data sources. You can unmount the ODBC backend, exactly like mounted files:</p>
<div class="fragment"><div class="line">kdb umount user:/odbcSqlite</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
