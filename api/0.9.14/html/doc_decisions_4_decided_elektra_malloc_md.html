<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Remove elektraMalloc() et al.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.9.14</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Remove <a class="el" href="internal_8c.html#a35cdc2e5caed3454cb73b4fc7f37858c" title="Allocate memory for Elektra.">elektraMalloc()</a> et al. </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_decisions_4_decided_elektra_malloc"></a> </p>
<h1><a class="anchor" id="autotoc_md2031"></a>
Problem</h1>
<p>A big problem with having <code>elektraMalloc</code> et al.ยน is, that:</p>
<ul>
<li>it makes it impossible to call libc functions that allocate data with malloc (e.g. strndup) or</li>
<li>others that expect a pointer that can be passed to realloc.</li>
</ul>
<p>You might even do that by accident and never notice the problem, until someone replaces elektraMalloc and then you could get some pretty bad memory bugs.</p>
<p>ยน Affected functions:</p>
<ul>
<li><code>elektraMalloc</code></li>
<li><code>elektraCalloc</code></li>
<li><code>elektraFree</code></li>
<li><code>elektraStrDup</code></li>
<li><code>elektraStrLen</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md2032"></a>
Constraints</h1>
<p>Proprietary apps are sometimes delivered together with a libc (either static or a startup script makes sure their own libs are found). If they would use Elektra, and the person wants the app to use the global Elektra it is a valid use case for the dedicated functions.</p>
<h1><a class="anchor" id="autotoc_md2033"></a>
Assumptions</h1>
<p>The only safe way to keep elektraMalloc et al. is to define that they will always call their libc counterpart (malloc et al.) and their purpose is simply to add assertions. Then we can also make them private, because you can just call free to free any pointer returned by Elektra.</p>
<h1><a class="anchor" id="autotoc_md2034"></a>
Considered Alternatives</h1>
<ul>
<li>Completely replace <code>elektraMalloc</code> / <code>elektraCalloc</code> with simple calls to malloc</li>
<li>Fix all places where non-Elektra functions get used</li>
</ul>
<h1><a class="anchor" id="autotoc_md2035"></a>
Decision</h1>
<ul>
<li>keep current state with the custom functions (allocators)</li>
<li>make it optional for plugin developers to use language specific allocators or our custom allocators</li>
<li>remove everything except <code>elektraFree</code> from public API</li>
<li>remove all functions that don't actually involve any memory allocations (e.g. <code>elektraStrLen</code>, <code>elektraStrCmp</code>)</li>
<li>add <code>elektraStrNDup</code> and other <code>stdlib</code> equivalents that do memory allocation.</li>
</ul>
<h1><a class="anchor" id="autotoc_md2036"></a>
Rationale</h1>
<p>While the current state might cause some problems with compiler optimizations and discoverability, those issues probably are only very minor in practice. Removing all functions poses a considerable amount of work, which would have to be undone in case we need those functions one day anyway. The current downsides don't justify such a big procedure.</p>
<h1><a class="anchor" id="autotoc_md2037"></a>
Implications</h1>
<h1><a class="anchor" id="autotoc_md2038"></a>
Related Decisions</h1>
<h1><a class="anchor" id="autotoc_md2039"></a>
Notes</h1>
<p>@kodebach wrote: Ideally, I'd remove the functions, but it seems unlikely this will be accepted. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
