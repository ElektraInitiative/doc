<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Plugin: specload</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Elektra
   &#160;<span id="projectnumber">0.9.8</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Plugin: specload </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>infos = Information about the specload plugin is in keys below</li>
<li>infos/author = Klemens BÃ¶swirth <a href="#" onclick="location.href='mai'+'lto:'+'k.b'+'oe'+'swi'+'rt'+'h+g'+'it'+'@gm'+'ai'+'l.c'+'om'; return false;">k.boe<span style="display: none;">.nosp@m.</span>swir<span style="display: none;">.nosp@m.</span>th+gi<span style="display: none;">.nosp@m.</span>t@gm<span style="display: none;">.nosp@m.</span>ail.c<span style="display: none;">.nosp@m.</span>om</a></li>
<li>infos/licence = BSD</li>
<li>infos/needs =</li>
<li>infos/provides = storage/specload</li>
<li>infos/recommends =</li>
<li>infos/placements = getstorage setstorage</li>
<li>infos/status = maintained nodep libc configurable unfinished</li>
<li>infos/metadata =</li>
<li>infos/description = loads a specification from an external application</li>
</ul>
<h1><a class="anchor" id="src_plugins_specload_README_md"></a>
Introduction</h1>
<p>In order to optimally use Elektra an application has to provide a specification. This specification has to be mounted in the <code>spec</code> namespace by the user (or automatically during the install process). However, this specification should in most cases not be modified by the user. If it is modified the user has to be sure it is still compatible to the original specification. Otherwise the application might crash because it e.g. expected a default value to be provided by the specification that the user changed or removed.</p>
<p>This is were this plugin comes in. Unlike other storage plugins <code>specload</code> doesn't use the file given during mounting for most of the configuration. Instead <code>specload</code> requests the specification with which an application was compiled from the application itself. On top of this base specifications the user can make some modifications, which are the only keys stored in the mounted file. All modifications made by the user are verified by the plugin. The user can never modify the specification in a way to would break application compatibility.</p>
<p>NOTE: currently the modifications a user can make are very limited/not possible. See <a href="#limitations">Limitations</a> below.</p>
<h1><a class="anchor" id="autotoc_md519"></a>
Dependencies</h1>
<p>The plugin relies heavily on the <code>quickdump</code> plugin. It is used for storing the overridden values as well as the data transfer between <code>specload</code> and an application.</p>
<p>To check whether <code>quickdump</code> is available you can use:</p>
<div class="fragment"><div class="line">kdb plugin-list quickdump</div>
<div class="line">#&gt; quickdump</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md520"></a>
Usage</h1>
<p>To mount <code>specload</code> use (note: only the <code>spec</code> namespace is supported):</p>
<div class="fragment"><div class="line"># specload will call &#39;/usr/bin/exampleapp --elektra-spec&#39;</div>
<div class="line">kdb mount specload.eqd spec:/tests/specload/example specload &#39;app=/usr/bin/exampleapp&#39;</div>
</div><!-- fragment --><p>You always have to specify the <code>app</code> that shall be called. This application will be called with the single argument <code>--elektra-spec</code>. This can be configured by using <code>app/args/#</code> during mounting:</p>
<div class="fragment"><div class="line"># specload will call &#39;/usr/bin/exampleapp -o spec&#39;</div>
<div class="line">kdb mount specload.eqd spec:/tests/specload/example specload &#39;app=/usr/bin/exampleapp&#39; &#39;app/args=#1&#39; &#39;app/args/#0=-o&#39; &#39;app/args/#1=spec&#39;</div>
</div><!-- fragment --><p>To inhibit the default <code>--elektra-spec</code> argument and call an application without any arguments use &lsquo;'app/args=&rsquo;`.</p>
<p>The app must only output the expected base specification to <code>stdout</code> and then exit, when called by <code>specload</code>. We use the <code>quickdump</code> plugin for communication, so the application should call <code>elektraQuickdumpSet</code>. Because this dependency may change in future, it is recommended you use the function <code>elektraSpecloadSendSpec</code> exported as <code>"system:/elektra/modules/specload/exports/sendspec"</code>:</p>
<div class="fragment"><div class="line">Key * errorKey = <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (<span class="stringliteral">&quot;/&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// add &#39;system:/sendspec&#39; key to suppress checking the &#39;app&#39; key in elektraSpecloadOpen</span></div>
<div class="line">KeySet * specloadConf = <a class="code" href="group__keyset.html#ga671e1aaee3ae9dc13b4834a4ddbd2c3c">ksNew</a> (1, <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (<span class="stringliteral">&quot;system:/sendspec&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>), <a class="code" href="group__keyset.html#ga7a28fce3773b2c873c94ac80b8b4cd54">KS_END</a>);</div>
<div class="line">ElektraInvokeHandle * specload = <a class="code" href="group__invoke.html#ga3eb20131e9a8fc9a6cebf126927c09bc">elektraInvokeOpen</a> (<span class="stringliteral">&quot;specload&quot;</span>, specloadConf, errorKey);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> result = <a class="code" href="group__invoke.html#gaa257d93399c60f73c611205bbfa7c9a0">elektraInvoke2Args</a> (specload, <span class="stringliteral">&quot;sendspec&quot;</span>, ks, NULL);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="group__invoke.html#ga684a21daa0b3c20783c55184a9157b3b">elektraInvokeClose</a> (specload, errorKey);</div>
<div class="line"><a class="code" href="group__key.html#ga3df95bbc2494e3e6703ece5639be5bb1">keyDel</a> (errorKey);</div>
<div class="line"><a class="code" href="group__keyset.html#ga27e5c16473b02a422238c8d970db7ac8">ksDel</a> (specloadConf);</div>
<div class="ttc" id="agroup__invoke_html_ga3eb20131e9a8fc9a6cebf126927c09bc"><div class="ttname"><a href="group__invoke.html#ga3eb20131e9a8fc9a6cebf126927c09bc">elektraInvokeOpen</a></div><div class="ttdeci">ElektraInvokeHandle * elektraInvokeOpen(const char *elektraPluginName, KeySet *config, Key *errorKey)</div><div class="ttdoc">Opens a new handle to invoke functions for a plugin.</div><div class="ttdef"><b>Definition:</b> invoke.c:94</div></div>
<div class="ttc" id="agroup__invoke_html_ga684a21daa0b3c20783c55184a9157b3b"><div class="ttname"><a href="group__invoke.html#ga684a21daa0b3c20783c55184a9157b3b">elektraInvokeClose</a></div><div class="ttdeci">void elektraInvokeClose(ElektraInvokeHandle *handle, Key *errorKey)</div><div class="ttdoc">Closes all affairs with the handle.</div><div class="ttdef"><b>Definition:</b> invoke.c:318</div></div>
<div class="ttc" id="agroup__invoke_html_gaa257d93399c60f73c611205bbfa7c9a0"><div class="ttname"><a href="group__invoke.html#gaa257d93399c60f73c611205bbfa7c9a0">elektraInvoke2Args</a></div><div class="ttdeci">int elektraInvoke2Args(ElektraInvokeHandle *handle, const char *elektraPluginFunctionName, KeySet *ks, Key *k)</div><div class="ttdoc">A convenience function to call a function with two arguments.</div><div class="ttdef"><b>Definition:</b> invoke.c:293</div></div>
<div class="ttc" id="agroup__key_html_ga3df95bbc2494e3e6703ece5639be5bb1"><div class="ttname"><a href="group__key.html#ga3df95bbc2494e3e6703ece5639be5bb1">keyDel</a></div><div class="ttdeci">int keyDel(Key *key)</div><div class="ttdoc">A destructor for Key objects.</div><div class="ttdef"><b>Definition:</b> key.c:504</div></div>
<div class="ttc" id="agroup__key_html_gad23c65b44bf48d773759e1f9a4d43b89"><div class="ttname"><a href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a></div><div class="ttdeci">Key * keyNew(const char *name,...)</div><div class="ttdoc">A practical way to fully create a Key object in one step.</div><div class="ttdef"><b>Definition:</b> key.c:144</div></div>
<div class="ttc" id="agroup__key_html_gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403"><div class="ttname"><a href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a></div><div class="ttdeci">@ KEY_END</div><div class="ttdef"><b>Definition:</b> kdbenum.c:97</div></div>
<div class="ttc" id="agroup__keyset_html_ga27e5c16473b02a422238c8d970db7ac8"><div class="ttname"><a href="group__keyset.html#ga27e5c16473b02a422238c8d970db7ac8">ksDel</a></div><div class="ttdeci">int ksDel(KeySet *ks)</div><div class="ttdoc">A destructor for KeySet objects.</div><div class="ttdef"><b>Definition:</b> keyset.c:451</div></div>
<div class="ttc" id="agroup__keyset_html_ga671e1aaee3ae9dc13b4834a4ddbd2c3c"><div class="ttname"><a href="group__keyset.html#ga671e1aaee3ae9dc13b4834a4ddbd2c3c">ksNew</a></div><div class="ttdeci">KeySet * ksNew(size_t alloc,...)</div><div class="ttdoc">Allocate, initialize and return a new KeySet object.</div><div class="ttdef"><b>Definition:</b> keyset.c:229</div></div>
<div class="ttc" id="agroup__keyset_html_ga7a28fce3773b2c873c94ac80b8b4cd54"><div class="ttname"><a href="group__keyset.html#ga7a28fce3773b2c873c94ac80b8b4cd54">KS_END</a></div><div class="ttdeci">#define KS_END</div><div class="ttdoc">End of a list of keys.</div><div class="ttdef"><b>Definition:</b> kdbenum.c:158</div></div>
</div><!-- fragment --><p>The code above will automatically print the KeySet <code>ks</code> to stdout in exactly the way <code>specload</code> expects it.</p>
<p>Once the mounting is done you can inspect you specification like you would with any other mounted configuration. If you call <code>kdb set</code> (or <code>kdb meta-set</code> or anything else that calls <code><a class="el" href="group__kdb.html#ga11436b058408f83d303ca5e996832bcf" title="Set Keys to a Key database in an atomic and universal way.">kdbSet()</a></code>), however, <code>specload</code> will verify that the modifications you made are compatible with the original specification. Currently this verification is very restrictive and doesn't allow a lot of changes that would be safe. This is because the necessary verification becomes very complex very quickly. For example adding <code>opt/arg</code> is only safe, if <code>opt</code> was also added by the user, because the application might rely on the default <code>opt/arg=none</code>. See also <a href="#limitations">Limitations</a>.</p>
<h2><a class="anchor" id="autotoc_md521"></a>
Direct File Mode</h2>
<p>Instead of loading the specification via <code>stdin</code>/<code>stdout</code> from another app, you can also instruct <code>specload</code> to directly load a <code>quickdump</code> file. This can be done by setting the <code>file</code> config key instead of <code>app</code>. The provided path must be absolute, same as an <code>app</code> path.</p>
<p>Note: If <code>file</code> is specified, <code>app</code> will be ignored.</p>
<h1><a class="anchor" id="autotoc_md522"></a>
Examples</h1>
<p>This assumes you compiled the file <a href="/home/jenkins/workspace/libelektra-release/src/plugins/specload/testapp.c"><code>testapp.c</code></a> and it is available as the executable <code>testapp</code> in the current folder.</p>
<div class="fragment"><div class="line">sudo kdb mount -R noresolver specload.eqd spec:/tests/specload specload &quot;app=$(pwd)/testapp&quot;</div>
<div class="line"> </div>
<div class="line">kdb meta-ls spec:/tests/specload/mykey</div>
<div class="line">#&gt; default</div>
<div class="line"> </div>
<div class="line">kdb get /tests/specload/mykey</div>
<div class="line">#&gt; 7</div>
<div class="line"> </div>
<div class="line">sudo kdb umount spec:/tests/specload</div>
</div><!-- fragment --><p>Or in direct file mode:</p>
<div class="fragment"><div class="line"># This assumes that `$PWD` is the root of the Elektra source tree.</div>
<div class="line">sudo kdb mount -R noresolver specload.eqd spec:/tests/specload specload &quot;file=$(pwd)/src/plugins/specload/specload/spec.quickdump&quot;</div>
<div class="line"> </div>
<div class="line">kdb meta-ls spec:/tests/specload/mykey</div>
<div class="line">#&gt; default</div>
<div class="line"> </div>
<div class="line">kdb get /tests/specload/mykey</div>
<div class="line">#&gt; 7</div>
<div class="line"> </div>
<div class="line">sudo kdb umount spec:/tests/specload</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md523"></a>
Limitations</h1>
<ul>
<li>The plugin only allows the following modifications right now:<ul>
<li>add/edit/remove <code>description</code> or <code>opt/help</code></li>
<li>add/edit <code>default</code></li>
<li>add <code>type</code></li>
</ul>
</li>
<li>The plugin must be mounted using <code>noresolver</code> or another resolver that always calls the storage plugin. To work around this limitation, <code>specload</code> prefixes relative paths with <code>KDB_DB_SPEC</code> before passing the path on to <code>quickdump</code>. This means that your overlay files will be stored in the same directory as any other <code>spec</code> configurations. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
