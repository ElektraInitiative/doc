<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Plugin: process</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.9.12</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Plugin: process </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>infos = Information about the process plugin is in keys below</li>
<li>infos/author = Klemens BÃ¶swirth <a href="#" onclick="location.href='mai'+'lto:'+'k.b'+'oe'+'swi'+'rt'+'h+g'+'it'+'@gm'+'ai'+'l.c'+'om'; return false;">k.boe<span style="display: none;">.nosp@m.</span>swir<span style="display: none;">.nosp@m.</span>th+gi<span style="display: none;">.nosp@m.</span>t@gm<span style="display: none;">.nosp@m.</span>ail.c<span style="display: none;">.nosp@m.</span>om</a></li>
<li>infos/licence = BSD</li>
<li>infos/needs =</li>
<li>infos/provides =</li>
<li>infos/recommends =</li>
<li>infos/placements = postgetstorage presetstorage</li>
<li>infos/status = maintained unittest shelltest</li>
<li>infos/metadata =</li>
<li>infos/description = one-line description of process</li>
</ul>
<h1><a class="anchor" id="src_plugins_process_README_md"></a>
Introduction</h1>
<p>This plugin spawns a new process with a user-defined executable and delegates all operations to the new process.</p>
<h1><a class="anchor" id="autotoc_md402"></a>
Usage</h1>
<p>Set the config key <code>executable</code> and the arrays <code>args/#</code>, <code>env/#</code> to the path of an executable, the arguments that shall be passed and the environment variables to be set.</p>
<div class="fragment"><div class="line">kdb mount test.dump /tests/process process &#39;executable=/usr/bin/pluginproc&#39; &#39;args=#1&#39; &#39;args/#0=--load-plugin&#39; &#39;args/#1=myplugin&#39;</div>
</div><!-- fragment --><p>During <code>elektraStdprocioOpen</code> the plugin will collect the <code>args/#</code> and <code>env/#</code> values into two arrays <code>argv</code> and <code>envp</code>. Additionally, the array <code>copyenv/#</code> is read as a list of environment variables. Each variable will be looked up via <code>getenv</code> and then added to <code>envp</code>.</p>
<p>The plugin then <code>fork</code>s a new process and the child calls <code>execve</code> with the path from <code>app</code> as well as <code>argv</code> and<code>envp</code>. The child process is expected to listen to <code>stdin</code> and write to <code>stdout</code> according to the protocol described below.</p>
<p>If communication can be established, the child process will be kept running until <code>elektraStdprocioClose</code>.</p>
<h1><a class="anchor" id="autotoc_md403"></a>
Protocol</h1>
<p>The entire protocol is text-based (apart from binary key values) and request-response-based, and happens over <code>stdin</code>/<code>stdout</code>. The parent process sends request to the child process. The child then processes the request and sends a response back.</p>
<p>To encode keysets and keys we use the format of the <code>dump</code> plugin. It is important to note that the <code>dump</code> plugin is instructed to write the full keynames (normally it removes the parent prefix). There is, however, an exception during initialization, which is described in the appropriate section. The child process may also delegate directly to the <code>dump</code> plugin, or reimplement the encoding.</p>
<p>The communications protocol used by the plugin has 3 phases:</p>
<ul>
<li>Initialization: Initial handshake after first starting the child-process.</li>
<li>Operation: The main phase, which implements all the operations of an Elektra plugin (open, get, set, close, ...).</li>
<li>Termination: The plugin is being closed and the parent-process tells the child to shut down.</li>
</ul>
<blockquote class="doxtable">
<p><b>Note:</b> In the sections below we use the following format to describe messages:</p>
<div class="fragment"><div class="line">Parent &gt; Child</div>
<div class="line"> </div>
<div class="line">HELLO WORLD</div>
<div class="line">[users]</div>
<div class="line">(user)</div>
<div class="line">{ok|error}</div>
</div><!-- fragment --><p>This denotes a message sent from parent to child, containing</p>
<ul>
<li>the literal text <code>HELLO WORLD</code></li>
<li>followed by a newline</li>
<li>followed by a keyset called <code>users</code></li>
<li>followed by a newline</li>
<li>followed by dynamic text called <code>user</code></li>
<li>followed by either the literal text <code>ok</code> or the literal text <code>error</code></li>
</ul>
<p>The names <code>users</code> and <code>user</code> don't actually appear in the message. They are only used as a reference for the descriptions of the message.</p>
<p>The actual message sent could look like this:</p>
<div class="fragment"><div class="line">HELLO WORLD</div>
<div class="line">kdbOpen 2</div>
<div class="line">$key string 3 5</div>
<div class="line">joe</div>
<div class="line">12345</div>
<div class="line">$end</div>
<div class="line">appleseed</div>
</div><!-- fragment --> </blockquote>
<h2><a class="anchor" id="autotoc_md404"></a>
Initialization</h2>
<p>The parent writes the protocol header to <code>stdin</code> of the child.</p>
<div class="fragment"><div class="line">Parent &gt; Child</div>
<div class="line"> </div>
<div class="line">ELEKTRA_PROCESS INIT v1</div>
</div><!-- fragment --><p>The child must respond with an acknowledgement, followed by a <code>contract</code> keyset.</p>
<div class="fragment"><div class="line">Child &gt; Parent</div>
<div class="line"> </div>
<div class="line">ELEKTRA_PROCESS ACK v1</div>
<div class="line">(name)</div>
<div class="line">[contract]</div>
</div><!-- fragment --><p>Here <code>(name)</code> is the module name the child uses. This will be used to replace <code>process</code> in the contract of the plugin. The <code>[contract]</code> keyset must contain the <code>infos</code> keys, which will be used replace the ones at the top of this README and the ones in <code>process.c</code>. It must also contain <code>exports/_</code> keys for every operation that is implemented by the child. All keys in <code>[contract]</code> should be below <code>system:/elektra/modules/process</code>. The parent will rename these keys appropriately.</p>
<p>A child that implements all operations should include these keys (in addition to the relevant <code>infos</code> keys):</p>
<div class="fragment"><div class="line">system:/elektra/modules/process/exports/open = 1</div>
<div class="line">system:/elektra/modules/process/exports/close = 1</div>
<div class="line">system:/elektra/modules/process/exports/get = 1</div>
<div class="line">system:/elektra/modules/process/exports/set = 1</div>
</div><!-- fragment --><p>After this initial handshake, the child should simply wait for further requests from the parent.</p>
<blockquote class="doxtable">
<p><b>Note</b>: Under normal circumstances this handshake will always be followed by an <code>open</code> request immediately. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md405"></a>
Operation</h2>
<p>When the parent needs the child to process an operation (open, get, ...), it will send a request like this:</p>
<div class="fragment"><div class="line">Parent &gt; Child</div>
<div class="line"> </div>
<div class="line">{open|get|set|close}</div>
<div class="line">[parent]</div>
<div class="line">[data]</div>
</div><!-- fragment --><p>First we send the <code>opname</code> (one of <code>open</code>, <code>get</code>, <code>set</code> or <code>close</code>) of the operation that shall be performed by the child. The keyset <code>[parent]</code> always consists of a single key, namely the <code>parentKey</code> (or <code>errorKey</code>) that was passed to the plugin. Finally, <code>[data]</code> is the keyset that was passed to the plugin. The <code>[data]</code> keyset is not present in <code>open</code> and <code>close</code> operations, since those don't receive a <code>KeySet</code> in the C API. However, in the <code>open</code> operation <code>[data]</code> is replaced <code>[config]</code> which is the <code>KeySet</code> returned by <code>elektraPluginGetConfig</code> in the C API. This is needed, because the child process cannot request the config keyset otherwise.</p>
<p>The child should then perform the requested operation and respond with</p>
<div class="fragment"><div class="line">Child &gt; Parent</div>
<div class="line"> </div>
<div class="line">{success|noupdate|error}</div>
<div class="line">[parent]</div>
<div class="line">[returned]</div>
</div><!-- fragment --><p>Here <code>(result)</code> is one of <code>success</code>, <code>noupdate</code> and <code>error</code>, which correspond to <code>ELEKTRA_PLUGIN_STATUS_SUCCESS</code>, <code>ELEKTRA_PLUGIN_STATUS_NO_UPDATE</code> and <code>ELEKTRA_PLUGIN_STATUS_ERROR</code> respectively. The keysets <code>[parent]</code> and <code>[returned]</code> are the modified versions of the one sent by the parent.</p>
<h2><a class="anchor" id="autotoc_md406"></a>
Termination</h2>
<p>When the parent no longer needs the child process, it will send a final termination request.</p>
<div class="fragment"><div class="line">Parent &gt; Child</div>
<div class="line"> </div>
<div class="line">ELEKTRA_PROCESS TERMINATE</div>
</div><!-- fragment --><p>The child process should now exit (and thereby close its ends of the <code>stdin</code>/<code>stdout</code> pipes).</p>
<blockquote class="doxtable">
<p><b>Note:</b> Under normal circumstances this only happens, when plugin is being closed, i.e. during a <code>elektraPluginClose</code> call for a <code>process</code> instance. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md407"></a>
Errors</h2>
<p>If an unexpected error occurs on either side of the protocol, the connection should be terminated and the child process shall exit.</p>
<h1><a class="anchor" id="autotoc_md408"></a>
Examples</h1>
<div class="fragment"><div class="line"># mount the Whitelist Java Plugin via process</div>
<div class="line"># NOTE: the copyenv and copyenv/#0 are normal not needed, but we need them to make this script work as an automated test</div>
<div class="line">sudo kdb mount config.file user:/tests/process dump process &#39;executable=/usr/bin/java&#39; &#39;args=#3&#39; &#39;args/#0=-cp&#39; &quot;args/#1=$BUILD_DIR/src/bindings/jna/plugins/whitelist/build/libs/whitelist-$(kdb --version | sed -nE &#39;s/KDB_VERSION: (.+)/\1/gp&#39;)-all.jar&quot; &#39;args/#2=org.libelektra.process.PluginProcess&#39; &#39;args/#3=org.libelektra.plugin.WhitelistPlugin&#39; &#39;copyenv=#0&#39; &quot;copyenv/#0=LD_LIBRARY_PATH&quot;</div>
<div class="line"> </div>
<div class="line"># Define whitelist</div>
<div class="line">kdb meta-set user:/tests/process/key &quot;check/whitelist/#0&quot; &quot;&quot;</div>
<div class="line">kdb meta-set user:/tests/process/key &quot;check/whitelist/#1&quot; allowed0</div>
<div class="line">kdb meta-set user:/tests/process/key &quot;check/whitelist/#2&quot; allowed1</div>
<div class="line"> </div>
<div class="line"># Should be allowed</div>
<div class="line">kdb set user:/tests/process/key allowed0</div>
<div class="line">#&gt; Set string to &quot;allowed0&quot;</div>
<div class="line"> </div>
<div class="line">kdb set user:/tests/process/key allowed1</div>
<div class="line">#&gt; Set string to &quot;allowed1&quot;</div>
<div class="line"> </div>
<div class="line"># Should cause error</div>
<div class="line">kdb set user:/tests/process/key not_allowed</div>
<div class="line"># RET: 5</div>
<div class="line"># STDERR:.*Validation Semantic: .*&#39;not_allowed&#39; does not adhere to whitelist.*</div>
<div class="line"> </div>
<div class="line"># cleanup</div>
<div class="line">kdb rm -r user:/tests/process</div>
<div class="line">sudo kdb umount user:/tests/process</div>
</div><!-- fragment --><blockquote class="doxtable">
<p><b>Note:</b> The mount line of the snippet above can be simplified by using the <code>mount-java</code> helper:</p>
<div class="fragment"><div class="line">sudo kdb mount-java config.file user:/tests/process dump java:org.libelektra.plugin.WhitelistPlugin</div>
</div><!-- fragment --> </blockquote>
<h1><a class="anchor" id="autotoc_md409"></a>
Limitations</h1>
<ul>
<li>The <code>error</code> and <code>commit</code> functions are currently not supported. Therefore, implementing a resolver is not supported.</li>
<li>Exporting additional functions (e.g. <code>checkconf</code>) is currently not supported.</li>
<li>With the current backend system, <code>process</code> can only be used for plugins in the <code>postgetstorage</code> or <code>presetstorage</code> positions.</li>
<li>The executable must be defined as an absolute path during mounting. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
