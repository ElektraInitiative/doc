<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Builder Functions for &lt;tt&gt;Key&lt;/tt&gt; and &lt;tt&gt;KeySet&lt;/tt&gt;</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.9.13</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Builder Functions for <code>Key</code> and <code>KeySet</code> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_decisions_0_drafts_builder_functions"></a> </p>
<h1><a class="anchor" id="autotoc_md1705"></a>
Problem</h1>
<p>The structs for <code>Key</code> and <code>KeySet</code> are opaque, i.e., only the <code>typedef</code>s are part of the public headers, the actual <code>struct</code> definitions are in a private header. Because of that, <code>libelektra-core</code> must provide a way to construct a new <code>Key</code> or <code>KeySet</code>.</p>
<p>Both <code>Key</code> and <code>KeySet</code> are rather complex structures consisting of multiple parts (name, value, metadata, and collection of <code>Key</code>s respectively), and <code>libelektra-core</code> is supposed to be minimal. It therefore makes sense to provide additional functions outside <code>libelektra-core</code> that make building <code>Key</code>s and <code>KeySet</code>s easier.</p>
<p>We call these functions "builder functions" compared to the <a class="el" href="doc_decisions_0_drafts_constructor_functions_md.html">Constructor Functions for <code>Key</code> and <code>KeySet</code></a>constructor functions"" in <code>libelektra-core</code>.</p>
<h1><a class="anchor" id="autotoc_md1706"></a>
Constraints</h1>
<ul>
<li>If the builder functions are in a non-language specific library, they must be directly callable from all languages for which Elektra provides bindings.</li>
<li>In accordance with the <a class="el" href="doc_decisions_4_decided_keyname_md.html">Namespace and Name of Keys</a>Namespace and Name of Keys" decision", the builder functions must not use the escaped name. Only the unescaped name may be used, but the namespace may be passed as a separate parameter, if this has benefits. Additionally, it might make sense to take the parts of a keyname as separate arguments.</li>
</ul>
<h1><a class="anchor" id="autotoc_md1707"></a>
Assumptions</h1>
<h1><a class="anchor" id="autotoc_md1708"></a>
Considered Alternatives</h1>
<h2><a class="anchor" id="autotoc_md1709"></a>
Language Agnostic</h2>
<blockquote class="doxtable">
<p><b>Note</b>: This is basically, the "Full Arguments" solution from the <a class="el" href="doc_decisions_0_drafts_constructor_functions_md.html">constructor functions decision</a>. </p>
</blockquote>
<div class="fragment"><div class="line">Key * keyBuild (<span class="keyword">const</span> KeyName * name, <span class="keyword">const</span> KeyValue * value, <span class="keyword">const</span> KeyMeta metadata[]);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// allocates space for at least `alloc` keys</span></div>
<div class="line"><span class="comment">// inserts all keys from `keys` until it finds a NULL pointer, `keys` must contain at least one NULL</span></div>
<div class="line">KeySet * ksBuild (<span class="keywordtype">size_t</span> alloc, <span class="keyword">const</span> Key * keys[]);</div>
</div><!-- fragment --><p>This could be called as:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> a = 7;</div>
<div class="line"> </div>
<div class="line">ksBuild(</div>
<div class="line">  3,</div>
<div class="line">  (Key*[]) {</div>
<div class="line">    keyBuild (</div>
<div class="line">      &amp;(KeyName){.ns = ELEKTRA_NS_SYSTEM, .name = <span class="stringliteral">&quot;foo\0bar&quot;</span>, .size = 8 },</div>
<div class="line">      &amp;(KeyValue){.value = <span class="stringliteral">&quot;1234&quot;</span>, .size = 5},</div>
<div class="line">      (KeyMeta[]){</div>
<div class="line">        {.name = <span class="stringliteral">&quot;type&quot;</span>, .nameSize = 5, .value = {.value = <span class="stringliteral">&quot;long&quot;</span>, .size = 5}},</div>
<div class="line">        {.name = <span class="stringliteral">&quot;length\0min&quot;</span>, .nameSize = 11, .value = {.value = <span class="stringliteral">&quot;4&quot;</span>, .size = 2}},</div>
<div class="line">      }</div>
<div class="line">    ),</div>
<div class="line">    keyBuild (</div>
<div class="line">      &amp;(KeyName){.ns = ELEKTRA_NS_SYSTEM, .name = <span class="stringliteral">&quot;foo&quot;</span>, .size = 4 },</div>
<div class="line">      &amp;(KeyValue){.value = &amp;a, .size = <span class="keyword">sizeof</span>(a)},</div>
<div class="line">      NULL</div>
<div class="line">    ),</div>
<div class="line">    keyBuild (&amp;(KeyName){.ns = ELEKTRA_NS_SYSTEM, .name = <span class="stringliteral">&quot;baz&quot;</span>, .size = 4 }, NULL, NULL)</div>
<div class="line">    NULL</div>
<div class="line">  }</div>
<div class="line">);</div>
</div><!-- fragment --><p>One neat benefit of this solution is that these simple functions can be called from any language.</p>
<h2><a class="anchor" id="autotoc_md1710"></a>
Variadic Arguments</h2>
<div class="fragment"><div class="line">Key * <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (ElektraNamespace ns, ...);</div>
<div class="ttc" id="agroup__key_html_gad23c65b44bf48d773759e1f9a4d43b89"><div class="ttname"><a href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a></div><div class="ttdeci">Key * keyNew(const char *name,...)</div><div class="ttdoc">A practical way to fully create a Key object in one step.</div><div class="ttdef"><b>Definition:</b> key.c:144</div></div>
</div><!-- fragment --><p>This could be called as:</p>
<div class="fragment"><div class="line"><span class="comment">// system:/foo/bar with value 1234 and metadata: meta:/type=long, meta:/length/min=4</span></div>
<div class="line"><a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (ELEKTRA_NS_SYSTEM, <span class="stringliteral">&quot;foo&quot;</span>, <span class="stringliteral">&quot;bar&quot;</span>, NULL, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8ac66e4a49d09212b79f5754ca6db5bd2e">KEY_VALUE</a>, 5, <span class="stringliteral">&quot;1234&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8a040582834bb2d90049947d7ef74e87e2">KEY_META</a>, <span class="stringliteral">&quot;type&quot;</span>, NULL, <span class="stringliteral">&quot;long&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8a040582834bb2d90049947d7ef74e87e2">KEY_META</a>, <span class="stringliteral">&quot;length&quot;</span>, <span class="stringliteral">&quot;min&quot;</span>, NULL, 4, NULL);</div>
<div class="line"><span class="comment">// system:/foo/bar with value 1234 and no metadata</span></div>
<div class="line"><a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (ELEKTRA_NS_SYSTEM, <span class="stringliteral">&quot;foo&quot;</span>, <span class="stringliteral">&quot;bar&quot;</span>, NULL, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8ac66e4a49d09212b79f5754ca6db5bd2e">KEY_VALUE</a>, 5, <span class="stringliteral">&quot;1234&quot;</span>, NULL);</div>
<div class="line"><span class="comment">// system:/foo/bar with no value and no metadata</span></div>
<div class="line"><a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (ELEKTRA_NS_SYSTEM, <span class="stringliteral">&quot;foo&quot;</span>, <span class="stringliteral">&quot;bar&quot;</span>, NULL, NULL);</div>
<div class="ttc" id="agroup__key_html_gga9b703ca49f48b482def322b77d3e6bc8a040582834bb2d90049947d7ef74e87e2"><div class="ttname"><a href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8a040582834bb2d90049947d7ef74e87e2">KEY_META</a></div><div class="ttdeci">@ KEY_META</div><div class="ttdef"><b>Definition:</b> kdbenum.c:92</div></div>
<div class="ttc" id="agroup__key_html_gga9b703ca49f48b482def322b77d3e6bc8ac66e4a49d09212b79f5754ca6db5bd2e"><div class="ttname"><a href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8ac66e4a49d09212b79f5754ca6db5bd2e">KEY_VALUE</a></div><div class="ttdeci">@ KEY_VALUE</div><div class="ttdef"><b>Definition:</b> kdbenum.c:88</div></div>
</div><!-- fragment --><p>Compared to the language agnostic version, this loose type safety and doesn't really provide any advantages. Separating the keyname parts into separate arguments could also be done in the language agnostic version, by using an array <code>const char * parts[]</code> inside the <code>KeyName</code> struct.</p>
<h2><a class="anchor" id="autotoc_md1711"></a>
Macros and Bindings</h2>
<p>Some macros could make the language agnostic version above more ergonomic in C. Bindings in other languages, could also provide wrappers around the <code>keyBuild</code> and <code>ksBuild</code> functions. This could for example, take language-native array types as arguments to avoid passing sizes as separate arguments.</p>
<p>In C this could look like this:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define KS_BUILD(...) (ksBuild (0, (Key *[]){__VA_ARGS__, NULL}))</span></div>
<div class="line"><span class="preprocessor">#define KEY_NAME(ns_, name_) (KeyName){.ns = (ns_), .name = (name_), .size = sizeof (name_)}</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define KEY_VALUE_STRING(s) (KeyValue){.value = (s), .size = strlen((s))}</span></div>
<div class="line"><span class="preprocessor">#define KEY_VALUE_PTR(v) (KeyValue){.value = &amp;(v), .size = sizeof((v))</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define KEY_META_STRING(name_, value_) (KeyMeta){.name = (name_), .nameSize = sizeof (name_), .value = { .value = (value_), .size = strlen(value_) }}</span></div>
</div><!-- fragment --><p>This can be used like so:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> a = 7;</div>
<div class="line"> </div>
<div class="line">KS_BUILD(</div>
<div class="line">  keyBuild (</div>
<div class="line">    &amp;KEY_NAME (ELEKTRA_NS_SYSTEM, <span class="stringliteral">&quot;foo\0bar&quot;</span>),</div>
<div class="line">    &amp;KEY_VALUE_STRING (<span class="stringliteral">&quot;1234&quot;</span>),</div>
<div class="line">    (KeyMeta[]){</div>
<div class="line">      KEY_META_STRING(<span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;long&quot;</span>),</div>
<div class="line">      KEY_META_STRING(<span class="stringliteral">&quot;length\0min&quot;</span>, <span class="stringliteral">&quot;4&quot;</span>),</div>
<div class="line">    }</div>
<div class="line">  ),</div>
<div class="line">  keyBuild (</div>
<div class="line">    &amp;KEY_NAME (ELEKTRA_NS_SYSTEM, <span class="stringliteral">&quot;foo&quot;</span>),</div>
<div class="line">     &amp;KEY_VALUE_PTR(a),</div>
<div class="line">    NULL</div>
<div class="line">  ),</div>
<div class="line">  keyBuild (&amp;KEY_NAME (ELEKTRA_NS_SYSTEM, <span class="stringliteral">&quot;baz&quot;</span>), NULL, NULL)</div>
<div class="line">);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md1712"></a>
Decision</h1>
<h1><a class="anchor" id="autotoc_md1713"></a>
Rationale</h1>
<h1><a class="anchor" id="autotoc_md1714"></a>
Implications</h1>
<ul>
<li></li>
<li></li>
<li></li>
</ul>
<h1><a class="anchor" id="autotoc_md1715"></a>
Related Decisions</h1>
<ul>
<li>[](doc_decisions_0_drafts__README_md)</li>
<li>[](doc_decisions_0_drafts__README_md)</li>
<li>[](doc_decisions_0_drafts__README_md)</li>
</ul>
<h1><a class="anchor" id="autotoc_md1716"></a>
Notes</h1>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
