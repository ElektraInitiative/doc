<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: How to Write a Specification in Elektra for dockerd</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.11.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">How to Write a Specification in Elektra for dockerd </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_tutorials_dockerd_specification"></a> </p>
<h1><a class="anchor" id="autotoc_md4488"></a>
Overview</h1>
<h2><a class="anchor" id="autotoc_md4489"></a>
Introduction</h2>
<p>In this tutorial you will learn how to interactively use the <code>SpecElektra</code> specification language and <code>kdb</code> to write a configuration specification for <a href="https://docs.docker.com/engine/reference/commandline/dockerd/">dockerd</a>.</p>
<h2><a class="anchor" id="autotoc_md4490"></a>
What you should already know</h2>
<ul>
<li>Already know how to write a <a class="el" href="doc_tutorials_specification_md.html">specification</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md4491"></a>
What youâ€™ll learn</h2>
<ul>
<li>how to create and mount a specification using <code>kdb</code></li>
<li>how to add keys with different types, defaults, enums, array specifications, wildcard specifications and examples to your specification and how to validate them</li>
</ul>
<h2><a class="anchor" id="autotoc_md4492"></a>
What you'll do</h2>
<ul>
<li>use <code>kdb</code> to create and mount a specification for <a href="https://docs.docker.com/engine/reference/commandline/dockerd/">dockerd</a></li>
<li>define defaults, array / wildcard specifications, examples and checks for keys in the validation</li>
<li>use the specification as a starting point for customizing the configuration of installed applications</li>
</ul>
<h2><a class="anchor" id="autotoc_md4493"></a>
Scope</h2>
<p>In this tutorial we will introduce a possible specification for <a href="https://docs.docker.com/engine/reference/commandline/dockerd/">dockerd</a>. Using <code>kdb</code> we will configure the specification.</p>
<blockquote class="doxtable">
<p>NOTE: As the specification for dockerd is quite big we will only present a sample for the above mentioned metakeys and link to a full specification <a href="/home/jenkins/workspace/libelektra-release/examples/spec/dockerd.ini">dockerd-full-spec</a>. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md4494"></a>
Getting Started</h1>
<p>Before we start just an overview of the structure:</p>
<ul>
<li>Specification file location: <code>/docker/daemon.json</code></li>
<li>Parent specification key: <code>spec:/sw/dockerd/dockerd/#0/current</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md4495"></a>
Specification Types (values)</h1>
<p><code>Elektra</code> supports multiple types which leads to a more flexible specification. See <a class="el" href="md_src_plugins_type_README.html#src_plugins_type_README_md">type plugin</a> for information about all the types that are supported.</p>
<h1><a class="anchor" id="autotoc_md4496"></a>
Mount Setup</h1>
<p>We will be mounting an existing example <a href="/home/jenkins/workspace/libelektra-release/examples/spec/dockerd.ini">dockerd-spec</a>.</p>
<h2><a class="anchor" id="autotoc_md4497"></a>
Step 1: Mount dockerd specification</h2>
<p>First you need to mount a specification file, in this case <code>dockerd.ini</code> to the <code>spec:/</code> namespace. You can define the path inside the <code>spec:/</code> namespace as <code>/sw/docker/dockerd/#0/current</code>, refer to <a href="https://www.libelektra.org/tutorials/integration-of-your-c-application">the documentation</a> to find out more about constructing the name.</p>
<div class="fragment"><div class="line">sudo kdb mount &quot;$PWD/examples/spec/dockerd.ini&quot; spec:/sw/docker/dockerd/#0/current ni</div>
<div class="line"># RET: 0</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>NOTE: If you encounter any error saying that you have already mounted some specification with the same name you can run <code>sudo kdb umount spec:/sw/docker/dockerd/#0/current</code> and rerun the above command. </p>
</blockquote>
<blockquote class="doxtable">
<p>Note: ni is the format which is used for the specification in the file. You can also choose to use json, then you need use yajl instead of ni. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md4498"></a>
Step 2: Define a mountpoint</h2>
<p>Next you can define, that this specification uses a specific mountpoint for a concrete application configuration. So you can say the concrete configuration should be written to <code>dockerd.ini</code>.</p>
<div class="fragment"><div class="line">kdb meta-set spec:/sw/dockerd/dockerd/#0/current mountpoint /docker/daemon.json</div>
<div class="line"># RET: 0</div>
</div><!-- fragment --><p>Your <code>dockerd.ini</code> file should now contain the <code>mountpoint</code> metakey:</p>
<blockquote class="doxtable">
<p>NOTE: Excerpt of <code>cat $(kdb file spec:/sw/docker/dockerd/#0/current)</code>. </p>
</blockquote>
<div class="fragment"><div class="line"># ;Ni1</div>
<div class="line"># ; Generated by the ni plugin using Elektra (see libelektra.org).</div>
<div class="line"> </div>
<div class="line"># =</div>
<div class="line"> </div>
<div class="line"># []</div>
<div class="line">#  meta:/mountpoint = /dockerd/daemon.json</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md4499"></a>
Step 3: Define &lt;tt&gt;json&lt;/tt&gt; as plugin</h2>
<p>Next we will define that our configuration should be written <code>json</code>.</p>
<p>We can do this by running:</p>
<div class="fragment"><div class="line">kdb meta-set spec:/sw/dockerd/dockerd/#0/current infos/plugin &quot;yajl&quot;</div>
<div class="line"># RET: 0</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md4500"></a>
Step 4: Do a specification mount</h2>
<div class="fragment"><div class="line">sudo kdb spec-mount &quot;/sw/docker/dockerd/#0/current&quot; ni</div>
<div class="line"># RET: 0</div>
</div><!-- fragment --><p>This specification mount makes sure that the paths where the concrete configuration should be (<code>daemon.json</code>) are ready to fulfill our specification (<code>dockerd.ini</code>). Be aware that different files get mounted for different namespaces. You've a specification file (<code>dockerd.ini</code>) for the <code>spec</code>-namespace and three files (<code>daemon.json</code>) on different locations for the <code>dir</code>- <code>user</code>- and <code>system</code>-namespaces.</p>
<p>You can see the files by providing the namespace as prefix to the <code>kdb file</code> command (each shows a different path):</p>
<div class="fragment"><div class="line">kdb file system:/sw/docker/dockerd/#0/current</div>
<div class="line"># /dockerd/daemon.json</div>
</div><!-- fragment --><div class="fragment"><div class="line">kdb file user:/sw/docker/dockerd/#0/current</div>
<div class="line"># STDOUT-REGEX: /dockerd/daemon.json</div>
</div><!-- fragment --><div class="fragment"><div class="line">kdb file dir:/sw/docker/dockerd/#0/current</div>
<div class="line"># STDOUT-REGEX: /dockerd/daemon.json</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>NOTE: The $PWD should equal the PWD where you run <code>sudo kdb mount "$PWD/examples/spec/dockerd.ini" spec:/sw/docker/dockerd/#0/current ni</code>. </p>
</blockquote>
<blockquote class="doxtable">
<p>**_Note_**: The files only exist, when configuration values are stored there, i.e. they are created on the first <code>kdb set</code> and removed with the last <code>kdb rm</code>. </p>
</blockquote>
<p>For more information about namespaces in Elektra please see <a href="https://www.libelektra.org/man-pages/elektra-namespaces">here</a>, a tutorial about the topic is available <a href="https://www.libelektra.org/tutorials/namespaces">here</a>.</p>
<h1><a class="anchor" id="autotoc_md4501"></a>
Writing specification for keys (manually)</h1>
<blockquote class="doxtable">
<p>NOTE: All output we display for <code>cat $(kdb file spec:/sw/docker/dockerd/#0/current)</code> is an excerpt of the whole file output. </p>
</blockquote>
<p>In this example for <code>dockerd</code> we will be using 3 types of specifications:</p>
<ul>
<li>Simple specification (type and description)</li>
<li>Enum specifications (for keys were only a set of possible options can be used)</li>
<li>Array and wildcard specifications (for keys where a list of possible options can be used)</li>
</ul>
<p>As the <code>dockerd</code> specification is big we will just present one of each of the above mentioned specification types.</p>
<blockquote class="doxtable">
<p>NOTE: In Elektra we use <code>/</code> instead of <code>-</code> to seperate key names. This results in a hierarchical structure of key names. This commands will automatically store the specification in the <code>dockerd-daemon.ni</code> specification file. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md4502"></a>
Array specification</h2>
<div class="fragment"><div class="line">[data/root]</div>
<div class="line">meta:/type = string</div>
<div class="line">meta:/description = Root directory of persistent Docker state</div>
<div class="line">meta:/default = /var/lib/docker</div>
</div><!-- fragment --><p>In order to get the above specification we will need the following commands:</p>
<div class="fragment"><div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/data/root type &quot;string&quot;</div>
<div class="line"># RET: 0</div>
<div class="line"> </div>
<div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/data/root description &quot;Root directory of persistent Docker state&quot;</div>
<div class="line"># RET: 0</div>
<div class="line"> </div>
<div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/data/root default &quot;/var/lib/docker&quot;</div>
<div class="line"># RET: 0</div>
</div><!-- fragment --><p>In case no <code>data/root</code> key gets configured the value <code>/var/lib/docker</code> is used.</p>
<p>Let us verify that the metakeys have been set correctly:</p>
<blockquote class="doxtable">
<p>NOTE: Excerpt of <code>cat $(kdb file spec:/sw/docker/dockerd/#0/current)</code>. </p>
</blockquote>
<div class="fragment"><div class="line">cat $(kdb file spec:/sw/docker/dockerd/#0/current)</div>
<div class="line"> </div>
<div class="line"># [data/root]</div>
<div class="line">#  meta:/type = string</div>
<div class="line">#  meta:/description = Root directory of persistent Docker state</div>
<div class="line">#  meta:/default = /var/lib/docker</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md4503"></a>
Enum specification (for keys were only a set of possible options can be used)</h2>
<div class="fragment"><div class="line">[default/cgroupns/mode]</div>
<div class="line">meta:/description = Default mode for containers cgroup namespace</div>
<div class="line">meta:/default = private</div>
<div class="line">meta:/check/enum = #1</div>
<div class="line">meta:/check/enum/#0 = host</div>
<div class="line">meta:/check/enum/#1 = private</div>
</div><!-- fragment --><p>In order to get the above specification we will need the following commands:</p>
<div class="fragment"><div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/default/cgroupns/mode description &quot;Default mode for containers cgroup namespace&quot;</div>
<div class="line"># RET: 0</div>
<div class="line"> </div>
<div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/default/cgroupns/mode default &quot;private&quot;</div>
<div class="line"># RET: 0</div>
<div class="line"> </div>
<div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/default/cgroupns/mode check/enum &quot;#1&quot;</div>
<div class="line"># RET: 0</div>
<div class="line"> </div>
<div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/default/cgroupns/mode check/enum/#0 &quot;host&quot;</div>
<div class="line"># RET: 0</div>
<div class="line"> </div>
<div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/default/cgroupns/mode check/enum/#1 &quot;private&quot;</div>
<div class="line"># RET: 0</div>
</div><!-- fragment --><p>With this configuration we have managed to allow two possible values for <code>default/cgroupns/mode</code>. The values are <code>host</code> and <code>private</code>. The default value if we do not set any configuration is <code>private</code>.</p>
<p>Let us verify that the metakeys have been set correctly:</p>
<blockquote class="doxtable">
<p>NOTE: Excerpt of <code>cat $(kdb file spec:/sw/docker/dockerd/#0/current)</code>. </p>
</blockquote>
<div class="fragment"><div class="line">cat $(kdb file spec:/sw/docker/dockerd/#0/current)</div>
<div class="line"> </div>
<div class="line"># [default/cgroupns/mode]</div>
<div class="line">#  meta:/check/enum/#0 = host</div>
<div class="line">#  meta:/check/enum/#1 = private</div>
<div class="line">#  meta:/description = Default mode for containers cgroup namespace</div>
<div class="line">#  meta:/default = private</div>
<div class="line">#  meta:/check/enum = #1</div>
<div class="line"> </div>
<div class="line"># [data/root]</div>
<div class="line">#  meta:/type = string</div>
<div class="line">#  meta:/description = Root directory of persistent Docker state</div>
<div class="line">#  meta:/default = /var/lib/docker</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md4504"></a>
Wildcard specifications (for keys where a list of possible options can be used)</h2>
<div class="fragment"><div class="line">[default/ulimits/_]</div>
<div class="line">meta:/type = long</div>
<div class="line">meta:/description = Default ulimits for containers</div>
<div class="line">meta:/example = 64000</div>
</div><!-- fragment --><p>For this specification we want to allow an arbitrary number of <code>default ulimits</code>. The name of the <code>ulimits</code> does not matter but all should have the same metakeys.</p>
<p>In order to get the above specification we will need following commands:</p>
<div class="fragment"><div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/default/ulimits/_ type &quot;long&quot;</div>
<div class="line"># RET: 0</div>
<div class="line"> </div>
<div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/default/ulimits/_ description &quot;Default ulimits for containers&quot;</div>
<div class="line"># RET: 0</div>
<div class="line"> </div>
<div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/default/ulimits/_ example &quot;64000&quot;</div>
<div class="line"># RET: 0</div>
</div><!-- fragment --><p>The above specification will allow us to create any name below the <code>default/ulimits</code> key. The value needs to be a string. The sample value is <code>64000</code>.</p>
<p>Let us verify that the metakeys have been set correctly:</p>
<blockquote class="doxtable">
<p>NOTE: Excerpt of <code>cat $(kdb file spec:/sw/docker/dockerd/#0/current)</code>. </p>
</blockquote>
<div class="fragment"><div class="line">cat $(kdb file spec:/sw/docker/dockerd/#0/current)</div>
<div class="line"> </div>
<div class="line"># [default/ulimits/_]</div>
<div class="line">#  meta:/type = long</div>
<div class="line">#  meta:/example = 64000</div>
<div class="line">#  meta:/description = Default ulimits for containers</div>
<div class="line"> </div>
<div class="line"># [default/cgroupns/mode]</div>
<div class="line">#  meta:/check/enum/#0 = host</div>
<div class="line">#  meta:/check/enum/#1 = private</div>
<div class="line">#  meta:/description = Default mode for containers cgroup namespace</div>
<div class="line">#  meta:/default = private</div>
<div class="line">#  meta:/check/enum = #1</div>
<div class="line"> </div>
<div class="line"># [data/root]</div>
<div class="line">#  meta:/type = string</div>
<div class="line">#  meta:/description = Root directory of persistent Docker state</div>
<div class="line">#  meta:/default = /var/lib/docker</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md4505"></a>
Array specifications (for keys where a list of possible options can be used)</h2>
<div class="fragment"><div class="line">[default/address/pools]</div>
<div class="line">meta:/array/min = 0</div>
<div class="line">meta:/description = Default address pools for node specific local networks (list)</div>
<div class="line"> </div>
<div class="line">[default/address/pools/#/base]</div>
<div class="line">meta:/type = string</div>
<div class="line">meta:/description = Ip address (ipv4) + subnet</div>
<div class="line">meta:/example = 172.30.0.0/16</div>
<div class="line"> </div>
<div class="line">[default/address/pools/#/size]</div>
<div class="line">meta:/type = short</div>
<div class="line">meta:/description = Number of ip addresses in this pool with base</div>
<div class="line">meta:/example = 24</div>
</div><!-- fragment --><p>The specification above shows the use of an array specification with the <code>#</code> character. We define the array to have a minimum value of <code>0</code> and arbitrary max length. We use <code>type</code>, <code>description</code> and <code>example</code> as metakeys on the keys beneath each array element.</p>
<p>This configuration above assures that we can configure <code>pools</code> with <code>base</code> and <code>size</code>.</p>
<p>It prevents a configuration like:</p>
<div class="fragment"><div class="line">default/address/pools/#0/size = &quot;test&quot;</div>
</div><!-- fragment --><p>It will fail as <code>default/address/pools/#/size</code> is required to be of type <code>short</code> when set.</p>
<p>In order to get the above specification we will need following commands:</p>
<div class="fragment"><div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/default/address/pools array/min &quot;0&quot;</div>
<div class="line"># RET: 0</div>
<div class="line"> </div>
<div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/default/address/pools description &quot;Default address pools for node specific local networks (list)&quot;</div>
<div class="line"># RET: 0</div>
<div class="line"> </div>
<div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/default/address/pools/#/base type &quot;string&quot;</div>
<div class="line"># RET: 0</div>
<div class="line"> </div>
<div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/default/address/pools/#/base description &quot;Ip address (ipv4) + subnet&quot;</div>
<div class="line"># RET: 0</div>
<div class="line"> </div>
<div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/default/address/pools/#/base example &quot;172.30.0.0/16&quot;</div>
<div class="line"># RET: 0</div>
<div class="line"> </div>
<div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/default/address/pools/#/size type &quot;short&quot;</div>
<div class="line"># RET: 0</div>
<div class="line"> </div>
<div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/default/address/pools/#/size description &quot;Number of ip addresses in this pool with base&quot;</div>
<div class="line"># RET: 0</div>
<div class="line"> </div>
<div class="line">kdb meta-set spec:/sw/docker/dockerd/#0/current/default/address/pools/#/size example &quot;24&quot;</div>
<div class="line"># RET: 0</div>
</div><!-- fragment --><p>The above specification defines that we can create array elements and each can have <code>base</code> or <code>size</code>.</p>
<h1><a class="anchor" id="autotoc_md4506"></a>
Final specification code</h1>
<p>Your specification should be complete now! After adding all the keys that are necessary for our application, you can verify that all specification keys are contained by running:</p>
<div class="fragment"><div class="line">cat $(kdb file spec:/sw/docker/dockerd/#0/current)</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>NOTE: We want display the output because it is too long to display (~ 400-500 lines). </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md4507"></a>
Adding full example specification (with kdb import)</h1>
<p>The above tutorial has given a good overview of how to write a specification. You might want to add a full example specification for <code>dockerd</code> using <code>kdb import</code>. To do so, follow the next steps.</p>
<p>To make sure we don't run into errors we will clean up everything we have done by now.</p>
<ol type="1">
<li><code>sudo kdb rm -r spec:/sw/docker/dockerd/#0/current</code></li>
<li><code>sudo kdb umount spec:/sw/docker/dockerd/#0/current</code></li>
<li><code>rm -rf $PWD/dockerd</code> (make sure that you are in the same PWD as when you run the <code>sudo kdb mount</code>)</li>
</ol>
<p>Now we are going to add an example of <a href="/home/jenkins/workspace/libelektra-release/examples/spec/dockerd.ini">dockerd-full-spec</a>.</p>
<p>Make sure you are in the root of the cloned <code>libelektra</code> repository:</p>
<ol type="1">
<li><code>sudo kdb mount "$PWD/dockerd/dockerd-daemon.ni" spec:/sw/docker/dockerd/#0/current ni</code></li>
<li><code>kdb meta-set spec:/sw/dockerd/dockerd/#0/current mountpoint /dockerd/daemon.ni</code></li>
<li><code>kdb meta-set spec:/sw/dockerd/dockerd/#0/current infos/plugin "yajl"</code></li>
<li><code>sudo kdb spec-mount "/sw/docker/dockerd/#0/current"</code></li>
<li><code>sudo kdb import spec:/sw/docker/dockerd/#0/current ni &lt; ./examples/spec/dockerd.ini</code></li>
</ol>
<p>To verify that everything was created successfully, run:</p>
<div class="fragment"><div class="line">cat $(kdb file spec:/sw/docker/dockerd/#0/current)</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>NOTE: We want display the output because it is too long to display (~ 400-500 lines). </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md4508"></a>
Appendix (full specification)</h1>
<p>The full specification can be viewed at <a href="/home/jenkins/workspace/libelektra-release/examples/spec/dockerd.ini">dockerd-full-spec</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
