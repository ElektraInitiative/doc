<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Plugin: spec</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Elektra
   &#160;<span id="projectnumber">0.9.4</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Plugin: spec </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>infos = Information about the spec plugin is in keys below</li>
<li>infos/author = Thomas Waser <a href="#" onclick="location.href='mai'+'lto:'+'tho'+'ma'+'s.w'+'as'+'er@'+'li'+'bel'+'ek'+'tra'+'.o'+'rg'; return false;">thoma<span style="display: none;">.nosp@m.</span>s.wa<span style="display: none;">.nosp@m.</span>ser@l<span style="display: none;">.nosp@m.</span>ibel<span style="display: none;">.nosp@m.</span>ektra<span style="display: none;">.nosp@m.</span>.org</a>, Klemens BÃ¶swirth <a href="#" onclick="location.href='mai'+'lto:'+'k.b'+'oe'+'swi'+'rt'+'h+g'+'it'+'@gm'+'ai'+'l.c'+'om'; return false;">k.boe<span style="display: none;">.nosp@m.</span>swir<span style="display: none;">.nosp@m.</span>th+gi<span style="display: none;">.nosp@m.</span>t@gm<span style="display: none;">.nosp@m.</span>ail.c<span style="display: none;">.nosp@m.</span>om</a></li>
<li>infos/licence = BSD</li>
<li>infos/needs =</li>
<li>infos/provides = check apply</li>
<li>infos/placements = postgetstorage presetstorage</li>
<li>infos/status = recommended productive nodep configurable global unfinished</li>
<li>infos/description = allows to give specifications for keys</li>
</ul>
<p>The spec plugin is a global plugin that copies metadata from the <code>spec</code>-namespace to other namespaces using their key names as globbing expressions. Globbing resembles regular expressions. They do not have the same expressive power, but are easier to use. The semantics are more suitable to match path names:</p>
<ul>
<li><code>*</code> matches any key name of just one hierarchy. This means it complies with any character except slash or null.</li>
<li><code>?</code> satisfies single characters with the same exclusion.</li>
<li><code>#</code> matches Elektra array elements. (e.g. <code>#0</code>, <code>#_10</code>, <code>#__987</code>)</li>
<li><code>_</code> matches anything that <code>*</code> matches, except array elements.</li>
<li>Additionally, there are ranges and character classes. They can also be inverted. For more infos take a look at the code documentation of <code><a class="el" href="globbing_8c.html#ad7700821df72fc0fc3bfc336e4368d29" title="checks whether a given Key matches a given globbing pattern ">elektraKeyGlob()</a></code>.</li>
</ul>
<p>The plugin copies the metadata of the corresponding <code>spec</code> key to every matching (see below) key in the other namespaces. The copied metadata is removed again during <code>kdbSet</code> (if remained unchanged).</p>
<p>The spec plugin also provides basic validation and structural checking. Specifically it supports:</p>
<ul>
<li>detection of invalid array key names</li>
<li>detection of missing keys</li>
<li>validation of array ranges (min/max array size)</li>
<li>validating the number of subkeys of <code>_</code></li>
</ul>
<p>The matching of the spec (globbing) keys to the keys in the other namespaces is based on <code><a class="el" href="globbing_8c.html#ad7700821df72fc0fc3bfc336e4368d29" title="checks whether a given Key matches a given globbing pattern ">elektraKeyGlob()</a></code>, which in turn is based on the well known <code>fnmatch(3)</code>. However, there is special handling for array specifications (<code>#</code>) and wildcard specifications (<code>_</code>).</p>
<p>Keys which contain a part that is exactly <code>#</code> (e.g. <code>my/#/key</code> or <code>my/#</code>) are called array specifications. Instead of just matching the spec key to any existing keys in other namespaces, theses keys are "instantiated". This means we lookup the array size (defined by the <code>array</code> metakey) using a cascading <code>ksLookup</code>. This only looks at non-spec namespaces, if we don't find an array size their, we check the array parent in the spec namespace. If we still have no array size, the array is deemed to be empty. For empty arrays, we will simply validate that they are indeed empty.</p>
<p>For non-empty arrays "instantiation" takes place. This means that we replace each <code>#</code> part in the spec key by all the valid array elements for this specification, up to the array size (which was already checked to be less than the allowed maximum). In other words, instead of actually matching the globbing expression, we create a separate but identical specification for all valid array elements.</p>
<p>The purpose of "instantiation" is to allow specifying <code>default</code> values for array elements.</p>
<p>Keys which contain a part that is exactly <code>_</code> (e.g. <code>my/_/key</code> or <code>my/_</code>) are called wildcard specifications. It would be nice to have an "instantiation" procedure for <code>_</code> similar to the one for arrays. However, this is not possible with the current implementation, since there is no way of knowing in advance, which keys matching the globbing expression may be requested via <code>ksLookup</code>.</p>
<p>Instead <code>_</code> is simply treated like <code>*</code> during matching. Afterwards we check that no array elements were matched.</p>
<p>The basic functionality of the plugin is to just copy (using <code><a class="el" href="group__keymeta.html#ga9a22b992478e613c8788bd460b4a1f0c" title="Do a shallow copy of metadata from source to dest. ">keyCopyMeta()</a></code> so we don't waste memory) the metadata of spec keys to all matching (as described above) keys in other namespaces. This ensures that other plugins can do their work as expected, without manually setting metadata on every key. If any metakey we want to copy already exists on the target key (with a different value), this causes a <code>collision</code> conflict.</p>
<p>In addition to the basic functionality, the plugin does some validation itself.</p>
<p>If a spec key has the metakey <code>default</code> set and the key does not exist in other namespaces, we create a special (cascading) key that will be found by <code>ksLookup</code>. This key has the <code>default</code> value as its value. We also copy over metadata as always.</p>
<p>A similar procedure takes place for <code>assign/condition</code>, but in this case, we don't set the value of the key. We only create it and copy metadata.</p>
<p>If a spec key has the metakey <code>require</code> (the value of this metakey is irrelevant and ignored), we ensure that this key exists in at least one other namespace, i.e. it can be found using a cascading <code>ksLookup</code>. If the key cannot be found, this causes a <code>missing</code> conflict.</p>
<p>As hinted to above, we validate array sizes. If a spec key <code>x/#</code> is given, and the spec key <code>x</code> has the metakey <code>array/min</code> or <code>array/max</code> set, we validate the array size (given as metakey <code>array</code> on <code>x</code>) is within the limits of <code>array/min</code> and <code>array/max</code>. Both <code>array/min</code> and <code>array/max</code> have to be valid array-elements similar to <code>array</code>. If the array size is out of bounds, this causes a <code>range</code> conflict.</p>
<p>We also check that the array only contains actual array elements. If this not the case, this causes a <code>member</code> conflict.</p>
<p>Note: We don't actually validate that the array doesn't contain elements above the given array size. This is because it doesn't have anything to do with the specification, whether the array contains additional elements. Note also that we only copy metadata onto elements within the bounds of the array size.</p>
<p>There are various ways in which a conflict can occur during the validation process. To handle these conflicts, we provide various configuration options.</p>
<p>The possible conflicts are:</p>
<ul>
<li>Invalid array <code>member</code>: an invalid array key has been detected. e.g. <code>/#abc</code>, or <code>/x</code> (i.e. non-array-element) if array (<code>#</code>) was specified</li>
<li>Out of <code>range</code>: the array has more or less elements than specified by the <code>array/min</code> and <code>array/max</code> metakeys.</li>
<li>Missing keys <code>missing</code>: the key marked as <code>require</code>d wasn't found.</li>
<li>Invalid keys <code>invalid</code>: the specification or a key was invalid</li>
<li>Conflicting metadata <code>collision</code>: the metakey that's supposed to be added already exists.</li>
</ul>
<p>To define what actions should be taken on on conflicts during <code>kdbGet</code> and <code>kdbSet</code> respectively use the keys <code>conflict/set</code> and <code>conflict/get</code> in the plugin configuration.</p>
<p>This base configuration can be overridden on a per-conflict basis to provide more granularity. The keys for this are (replace <code>_</code> with <code>get</code> or <code>set</code> accordingly):</p>
<div class="fragment"><div class="line">conflict/_/member</div><div class="line">conflict/_/range</div><div class="line">conflict/_/missing</div><div class="line">conflict/_/invalid</div><div class="line">conflict/_/collision</div></div><!-- fragment --><p>For even more granularity, the above per-conflict metakeys can also be specified on individual keys.</p>
<p>The allowed values for the conflict keys are always the same:</p>
<ul>
<li><code>ERROR</code> yields an error when a conflict occurs</li>
<li><code>WARNING</code> adds a warning when a conflict occurs</li>
<li><code>INFO</code> adds a metakey <code>logs/spec/info</code> to the parent-key which can be used by logging plugins. <code>logs/spec/info</code> is an array, each element is one conflict.</li>
<li>any other value ignores the conflict, this includes if the conflict key is not given (i.e. the default)</li>
</ul>
<p>There is also the special key <code>missing/log</code>. If it is set to <code>1</code>, the plugin will create the meta array <code>logs/spec/missing/#</code>. This array will contain a list of the missing keys. The key <code>missing/log</code> can only be part of the main plugin configuration, not individual keys' metakeys. It also applies to <code>kdbGet</code> and <code>kdbSet</code> calls.</p>
<p>Ini files can be found in /examples/spec which should be PWD so that the example works:</p>
<div class="fragment"><div class="line">cd ~e/examples/spec</div><div class="line">kdb global-mount        # mounts spec plugin by default</div><div class="line">kdb mount $PWD/spec.ini spec ni</div><div class="line">kdb mount $PWD/spectest.ini /testkey ni</div><div class="line">kdb export /testkey ni     # note: spec can only applied on cascading access</div></div><!-- fragment --><p>With spec mount one can use (in this case battery.ini needs to be installed in <code>kdb file spec:/</code> (this should be preferred on non-development machines so that everything still works after the source is removed):</p>
<div class="fragment"><div class="line">cp battery.ini $(dirname $(kdb file spec:/))</div><div class="line">kdb mount battery.ini spec:/example/battery ni</div><div class="line">kdb spec-mount /example/battery</div><div class="line">kdb meta-ls /example/battery/level    # we see it has a check/enum</div><div class="line">kdb meta-get /example/battery/level check/enum    # now we know allowed values</div><div class="line">kdb set /example/battery/level low   # success, low is ok!</div><div class="line">kdb set /example/battery/level x     # fails, not one of the allowed values!</div><div class="line"></div><div class="line">cp openicc.ini $(dirname $(kdb file spec:/))</div><div class="line">kdb mount openicc.ini spec:/freedesktop/openicc ni</div><div class="line">kdb spec-mount /freedesktop/openicc</div><div class="line"></div><div class="line">kdb ls /freedesktop/openicc # lets see the whole configuration</div><div class="line">kdb export spec:/freedesktop/openicc ni   # give us details about the specification</div><div class="line">kdb meta-ls /freedesktop/openicc/device/camera/#0/EXIF_serial   # seems like there is a check/type</div><div class="line">kdb set &quot;/freedesktop/openicc/device/camera/#0/EXIF_serial&quot; 203     # success, is a long</div><div class="line">kdb set &quot;/freedesktop/openicc/device/camera/#0/EXIF_serial&quot; x   # fails, not a long</div></div><!-- fragment --><ul>
<li>Added metadata is not correctly removed during <code>kdbSet</code>, if the corresponding spec key was modified.</li>
<li>Default values do not work if globbing is involved.</li>
<li>By default, keys tagged with <code>require</code> do not emit errors even if not present (<a href="https://issues.libelektra.org/1024">https://issues.libelektra.org/1024</a>) </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
