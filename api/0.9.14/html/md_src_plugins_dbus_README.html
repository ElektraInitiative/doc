<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Plugin: dbus</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.9.14</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Plugin: dbus </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>infos = Information about the dbus plugin is in keys below</li>
<li>infos/author = Markus Raab <a href="#" onclick="location.href='mai'+'lto:'+'ele'+'kt'+'ra@'+'li'+'bel'+'ek'+'tra'+'.o'+'rg'; return false;">elekt<span style="display: none;">.nosp@m.</span>ra@l<span style="display: none;">.nosp@m.</span>ibele<span style="display: none;">.nosp@m.</span>ktra<span style="display: none;">.nosp@m.</span>.org</a></li>
<li>infos/maintainer = Maximilian Irlinger <a href="#" onclick="location.href='mai'+'lto:'+'max'+'@m'+'axi'+'rl'+'ing'+'er'+'.at'; return false;">max@m<span style="display: none;">.nosp@m.</span>axir<span style="display: none;">.nosp@m.</span>linge<span style="display: none;">.nosp@m.</span>r.at</a></li>
<li>infos/licence = BSD</li>
<li>infos/provides = notification</li>
<li>infos/needs =</li>
<li>infos/recommends =</li>
<li>infos/placements = postgetstorage postcommit</li>
<li>infos/status = maintained unittest libc global</li>
<li>infos/description = Sends notifications for every change via D-Bus</li>
</ul>
<h1><a class="anchor" id="src_plugins_dbus_README_md"></a>
Introduction</h1>
<p>This plugin is a notification plugin, which sends a signal to D-Bus when the key database (KDB) has been modified.</p>
<h1><a class="anchor" id="autotoc_md149"></a>
Installation</h1>
<p>See <a class="el" href="doc_INSTALL_md.html">installation</a>. The package is called <code>libelektra5-dbus</code>.</p>
<h1><a class="anchor" id="autotoc_md150"></a>
Dependencies</h1>
<ul>
<li><code>libdbus-1-dev</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md151"></a>
Dbus</h1>
<p>A preferred way to interconnect desktop applications and even embedded system applications on mobile devices running Linux is D-Bus. The idea of D-Bus accords to that of Elektra: to provide standards to let software work together more tightly. D-Bus provides a simple and lightweight IPC (Inter-Process Communication) system to be used within desktop systems. Next to RPC (Remote Procedure Call), which is not used in this plugin, it supports signals which can notify an arbitrary number of other applications about changes. Given software like a D-Bus library, notification itself is a rather easy task, but it involves additional library dependences. So it is the perfect task to be implemented as a plugin. The information about the channels to be used can be stored in the global key database.</p>
<p>D-Bus supports a <b>system-wide bus</b> and a <b>session bus</b>. The system configuration can be accessed by each user and the user configuration is limited to a single user. Both buses can immediately be used for the system and user configuration notification updates to get pleasing results. But, there is a problem with the session bus: It is possible within D-Bus that a user starts several sessions. The user configuration should be global to the user and is not aware of these sessions. So if several sessions are started, some of the user's processes will miss notification updates.</p>
<p>The namespaces are mapped to the buses the following way:</p>
<ul>
<li>system: system-wide bus</li>
<li>user: session bus</li>
</ul>
<p>Following signal names are used to notify about changes in the Elektraâ€™s KeySet:</p>
<ul>
<li>KeyAdded: a key has been added</li>
<li>KeyChanged: a key has been changed</li>
<li>KeyDeleted: a key has been deleted</li>
</ul>
<p>Alternatively, (with the option announce=once) only a single message is send:</p>
<ul>
<li>Commit: a key has been added, changed or deleted</li>
</ul>
<h1><a class="anchor" id="autotoc_md152"></a>
Usage</h1>
<p>The recommended way is to globally mount the plugin:</p>
<div class="fragment"><div class="line">kdb global-mount dbus</div>
</div><!-- fragment --><p>Alternatively one can mount the plugin additionally to a storage plugin, e.g.:</p>
<div class="fragment"><div class="line">kdb mount file.dump / dump dbus</div>
</div><!-- fragment --><p>For openicc one would use (mounts with announce=once):</p>
<div class="fragment"><div class="line">kdb mount-openicc</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md153"></a>
Shell</h2>
<p>Then we can receive the notification events using:</p>
<div class="fragment"><div class="line">dbus-monitor type=&#39;signal&#39;,interface=&#39;org.libelektra&#39;,path=&#39;/org/libelektra/configuration&#39;</div>
</div><!-- fragment --><p>Or via the supplied test program:</p>
<div class="fragment"><div class="line">kdb testmod_dbus receive_session</div>
</div><!-- fragment --><p>We can trigger a message with:</p>
<div class="fragment"><div class="line">kdb set user:/dbus/x b</div>
</div><!-- fragment --><p>Note that changes in <code>user</code> fire on the dbus <code>session</code>, and changes in namespace <code>system</code> in the dbus <code>system</code> bus. To receive <code>system</code> changes we will use:</p>
<div class="fragment"><div class="line">kdb testmod_dbus receive_system</div>
<div class="line">dbus-monitor --system type=&#39;signal&#39;,interface=&#39;org.libelektra&#39;,path=&#39;/org/libelektra/configuration&#39;</div>
</div><!-- fragment --><p>And then fire it with:</p>
<div class="fragment"><div class="line">kdb set system:/dbus/y a</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md154"></a>
C</h2>
<div class="fragment"><div class="line">dbus_bus_add_match (connection, <span class="stringliteral">&quot;type=&#39;signal&#39;,interface=&#39;org.libelektra&#39;,path=&#39;/org/libelektra/configuration&#39;&quot;</span>, &amp;error);</div>
</div><!-- fragment --><p>See the full example <a href="/home/jenkins/workspace/libelektra-release/src/plugins/dbus/receivemessage.c">here</a>.</p>
<h2><a class="anchor" id="autotoc_md155"></a>
Qt</h2>
<p>Here a small example for QDBusConnection:</p>
<p>Place this in your Qt class header:</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> slots:</div>
<div class="line">  <span class="keywordtype">void</span> configChanged( QString msg );</div>
</div><!-- fragment --><p>Put this in your Qt class, e.g. the constructor:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span>( QDBusConnection::sessionBus().connect( QString(), <span class="stringliteral">&quot;/org/libelektra/configuration&quot;</span>, <span class="stringliteral">&quot;org.libelektra&quot;</span>, QString(),</div>
<div class="line">                                       <span class="keyword">this</span>, SLOT( configChanged( QString ) )) )</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;=================== Done connect\n&quot;</span> );</div>
</div><!-- fragment --><p>Here comes the <a class="el" href="namespaceorg_1_1libelektra.html" title="JNA based proxy for native libelektra.">org.libelektra</a> signals:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> SynnefoApp::configChanged( QString msg )</div>
<div class="line">{</div>
<div class="line">  fprintf( stdout, <span class="stringliteral">&quot;config changed: %s\n&quot;</span>, msg.toLocal8Bit().data() );</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md156"></a>
Python</h2>
<p>In Python the DBus notifications can be used as follows</p>
<div class="fragment"><div class="line">import dbus</div>
<div class="line">import gobject</div>
<div class="line">gobject.threads_init()  # important: initialize threads if gobject main loop is used</div>
<div class="line">from dbus.mainloop.glib import DBusGMainLoop</div>
<div class="line"> </div>
<div class="line">class DBusTest():</div>
<div class="line">    def __init__(self):</div>
<div class="line">        DBusGMainLoop(set_as_default=True)</div>
<div class="line">        bus = dbus.SystemBus()  # may use session bus for user db</div>
<div class="line">        bus.add_signal_receiver(self.elektra_dbus_key_changed_cb,</div>
<div class="line">            signal_name=&quot;KeyChanged&quot;,</div>
<div class="line">            dbus_interface=&quot;org.libelektra&quot;,</div>
<div class="line">            path=&quot;/org/libelektra/configuration&quot;)</div>
<div class="line"> </div>
<div class="line">    def elektra_dbus_key_changed_cb(self, key):</div>
<div class="line">        print(&#39;key changed %s&#39; % key)</div>
<div class="line"> </div>
<div class="line">test = DBusTest()</div>
<div class="line">loop = gobject.MainLoop()</div>
<div class="line">try:</div>
<div class="line">    loop.run()</div>
<div class="line">except KeyboardInterrupt:</div>
<div class="line">    loop.quit()</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md157"></a>
Background</h1>
<p>Today, programs are often interconnected in a dense way. Such applications should always be informed when something in their environment changes. For user interactive software, notification about configuration changes is expected. The only alternative is polling, which wastes resources. It additionally is no option for interactive software, where the latency needs to be low. Instead, the software which changes the configuration has to notify all other interested applications that can reread their configuration without significant delay. In Elektra, a notification plugin ensures that a notification is actually sent on each change.</p>
<p>Applications can wait for such a notification with hand-written code. Bindings, however, allow for better integration. It is a common approach for toolkits to provide a main loop. Applications using such toolkits can integrate notification services into this main loop.</p>
<p>The actions that occur in such events are application or toolkit specific because of the non-invasive nature of Elektra. Software reacts in many different ways to update events. Hence, the frequency of update events should be kept at a minimum. Changes are kept atomic with a single attempt to write out configuration. Notification callbacks shall not change configuration because this can lead to a longer chain of unwanted modifications. That might not be true, however, if a programmer of the whole system knows that a chain of reactions will terminate. When doing such event-driven programming, care is needed to avoid infinite loops. Elektra guarantees consistency of the key database even in such cases.</p>
<h1><a class="anchor" id="autotoc_md158"></a>
Transport Plugin</h1>
<p>Mount this plugin globally with default settings to use it as <em>sending</em> transport plugin for Elektra's notification feature:</p>
<blockquote class="doxtable">
<p>kdb global-mount dbus announce=once </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md159"></a>
Notification Format</h1>
<p>This plugin uses D-Bus signal messages as notifications. Notifications have the path <code>/org/libelektra/configuration</code> and the D-Bus interface <code><a class="el" href="namespaceorg_1_1libelektra.html" title="JNA based proxy for native libelektra.">org.libelektra</a></code>. The following signal names are used:</p>
<ul>
<li>Commit: preferred, keys below the changed key have changed</li>
<li>KeyAdded: a key has been added</li>
<li>KeyChanged: a key has been changed</li>
</ul>
<p>The first argument contains the name of the changed key. The system bus is used if the affected keys is below the <code>system</code> namespace. If the key is below the <code>user</code> namespace the session bus is used.</p>
<p>Example output from <code>dbus-monitor</code>:</p>
<div class="fragment"><div class="line">signal time=1520805003.227723 sender=:1.8 -&gt; destination=(null destination) serial=15 path=/org/libelektra/configuration; interface=org.libelektra; member=Commit</div>
<div class="line">   string &quot;system:/tests/foo&quot;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md160"></a>
Problems</h2>
<p>Key names that are not valid utf-8 cause a warning within the D-Bus library:</p>
<div class="fragment"><div class="line">This is normally a bug in some application using the D-Bus library.</div>
<div class="line">Couldn&#39;t add message argumentprocess 6139: arguments to dbus_message_iter_append_basic() were incorrect, assertion &quot;_dbus_check_is_valid_utf8 (*string_p)&quot; failed in file ../../dbus/dbus-message.c line 2676.</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
