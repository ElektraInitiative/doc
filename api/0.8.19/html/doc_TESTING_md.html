<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>Elektra: Testing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Elektra
   &#160;<span id="projectnumber">0.8.19</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Testing </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Introduction</h2>
<p>Libraries need a pervasive testing for continuous improvement. Any problem found and behaviour described must be written down as test and integrated so that after running all tests in the build directory: </p><pre class="fragment">make run_all
</pre><p>and on the target (installed) system: </p><pre class="fragment">kdb run_all
</pre><p>it is assured that no new regressions were added. To run memcheck tests run in the build directory: </p><pre class="fragment">make run_memcheck
</pre><p>For tests in the build directory ctest is used, so you alternatively also can call ctest with its options. On the target (installed) system our own scripts drive the tests.</p>
<p>Some tests write into system paths. If the access is denied, several tests will fail. You have some options to avoid running them as root:</p>
<ol type="1">
<li>To void running the problematic test cases (reduces the test coverage!) run ctest without tests that have the label <code>kdbtests</code>: <code>ctest --output-on-failure -LE kdbtests</code></li>
<li>To give your user the permissions to the relevant paths, i.e. (once as root): ``` kdb mount-info chown -R <code>whoami</code> <code>kdb get system/info/constants/cmake/CMAKE_INSTALL_PREFIX</code>/<code>kdb get system/info/constants/cmake/KDB_DB_SPEC</code> chown -R <code>whoami</code> <code>kdb get system/info/constants/cmake/KDB_DB_SYSTEM</code> ``` After that all test cases should run successfully as described above.</li>
<li>Compile Elektra so that system paths are not actual system paths, e.g. to write everything into the home directory (<code>~</code>) use cmake options: <code>-DKDB_DB_SYSTEM="~/.config/kdb/system" -DKDB_DB_SPEC="~/.config/kdb/spec"</code> (for another example with ini see <code>scripts/configure-home</code>)</li>
<li>Use the XDG resolver (see <code>scripts/configure-xdg</code>) and set the environment variable <code>XDG_CONFIG_DIRS</code>, currently lacks spec namespaces, see #734.</li>
</ol>
<h2>Conventions</h2>
<ul>
<li>All names of the test must start with test (needed by test driver for installed tests).</li>
<li>No tests should run if ENABLE_TESTING is OFF.</li>
<li>All tests that access system/spec namespaces (e.g. mount something):<ul>
<li>should be tagged with kdbtests: <pre class="fragment"> set_property(TEST testname PROPERTY LABELS kdbtests)
</pre></li>
<li>should not run, if <code>ENABLE_KDB_TESTING</code> is OFF.</li>
<li>should only write below<ul>
<li><code>/tests/&lt;testname&gt;</code> (e.g. <code>/tests/ruby</code>) and</li>
<li><code>system/elektra</code> (e.g. for mounts or globalplugins).</li>
</ul>
</li>
</ul>
</li>
<li><p class="startli">If your test has memleaks, e.g. because the library used leaks and that cannot be fixed, give them the label memleak with following command:</p>
<p class="startli">set_property(TEST testname PROPERTY LABELS memleak)</p>
</li>
</ul>
<h2>Strategy</h2>
<p>The testing must happen on every level of the software to achieve a maximum coverage with the available time. In the rest of the document we describe the different levels and where these tests are.</p>
<h3>CFramework</h3>
<p>This is basically a bunch of assertion macros and some output facilities. It is written in pure C and very lightweight.</p>
<p>It is located here.</p>
<h3>ABI Tests</h3>
<p>C ABI Tests are written in plain C with the help of cframework.</p>
<p>The main purpose of these tests are, that the binaries of old versions can be used against new versions as ABI tests.</p>
<p>So lets say we compile Elektra 0.8.8 (at this version dedicated ABI tests were introduced) in the <code>-full</code> variant. But when we run the tests, we use <code>libelektra-full.so.0.8.9</code> (either by installing it or by setting <code>LD_LIBRARY_PATH</code>). You can check with ldd which version is used.</p>
<p>The tests are located here.</p>
<h3>C Unit Tests</h3>
<p>C Unit Tests are written in plain C with the help of cframework.</p>
<p>It is used to test internal data structures of libelektra that are not ABI relevant.</p>
<p>ABI tests can be done on theses tests, too. But by nature from time to time these tests will fail.</p>
<p>They are located here.</p>
<h4>Internal Functions</h4>
<p>According to <code>src/libs/elektra/libelektra-symbols.map</code>, all functions starting with:</p>
<ul>
<li>libelektra</li>
<li>elektra</li>
<li>kdb</li>
<li>key</li>
<li>ks</li>
</ul>
<p>get exported. Functions not starting with this prefix are internal only and therefore not visible in the test cases. Test internal functionality by including the corresponding c file.</p>
<h3>Module Tests</h3>
<p>The modules, which are typically used as plugins in Elektra (but can also be available statically or in the <code>-full</code> variant), should have their own tests.</p>
<p>Use the Cmake macro <code>add_plugintest</code> for adding these tests.</p>
<h3>C++ Unit Tests</h3>
<p>C++ Unit tests are done using the gtest framework. See <a class="el" href="doc_decisions_unit_testing_md.html">architectural decision</a>.</p>
<p>Use the CMake macro <code>add_gtest</code> for adding these tests.</p>
<h3>Script Tests</h3>
<p>Script test are done using POSIX shell + CMake. See <a class="el" href="doc_decisions_script_testing_md.html">architectural decision</a>.</p>
<p>The script tests have different purposes:</p><ul>
<li>End to End tests (usage of tools as a user would do)</li>
<li>External Compilation tests (compile and run programs as a user would do)</li>
<li>Conventions tests (do internal checks that check for common problems)</li>
<li>Meta Test Suites (run other test suites)</li>
</ul>
<h3>Fuzz Testing</h3>
<p>Copy some import files to testcase_dir and run: </p><pre class="fragment">/usr/src/afl/afl-1.46b/./afl-fuzz -i testcase_dir -o findings_dir bin/kdb import user/tests
</pre><h3>ASAN</h3>
<p>To enable sanitize checks use <code>ENABLE_ASAN</code> via cmake.</p>
<p>Then, to use ASAN, run <code>run_asan</code> in the build directory, which simply does: </p><pre class="fragment">    ASAN_OPTIONS=symbolize=1 ASAN_SYMBOLIZER_PATH=$(shell which llvm-symbolizer) make run_all
</pre><p>It could also happen that you need to preload ASAN library, e.g.: </p><pre class="fragment">    LD_PRELOAD=/usr/lib/clang/3.8.0/lib/linux/libclang_rt.asan-x86_64.so run_asan
</pre><p>or on Debian: </p><pre class="fragment">    LD_PRELOAD=/usr/lib/llvm-3.8/lib/clang/3.8.1/lib/linux/libclang_rt.asan-x86_64.so run_asan
</pre><p>See also build server jobs:</p>
<ul>
<li><a href="http://build.libelektra.org:8080/job/elektra-clang-asan/">clang-asan</a></li>
<li><a href="http://build.libelektra.org:8080/job/elektra-gcc-asan/">gcc-asan</a></li>
</ul>
<h3>cbmc</h3>
<p>For bounded model checking tests, see <code>scripts/cbmc</code>.</p>
<h3>Code Coverage</h3>
<p>Run: </p><pre class="fragment">    make coverage-start
    # now run all tests! E.g.:
    make run_all
    make coverage-stop
    make coverage-genhtml
</pre><p>The htmls can be found in the build directory in the folder <code>coverage</code>.</p>
<p>See also the build server job:</p>
<ul>
<li><a href="http://build.libelektra.org:8080/job/elektra-incremental/">gcc-asan</a></li>
</ul>
<h2>See also</h2>
<ul>
<li><a class="el" href="doc_COMPILE_md.html">COMPILE</a>.</li>
<li><a class="el" href="doc_INSTALL_md.html">INSTALL</a>. </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
