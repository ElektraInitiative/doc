<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Buildserver</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Elektra
   &#160;<span id="projectnumber">0.8.24</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Buildserver </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <a href="https://build.libelektra.org/">Elektra buildserver</a> handles a variety of tasks that reaches from testing Pull Requests (PRs) to deploying new versions of the Elektra homepage.</p>
<h2>Legacy build jobs</h2>
<p>Build jobs that are not ported into Jenkinsfiles use <code>Github Pull Request Builder</code> to trigger builds on PR's.</p>
<p>If you are not yet authorized, the following question will be asked (by user ): </p><pre class="fragment">Can one of the admins verify if this patch should be build?
</pre><p>Then one of the admins (sorted by activity):</p>
<ul>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
</ul>
<p>need to confirm by saying: </p><pre class="fragment">.*add\W+to\W+whitelist.*
</pre><p>or if just the pull request should be checked: </p><pre class="fragment">.*build\W+allow.*
</pre><p>Afterwards builds can be issued via commands as described in <code>TRIGGERS</code> below.</p>
<h2>Jenkinsfiles</h2>
<p>Jenkinsfiles describe what actions the build system should execute on what build slave. Currently Elektra uses two different files.</p>
<h3>Jenkinsfile.daily</h3>
<ul>
<li>Jenkinsfile.daily is for daily maintanence tasks, like cleaning up build servers.</li>
<li><a href="https://build.libelektra.org/jenkins/job/libelektra-daily/">Buildjob: libelektra-daily</a></li>
<li><a href="https://master.libelektra.org/scripts/jenkins/Jenkinsfile.daily">Jenkinsfile.daily</a></li>
</ul>
<h3>Jenkinsfile</h3>
<ul>
<li>Triggered on code changes and is for testing changes to the codebase.</li>
<li><a href="https://build.libelektra.org/jenkins/job/libelektra/">Buildjob: libelektra</a></li>
<li><a href="https://master.libelektra.org/scripts/jenkins/Jenkinsfile">Jenkinsfile</a></li>
</ul>
<h3>DSL</h3>
<p>The language used is a groovy based DSL described in the <a href="https://jenkins.io/doc/book/pipeline/jenkinsfile/">Jenkinsfile book</a>. Most groovy syntax is allowed to describe pipelines in a Jenkinsfile, but it is executed in a sandbox which might block certain calls.</p>
<p>Since plugins might extend the pool of available commands or variables a full list of currently available syntax can be seen in <a href="https://build.libelektra.org/jenkins/job/libelektra/pipeline-syntax/">pipeline syntax</a> after a login to the build server.</p>
<h2>Security</h2>
<p>Since a malicious PR could easily destroy the build server and slaves or expose credentials some restrictions are introduced. Only PR authors that have the right to push to libelektra can modify the Jenkinsfile and have those changes be respected for the respective branch.</p>
<p>This setting can be modified on the respective build job configuration site.</p>
<h2>Triggers</h2>
<p>All Triggers are described in the configuration of the respective build jobs.</p>
<p>The <a href="https://build.libelektra.org/jenkins/job/libelektra-daily/">daily build</a> is executed according to a cron schedule.</p>
<p>The <a href="https://build.libelektra.org/jenkins/job/libelektra/">libelektra</a> build is triggered for all branches of the libelektra repository except for <code>debian</code>. Additionally all open branches in forks targeting libelektra's repository via PRs are going to be build. Pushes to any of those branches will trigger a new build automatically.</p>
<p>The following phrases can be used as comments to manually trigger a specific build:</p>
<ul>
<li>jenkins build <a href="https://build.libelektra.org/jenkins/job/libelektra-daily/">daily</a> please</li>
<li>jenkins build <a href="https://build.libelektra.org/job/elektra-git-buildpackage-jessie/">git-buildpackage-jessie</a> please</li>
<li>jenkins build <a href="https://build.libelektra.org/jenkins/job/libelektra/">libelektra</a> please</li>
</ul>
<p>Additionally <code>jenkins build all please</code> can be used to trigger all build jobs relevant for PR's. Since this needs a lot of resources please use it only if</p>
<ul>
<li>all of the <b>standard PR jobs</b> were already <b>successful</b>, and</li>
<li>you are sure that you <b>do not want change anything</b> in your PR anymore</li>
</ul>
<h2>Test Environments</h2>
<p>We use Docker containers to provide the various test environments.</p>
<p>They are described <a href="https://master.libelektra.org/scripts/docker">in the repository</a> and the Jenkinsfile describes how to build them. If a rebuild of the images is needed is determined by the hash of the Dockerfile used to describe it. If it has not changed the build step will be skipped. In the case that an image needed a build it will afterwards be uploaded into a private Docker image registry (currently on a7) and thus is shared between all Docker capable build slaves.</p>
<h2>Tests</h2>
<p>We will use the Docker images build as described earlier to run compilations and tests for Elektra. This allows us to run tests independent of which nodes are available (as the environment is portable).</p>
<p>The Jenkinsfile describes the steps used to run tests. Helper functions for easily adding new tests are available (buildAndTest, BuildAndTestAsan, ...).</p>
<p>The <code>withDockerEnv</code> helper makes sure to print the following information at the start of a test branch:</p><ul>
<li>branch name</li>
<li>build machine</li>
<li>docker image id</li>
</ul>
<p>Coverage reports are generated automatically when using the buildAndTest helper and the appropriate Cmake flags for coverage generation have been set. They are uploaded to <a href="https://doc.libelektra.org/coverage/">https://doc.libelektra.org/coverage/</a>.</p>
<p>Artifacts from <code>ctest</code> are also preserved automatically when using buildAndTest. The function also takes care of providing a stagename based path so multiple tests can not overwrite files that share the same name.</p>
<p>Tests are executed in order dictated by the Jenkinsfile. In general new tests should be added to the 'full build stage' that will only run after a standard full test run succeeded. This saves execution time on the build server for most common errors.</p>
<p>Since there is no strict way to enforce the way tests are added we encourage you to read the existing configuration and modify existing tests so they suite your needs.</p>
<h2>Deployment</h2>
<p>For runs of the build job that are run in the master branch we also execute deployment steps after all tests pass. We use it to build debian packages and move it into the repository on the a7 node. Additionally we recompile the homepage and deploy it on the a7 node.</p>
<h2>Issues with the build environment</h2>
<p>If you have issues that are related to the build system you can open a normal issue and tag it with <code>build</code> and <code>question</code>. If you feel like your inquiry does not warrent a issue on its own, please use <a href="https://issues.libelektra.org/160">our buildserver issue</a>.</p>
<h2>Jenkins</h2>
<p>This section describes how to replicate the current Jenkins configuration.</p>
<h3>Jenkins libelektra configuration</h3>
<p>The <code>libelektra</code> build job is a multibranch pipeline job. It is easiest to add via the BlueOcean interface.</p>
<p>Most of the default settings should be ok, however some settings need to be verified or added to build Elektra correctly:</p><ul>
<li>In Branch Sources under Behaviours <code>Filter by name</code> should be added to exclude the <code>debian</code> branch from being build. The reason for this is that the <code>debian</code> branch is not providing a Jenkinsfile.</li>
<li><code>Advanced clone behaviors</code> should be added and the path to the git mirror needs to be specified: <code>/home/jenkins/git_mirrors/libelektra</code>. This reference repository is created and maintained by our <a href="https://build.libelektra.org/jenkins/job/libelektra-daily/">daily buildjob</a>.</li>
<li>Under Property strategy you can add <code>Trigger build on pull request comment</code>. <code>jenkins build (libelektra|all) please</code> is a good starting point.</li>
<li>For Build Configuration you want to specify <code>by Jenkinsfile</code> and add the script path: <code>scripts/jenkins/Jenkinsfile</code>.</li>
</ul>
<h3>Add a Jenkins node</h3>
<p>A node needs to have a JRE (Java Runtime Environment) installed. Further it should run an SSH (Secure SHell) server. If you want to provide environments via Docker you need to install that as well.</p>
<p>A <code>jenkins</code> user with 47000:47000 ids should be created as this is what is expected in Docker images. Additionally a public key authentification should be set up so the jenkins master can establish an ssh connection with the node. If the node should be able to interact with Docker the jenkins user should be added to the <code>docker</code> group.</p>
<p>Nodes should be set to only build jobs matching their labels and to be online as much as possible. As for labels <code>gitmirror</code> should be if you want to cache repositories on this node. If Docker is available the <code>docker</code> label should be set. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
