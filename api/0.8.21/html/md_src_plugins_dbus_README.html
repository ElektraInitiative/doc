<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Plugin: dbus</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Elektra
   &#160;<span id="projectnumber">0.8.21</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Plugin: dbus </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>infos = Information about the dbus plugin is in keys below</li>
<li>infos/author = Markus Raab <a href="#" onclick="location.href='mai'+'lto:'+'ele'+'kt'+'ra@'+'li'+'bel'+'ek'+'tra'+'.o'+'rg'; return false;">elekt<span style="display: none;">.nosp@m.</span>ra@l<span style="display: none;">.nosp@m.</span>ibele<span style="display: none;">.nosp@m.</span>ktra<span style="display: none;">.nosp@m.</span>.org</a></li>
<li>infos/licence = BSD</li>
<li>infos/provides = notification</li>
<li>infos/needs =</li>
<li>infos/recommends =</li>
<li>infos/placements = postgetstorage postcommit</li>
<li>infos/status = maintained unittest libc global</li>
<li>infos/description = Sends DBus signals when a method is called</li>
</ul>
<p>This plugin is a notification plugin, which sends a signal to D-Bus when the key database (KDB) has been modified.</p>
<h2>Dependencies</h2>
<ul>
<li><code>libdbus-1-dev</code></li>
</ul>
<h2>Dbus</h2>
<p>A preferred way to interconnect desktop applications and even embedded system applications on mobile devices running Linux is D-Bus. The idea of D-Bus accords to that of Elektra: to provide standards to let software work together more tightly. D-Bus provides a simple and lightweight IPC (Inter-Process Communication) system to be used within desktop systems. Next to RPC (Remote Procedure Call), which is not used in this plugin, it supports signals which can notify an arbitrary number of other applications about changes. Given software like a D-Bus library, notification itself is a rather easy task, but it involves additional library dependences. So it is the perfect task to be implemented as a plugin. The information about the channels to be used can be stored in the global key database.</p>
<p>D-Bus supports a <b>system-wide bus</b> and a <b>session bus</b>. The system configuration can be accessed by each user and the user configuration is limited to a single user. Both buses can immediately be used for the system and user configuration notification updates to get pleasing results. But, there is a problem with the session bus: It is possible within D-Bus that a user starts several sessions. The user configuration should be global to the user and is not aware of these sessions. So if several sessions are started, some of the user's processes will miss notification updates.</p>
<p>The namespaces are mapped to the buses the following way:</p>
<ul>
<li>system: system-wide bus</li>
<li>user: session bus</li>
</ul>
<p>Following signal names are used to notify about changes in the Elektraâ€™s KeySet:</p>
<ul>
<li>KeyAdded: a key has been added</li>
<li>KeyChanged: a key has been changed</li>
<li>KeyDeleted: a key has been deleted</li>
</ul>
<p>Alternatively, (with the option announce=once) only a single message is send:</p>
<ul>
<li>Commit: a key has been added, changed or deleted</li>
</ul>
<h2>Usage</h2>
<p>The recommended way is to globally mount the plugin: </p><pre class="fragment">    kdb global-mount dbus
</pre><p>Alternatively one can mount the plugin additionally to a storage plugin, e.g.: </p><pre class="fragment">    kdb mount file.dump / dump dbus
</pre><p>For openicc one would use (mounts with announce=once): </p><pre class="fragment">    kdb mount-openicc
</pre><h3>Shell</h3>
<p>Then we can receive the notification events using: </p><pre class="fragment">    dbus-monitor type='signal',interface='org.libelektra',path='/org/libelektra/configuration'
</pre><p>Or via the supplied test program: </p><pre class="fragment">    kdb testmod_dbus receive_session
</pre><p>We can trigger a message with: </p><pre class="fragment">    kdb set user/dbus/x b
</pre><p>Note that changes in <code>user</code> fire on the dbus <code>session</code>, and changes in namespace <code>system</code> in the dbus <code>system</code> bus. To receive <code>system</code> changes we will use: </p><pre class="fragment">    kdb testmod_dbus receive_system
    dbus-monitor --system type='signal',interface='org.libelektra',path='/org/libelektra/configuration'
</pre><p>And then fire it with: </p><pre class="fragment">    kdb set system/dbus/y a
</pre><h3>C</h3>
<div class="fragment"><div class="line">dbus_bus_add_match (connection, <span class="stringliteral">&quot;type=&#39;signal&#39;,interface=&#39;org.libelektra&#39;,path=&#39;/org/libelektra/configuration&#39;&quot;</span>, &amp;error);</div></div><!-- fragment --><p>See the full example <a href="/home/markus/Projekte/Elektra/current/src/plugins/dbus/receivemessage.c">here</a>.</p>
<h3>Qt</h3>
<p>Here a small example for QDBusConnection:</p>
<p>Place this in your Qt class header: </p><pre class="fragment">public slots:
  void configChanged( QString msg );
</pre><p>Put this in your Qt class, e.g. the constructor: </p><pre class="fragment">if( QDBusConnection::sessionBus().connect( QString(), "/org/libelektra/configuration", "org.libelektra", QString(),
                                       this, SLOT( configChanged( QString ) )) )
    fprintf(stderr, "=================== Done connect\n" );
</pre><p>Here comes the org.libelektra signals: </p><pre class="fragment">void SynnefoApp::configChanged( QString msg )
{
  fprintf( stdout, "config changed: %s\n", msg.toLocal8Bit().data() );
};
</pre><h3>Python</h3>
<p>In Python the DBus notifications can be used as follows</p>
<div class="fragment"><div class="line">import dbus</div><div class="line">import gobject</div><div class="line">gobject.threads_init()  # important: initialize threads if gobject main loop is used</div><div class="line">from dbus.mainloop.glib import DBusGMainLoop</div><div class="line"></div><div class="line">class DBusTest():</div><div class="line">    def __init__(self):</div><div class="line">        DBusGMainLoop(set_as_default=True)</div><div class="line">        bus = dbus.SystemBus()  # may use session bus for user db</div><div class="line">        bus.add_signal_receiver(self.elektra_dbus_key_changed_cb,</div><div class="line">            signal_name=&quot;KeyChanged&quot;,</div><div class="line">            dbus_interface=&quot;org.libelektra&quot;,</div><div class="line">            path=&quot;/org/libelektra/configuration&quot;)</div><div class="line"></div><div class="line">    def elektra_dbus_key_changed_cb(self, key):</div><div class="line">        print(&#39;key changed %s&#39; % key)</div><div class="line"></div><div class="line">test = DBusTest()</div><div class="line">loop = gobject.MainLoop()</div><div class="line">try:</div><div class="line">    loop.run()</div><div class="line">except KeyboardInterrupt:</div><div class="line">    loop.quit()</div></div><!-- fragment --><h2>Background</h2>
<p>Today, programs are often interconnected in a dense way. Such applications should always be informed when something in their environment changes. For user interactive software, notification about configuration changes is expected. The only alternative is polling, which wastes resources. It additionally is no option for interactive software, where the latency needs to be low. Instead, the software which changes the configuration has to notify all other interested applications that can reread their configuration without significant delay. In Elektra, a notification plugin ensures that a notification is actually sent on each change.</p>
<p>Applications can wait for such a notification with hand-written code. Bindings, however, allow for better integration. It is a common approach for toolkits to provide a main loop. Applications using such toolkits can integrate notification services into this main loop.</p>
<p>The actions that occur in such events are application or toolkit specific because of the non-invasive nature of Elektra. Software reacts in many different ways to update events. Hence, the frequency of update events should be kept at a minimum. Changes are kept atomic with a single attempt to write out configuration. Notification callbacks shall not change configuration because this can lead to a longer chain of unwanted modifications. That might not be true, however, if a programmer of the whole system knows that a chain of reactions will terminate. When doing such event-driven programming, care is needed to avoid infinite loops. Elektra guarantees consistency of the key database even in such cases. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
