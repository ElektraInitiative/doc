<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: How-To: Merging</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.10.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">How-To: Merging </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_tutorials_cmerge"></a> </p>
<h1><a class="anchor" id="autotoc_md4308"></a>
Introduction</h1>
<p>Elektra takes the semantic aspects of configuration files into account when merging them into one result file. Those configuration files are represented as key sets in Elektra. Key sets are collections of name-value pairs.</p>
<p>The <code>kdb</code> tool allows users to access and perform functions on the Elektra key database from the command line. We added a new command to this very useful tool, the <code>cmerge</code> command. This command allows a user to perform a three-way merge of key sets from the <code>kdb</code> tool.</p>
<p>The syntax to use this tool is:</p>
<p><code>kdb cmerge [OPTIONS] our their base result</code></p>
<p><code>our</code>, <code>their</code> and <code>base</code> represent the three keys that are used in a three-way merge. As in the <code>diff3</code> tool, required are the three files MYFILE (our), OLDFILE (base) and YOURFILE (their) The result off the three-way merge will be stored in <code>result</code>.</p>
<h1><a class="anchor" id="autotoc_md4309"></a>
Simple example</h1>
<p>The easiest case is if all three versions contain equal data.</p>
<div class="fragment"><div class="line">kdb set user:/tests/base a</div>
<div class="line">#&gt; Create a new key user:/tests/base with string &quot;a&quot;</div>
<div class="line">kdb set user:/tests/their a</div>
<div class="line">#&gt; Create a new key user:/tests/their with string &quot;a&quot;</div>
<div class="line">kdb set user:/tests/our a</div>
<div class="line">#&gt; Create a new key user:/tests/our with string &quot;a&quot;</div>
<div class="line">kdb cmerge user:/tests/our user:/tests/their user:/tests/base user:/tests/result</div>
<div class="line">kdb get user:/tests/result</div>
<div class="line">#&gt; a</div>
</div><!-- fragment --><p>We change the key for another example.</p>
<div class="fragment"><div class="line">kdb set user:/tests/our b</div>
<div class="line">#&gt; Set string to &quot;b&quot;</div>
</div><!-- fragment --><p>Using a <code>result</code> path that is not empty gives an error. The option <code>-f</code> can be used to override. <b>Attention!</b> This deletes existing keys below <code>result</code>.</p>
<div class="fragment"><div class="line">kdb cmerge user:/tests/our user:/tests/their user:/tests/base user:/tests/result</div>
<div class="line"># RET: 3</div>
<div class="line"># There are keys in the result path. Use -f to override them.</div>
<div class="line">kdb cmerge -f user:/tests/our user:/tests/their user:/tests/base user:/tests/result</div>
<div class="line">kdb get user:/tests/result</div>
<div class="line">#&gt; b</div>
</div><!-- fragment --><p>We can use the same key multiple times in a single call to cmerge.</p>
<div class="fragment"><div class="line">kdb set user:/tests/same a</div>
<div class="line">#&gt; Create a new key user:/tests/same with string &quot;a&quot;</div>
<div class="line">kdb cmerge -f user:/tests/same user:/tests/same user:/tests/same user:/tests/result</div>
<div class="line">kdb get user:/tests/result</div>
<div class="line">#&gt; a</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md4310"></a>
hosts</h2>
<p>As a real-world example, we import three different (see the comment) versions of a hosts file.</p>
<div class="fragment"><div class="line">echo &quot;127.0.0.1       localhost</div>
<div class="line">127.0.1.1       computer</div>
<div class="line"> </div>
<div class="line"># BASE The following lines are desirable for IPv6 capable hosts</div>
<div class="line">::1     ip6-localhost ip6-loopback</div>
<div class="line">fe00::0 ip6-localnet</div>
<div class="line">ff00::0 ip6-mcastprefix</div>
<div class="line">ff02::1 ip6-allnodes</div>
<div class="line">ff02::2 ip6-allrouters&quot; | kdb import user:/tests/hosts/base hosts</div>
<div class="line"> </div>
<div class="line">echo &quot;127.0.0.1       localhost</div>
<div class="line">127.0.1.1       computer</div>
<div class="line"> </div>
<div class="line"># OUR The following lines are desirable for IPv6 capable hosts</div>
<div class="line">::1     ip6-localhost ip6-loopback</div>
<div class="line">fe00::0 ip6-localnet</div>
<div class="line">ff00::0 ip6-mcastprefix</div>
<div class="line">ff02::1 ip6-allnodes</div>
<div class="line">ff02::2 ip6-allrouters&quot; | kdb import user:/tests/hosts/our hosts</div>
<div class="line"> </div>
<div class="line">echo &quot;127.0.0.1       localhost</div>
<div class="line">127.0.1.1       computer</div>
<div class="line"> </div>
<div class="line"># THEIR The following lines are desirable for IPv6 capable hosts</div>
<div class="line">::2     ip6-localhost ip6-loopback</div>
<div class="line">fe00::0 ip6-localnet</div>
<div class="line">ff00::0 ip6-mcastprefix</div>
<div class="line">ff02::1 ip6-allnodes</div>
<div class="line">ff02::2 ip6-allrouters&quot; | kdb import user:/tests/hosts/their hosts</div>
<div class="line"> </div>
<div class="line">kdb cmerge user:/tests/hosts/our user:/tests/hosts/their user:/tests/hosts/base user:/tests/hosts/result</div>
</div><!-- fragment --><p>The merge notices that only one of the three versions of the key <code>ip6-localhost</code> has changed. Assuming that this was an update it puts the new value in the result.</p>
<div class="fragment"><div class="line">kdb get user:/tests/hosts/result/ipv6/ip6-localhost</div>
<div class="line">#&gt; ::2</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md4311"></a>
Metadata</h1>
<p>Metadata gets merged as well. We do not follow a complicated approach for this topic. When a key-value pair is chosen from the three versions to be present in the result it takes all its metadata with it.</p>
<p>In case that the values of some keys are equal, the <code>our</code> version wins and consequently the metadata of the <code>our</code> version is used. The reason for this is that users might have used the metadata for personal comments.</p>
<p>To demonstrate this, we continue the hosts example:</p>
<div class="fragment"><div class="line">kdb meta-get user:/tests/hosts/result/ipv6/ip6-localhost comment/#2</div>
<div class="line">#&gt;  THEIR The following lines are desirable for IPv6 capable hosts</div>
</div><!-- fragment --><p>We set up some keys:</p>
<div class="fragment"><div class="line">kdb set user:/tests/meta/base equal</div>
<div class="line">#&gt; Create a new key user:/tests/meta/base with string &quot;equal&quot;</div>
<div class="line">kdb meta-set user:/tests/meta/base comment/#0 &quot;This is the original inline comment&quot;</div>
<div class="line">kdb meta-set user:/tests/meta/base comment/#1 &quot;This is the first line of the original comment above the key&quot;</div>
<div class="line">kdb meta-set user:/tests/meta/base comment/#2 &quot;This is the second line of the original comment above the key&quot;</div>
<div class="line"> </div>
<div class="line">kdb set user:/tests/meta/their equal</div>
<div class="line">#&gt; Create a new key user:/tests/meta/their with string &quot;equal&quot;</div>
<div class="line">kdb meta-set user:/tests/meta/their comment/#0 &quot;This is their inline comment&quot;</div>
<div class="line">kdb meta-set user:/tests/meta/their comment/#1 &quot;This is the first line of their comment above the key&quot;</div>
<div class="line">kdb meta-set user:/tests/meta/their comment/#2 &quot;This is the second line of their comment above the key&quot;</div>
<div class="line"> </div>
<div class="line">kdb set user:/tests/meta/our equal</div>
<div class="line">#&gt; Create a new key user:/tests/meta/our with string &quot;equal&quot;</div>
<div class="line">kdb meta-set user:/tests/meta/our comment/#0 &quot;This is your custom inline comment&quot;</div>
<div class="line">kdb meta-set user:/tests/meta/our comment/#1 &quot;This is the first line of your custom comment above the key&quot;</div>
<div class="line">kdb meta-set user:/tests/meta/our comment/#2 &quot;This is the second line of your custom comment above the key&quot;</div>
<div class="line"> </div>
<div class="line">kdb cmerge user:/tests/meta/our user:/tests/meta/their user:/tests/meta/base user:/tests/meta/metaFromOur</div>
</div><!-- fragment --><p>Now we can check if the metadata has been merged as expected.</p>
<div class="fragment"><div class="line">kdb meta-get user:/tests/meta/metaFromOur comment/#0</div>
<div class="line">#&gt; This is your custom inline comment</div>
<div class="line">kdb meta-get user:/tests/meta/metaFromOur comment/#1</div>
<div class="line">#&gt; This is the first line of your custom comment above the key</div>
<div class="line">kdb meta-get user:/tests/meta/metaFromOur comment/#2</div>
<div class="line">#&gt; This is the second line of your custom comment above the key</div>
</div><!-- fragment --><p>If a key is part of the result because its value has changed then the result will also contain the metadata of that key.</p>
<div class="fragment"><div class="line">kdb set user:/tests/meta/their different</div>
<div class="line">#&gt; Set string to &quot;different&quot;</div>
<div class="line"> </div>
<div class="line">kdb cmerge user:/tests/meta/our user:/tests/meta/their user:/tests/meta/base user:/tests/meta/metaFromChanged</div>
</div><!-- fragment --><p>We can test again if the result meets our expectations.</p>
<div class="fragment"><div class="line">kdb meta-get user:/tests/meta/metaFromChanged comment/#2</div>
<div class="line">#&gt; This is the second line of their comment above the key</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md4312"></a>
Arrays</h1>
<p>cmerge uses LibGit2 to handle arrays in an efficient manner.</p>
<div class="fragment"><div class="line">echo &quot;one\</div>
<div class="line">two\</div>
<div class="line">three\</div>
<div class="line">four\</div>
<div class="line">five&quot; | kdb import user:/tests/arrays/original line</div>
<div class="line"> </div>
<div class="line">echo &quot;previous\</div>
<div class="line">one\</div>
<div class="line">two\</div>
<div class="line">three\</div>
<div class="line">four\</div>
<div class="line">five&quot; | kdb import user:/tests/arrays/changed line</div>
<div class="line"> </div>
<div class="line">kdb cmerge -f user:/tests/arrays/changed user:/tests/arrays/original user:/tests/arrays/original user:/tests/arrays/result</div>
<div class="line"> </div>
<div class="line">kdb get user:/tests/arrays/result/#0</div>
<div class="line">#&gt; previous</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md4313"></a>
Scripts</h1>
<p>There are two tools of which cmerge is the central tool:</p>
<ol type="1">
<li><a class="el" href="doc_help_kdb-install-config-file_md.html">`kdb install-config-file`</a> installs or merges configuration files from the file system into Elektra. There is <a class="el" href="doc_tutorials_install-config-files_md.html">a tutorial</a> for this tool, too.</li>
<li>`kdb cmerge-config-files` performs a three-way merge on three files using Elektra</li>
</ol>
<h1><a class="anchor" id="autotoc_md4314"></a>
Calling the API</h1>
<p>All the tools that use the merge library rely on the same API. An exemplary call to this API can be found in the <a href="/home/jenkins/workspace/libelektra-release/examples/kdbset.c">examples folder</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
