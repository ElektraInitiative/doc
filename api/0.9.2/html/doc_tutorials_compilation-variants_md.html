<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Compilation Variants</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Elektra
   &#160;<span id="projectnumber">0.9.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Compilation Variants </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>To create different variants of the same feature, but avoid code duplications within plugins, you have multiple options:</p>
<ul>
<li>Define a needs clause in a <a href="/home/mpranj/workspace/libelektra/doc/CONTRACT.ini">contract</a> and reuse another plugin as it is. This should be preferred for filter and validation tasks.</li>
<li>Have common code together in a helper library (or core library), see the CMake function <code>add_lib</code> for creating such a library (in the folder libs). This should be used for rather common functionality that might be useful for many plugins or even applications.</li>
<li>Have configuration for plugins (See <a href="https://doc.libelektra.org/api/latest/html/group__plugin.html">elektraPluginGetConfig()</a> and dynamically switch with <code>if</code> according to the configuration. This should be preferred when you want to (de)activate some features of a plugin at run-time.</li>
<li>Or use compilation variants to compile the plugin code multiple times with different <code>COMPILE_DEFINITIONS</code> (that are Macro definitions). This should be preferred when different macro definitions lead to different plugins. It should especially be used when the resulting plugins have different dependencies: it is possible to have different <code>LINK_LIBRARIES</code>.</li>
</ul>
<p>The advantage of compilation variants are:</p>
<ul>
<li>No run-time overhead</li>
<li>Can be used during bootstrapping (when no configuration is available)</li>
<li>Different compilation variants can be built at once (no recompilation with different CMake flags required)</li>
<li>Different compilation variants can have different dependencies</li>
<li>Different compilation variants can be mounted without <code>#refnames</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md2611"></a>
How to use It</h1>
<p>To use compilation variants, add your plugin in the CMake Cache Variable <code>PLUGINS</code> multiple times. Then there can be an arbitrary number of variants. As naming convention you should have a base name with an additional variant appended with underscore, e.g.:</p>
<div class="fragment"><div class="line">myplugin_varianta;myplugin_variantb</div>
</div><!-- fragment --><p>In the CMakeLists.txt of your plugin, you have two options. Option (A): When you can easily enlist every variant you simply list all plugins one after the other (<em>outside of</em> <code>if (DEPENDENCY_PHASE)</code>):</p>
<div class="fragment"><div class="line">add_plugin(myplugin_varianta</div>
<div class="line">        SOURCES      &lt;your sources for varianta here..&gt;</div>
<div class="line">        COMPILE_DEFINITIONS   VARIANTA ELEKTRA_VARIANT=varianta</div>
<div class="line">        LINK_LIBRARIES &lt;libraries for varianta&gt;</div>
<div class="line">        )</div>
<div class="line">add_plugin(myplugin_variantb</div>
<div class="line">        SOURCES      &lt;your sources for variantb here..&gt;</div>
<div class="line">        COMPILE_DEFINITIONS   VARIANTB  ELEKTRA_VARIANT=variantb</div>
<div class="line">        LINK_LIBRARIES &lt;libraries for variantb&gt;</div>
<div class="line">        )</div>
</div><!-- fragment --><p>Option (B): If you cannot enlist every possible compilation variant, you can iterate over all PLUGINS and check which names are requested. Then you create a plugin for every name that matches:</p>
<div class="fragment"><div class="line">foreach (plugin ${PLUGINS})</div>
<div class="line">        if (${plugin} MATCHES &quot;myplugin_.*&quot;)</div>
<div class="line">                # somehow process the variant names and include</div>
<div class="line">                # or change sources and compile definitions</div>
<div class="line">                # based on that.</div>
<div class="line">                add_plugin(${plugin}</div>
<div class="line">                SOURCES      &lt;your sources here..&gt;</div>
<div class="line">                COMPILE_DEFINITIONS   &lt;definitions here..&gt;</div>
<div class="line">                        ELEKTRA_VARIANT=${plugin without prefix}</div>
<div class="line">        LINK_LIBRARIES &lt;libraries for variantb&gt;</div>
<div class="line">        if (${plugin} MATCHES &quot;ALL&quot;)</div>
<div class="line">                # handle categories of plugins</div>
<div class="line">                add_plugin(myplugin_all1, ...)</div>
<div class="line">                add_plugin(myplugin_all2, ...)</div>
</div><!-- fragment --><p>For the categories such as <code>ALL</code>, however, you need to automatically append (using <code>add_plugin</code>) a useful set of plugins.</p>
<p>Note that every plugin needs to have <code>ELEKTRA_VARIANT</code> differently set in <code>COMPILE_DEFINITIONS</code>, otherwise you will get a linker error that <code>libelektra_&lt;pluginname&gt;_LTX_elektraPluginSymbol</code> has multiple definitions.</p>
<p>Now every public function of the plugin conflicts with itself. To avoid that, you can use:</p>
<ul>
<li>static functions, but they are only visible within one file. This should be preferred, when possible.</li>
<li>use helper libraries using <code>add_lib</code> to share code between compilation variants (only if code is also potentially useful for other plugins/applications)</li>
<li>Get a unique name for every variant using the macro <code><a class="el" href="group__plugin.html#gacb05c902e4014535589db4193da87460" title="Declare a plugin&#39;s function name suitable for compilation variants (see doc/tutorials).">ELEKTRA_PLUGIN_FUNCTION(myplugin, open)</a></code> where myplugin is the name of the plugin and the second argument is how the function should be called.</li>
<li>Including a readme for every variant (with <code>#ifdef</code> for different text) using the macro <code>#include <a class="el" href="group__plugin.html#gabdcb97b05a83130c32bbde75db80fc50" title="The filename for inclusion of the readme for compilation variants (see doc/tutorials).">ELEKTRA_README(myplugin)</a></code></li>
</ul>
<p>As a summary, you can have many plugins build out of the same source. Using <code>pluginname_variantnames</code> many plugins will be compiled, each with other <code>SOURCES</code> or <code>COMPILE_DEFINITIONS</code> and even <code>LINK_LIBRARIES</code>: If you, e.g. just set the variants name as macro you can use</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifdef varianta</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --><p>within the code and can have two plugins: one (called <code>myplugin_varianta</code>) compiled included the <code>#ifdef</code> the other (base variant called <code>myplugin</code>) without.</p>
<p>Currently compilation variants are used in <a href="https://master.libelektra.org/src/plugins/resolver/resolver.c">the resolver plugin</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
