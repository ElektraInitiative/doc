<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: How-To: Integrate elektra-merge Into a Debian Package</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Elektra
   &#160;<span id="projectnumber">0.8.22</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">How-To: Integrate elektra-merge Into a Debian Package </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>We assume that you know what <a href="https://packages.debian.org/sid/ucf">ucf</a> is and have some <a href="https://wiki.debian.org/ConfigPackages">general knowledge about configuration file handling in Debian</a>.</p>
<p>This guide explains how to use ucf's new <code>--three-way-merge-command</code> functionality in conjunction with Elektra in order to utilize Elektraâ€™s powerful tools in order to allow automatic three-way merges of your package's configuration during upgrades in a way that is more reliable than a diff3 merge. This guide assumes that you are familiar with ucf already and are just trying to implement the <code>--three-way-merge-command</code> option using Elektra.</p>
<h2>The New Option</h2>
<p>The addition of the <code>--three-way-merge-command</code> option was a part of my Google Summer of Code Project. This option takes the form: &ndash;three-way-merge-command command &lt;New file&gt;=""&gt; &lt;Destination&gt;</p>
<p>Where <code>command</code> is the command you would like to use for the merge. <code>New File</code> and <code>Destination</code> are the same as always.</p>
<h2>elektra-merge</h2>
<p>We added a new script to Elektra called elektra-merge for use with this new option in ucf. This script acts as a liaison between ucf and Elektra, allowing a regular ucf command to run a <code>kdb merge</code> even though ucf commands only pass <code>New File</code> and <code>Destination</code> whereas kdb merge requires <code>ourpath</code>, <code>theirpath</code>, <code>basepath</code>, and <code>resultpath</code>. Since ucf already performs a three-way merge, it keeps track of all the necessary files to do so, even though it only takes in <code>New File</code> and <code>Destination</code>.</p>
<p>In order to use <code>elektra-merge</code>, the current configuration file must be mounted to KDB to serve as <code>ours</code> in the merge. The script automatically mounts <code>theirs</code>, <code>base</code>, and <code>result</code> using the <code>kdb remount</code> command in order to use the same backend as <code>ours</code> (since all versions of the same file should use the same backend anyway) and this way users don't need to worry about specifying the backend for each version of the file. Then the script attempts a merge on the newly mounted KeySets. Once this is finished, either with success or not, the script finishes by unmounting all but <code>our</code> copy of the file to cleanup KDB. Then, if the merge was successful ucf will replace <code>ours</code> with the result providing the package with an automatically merged configuration which will also be updated in KDB itself.</p>
<p>Additionally, we added two other scripts, <code>elektra-mount</code> and <code>elektra-umount</code> which act as simple wrappers for <code>kdb mount</code> and <code>kdb umount</code>. They work identically but are more script friendly.</p>
<h2>The Full Command</h2>
<p>The full command to use <code>elektra-merge</code> to perform a three-way merge on a file managed by ucf is: ucf &ndash;three-way &ndash;threeway-merge-command elektra-merge &lt;New file&gt;=""&gt; &lt;Destination&gt;</p>
<p>That's it! As described above, <code>elektra-merge</code> is smart enough to run the whole merge off of the information from that command and utilizes the new <code>kdb remount</code> command to do so.</p>
<h2>How-To Integrate</h2>
<p>Integrating <code>elektra-merge</code> into a package that already uses ucf is very easy! In <code>postinst</code> you should have a line similar to: ucf &lt;New file&gt;=""&gt; &lt;Destination&gt;</p>
<p>or perhaps: ucf &ndash;three-way &lt;New file&gt;=""&gt; &lt;Destination&gt;</p>
<p>All you must do is in <code>postinst</code>, when run with the <code>configure</code> option you must mount the config file to Elektra: kdb elektra-mount &lt;New file&gt;=""&gt; &lt;Mounting destination&gt;=""&gt; &lt;Backend&gt;</p>
<p>Next, you must update the line containing <code>ucf</code> with the options <code>--three-way</code> and <code>--threeway-merge-command</code> like so: ucf &ndash;three-way &ndash;threeway-merge-command elektra-merge &lt;New file&gt;=""&gt; &lt;Destination&gt;</p>
<p>Then, in your <code>postrm</code> script, during a purge, you must unmount the config file before deleting it: kdb elektra-umount &lt;name&gt;</p>
<p>That's it! With those small changes you can use Elektra to perform automatic three-way merges on any files that your package uses ucf to handle!</p>
<h2>Example</h2>
<p>Below is a diff representing the changes we made to the samba-common package in order to allow automatic configuration merging for <code>smb.conf</code> using Elektra. We chose this package because it already uses ucf to handle <code>smb.conf</code> but it frequently requires users to manually merge changes across versions. Here is the patch showing what we changed:</p>
<div class="fragment"><div class="line">diff samba_orig/samba-3.6.6/debian/samba-common.postinst samba/samba-3.6.6/debian/samba-common.postinst</div><div class="line">92c92,93</div><div class="line">&lt; ucf --three-way --debconf-ok &quot;$NEWFILE&quot; &quot;$CONFIG&quot;</div><div class="line">---</div><div class="line">&gt; kdb elektra-mount &quot;$CONFIG&quot; system/samba/smb ini</div><div class="line">&gt; ucf --three-way --threeway-merge-command elektra-merge --debconf-ok &quot;$NEWFILE&quot; &quot;$CONFIG&quot;</div><div class="line">Only in samba/samba-3.6.6/debian/: samba-common.postinst~</div><div class="line">diff samba_orig/samba-3.6.6/debian/samba-common.postrm samba/samba-3.6.6/debian/samba-common.postrm</div><div class="line">4a5</div><div class="line">&gt;       kdb elektra-umount system/samba/smb</div></div><!-- fragment --><p>As you can see, all we had to do was add the line to mount <code>smb.conf</code> during install, update the ucf command to include the new <code>--threeway-merge-command</code> option, and unmount <code>system/samba/smb</code> during a purge. It really is that easy! </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
