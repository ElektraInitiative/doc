<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Cryptographic Methods in Elektra</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Elektra
   &#160;<span id="projectnumber">0.8.24</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Cryptographic Methods in Elektra </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Elektra can protect the following aspects of your configuration:</p>
<ol type="1">
<li>confidentiality (i.e. protection against unauthorized access), and</li>
<li>integrity (i.e. protection against unauthorized modification).</li>
</ol>
<p>Elektra provides two plugins to achieve this protection:</p>
<ol type="1">
<li><code>crypto</code>, and</li>
<li><code>fcrypt</code>.</li>
</ol>
<h2>Prerequisites - GnuPG</h2>
<p>For the rest of this tutorial we assume that you are somewhat familiar with GnuPG (GPG). The documentation of GnuPG can be found <a href="https://gnupg.org/documentation/index.html">here</a>.</p>
<p>In order to find your GPG private key(s) you can use: </p><pre class="fragment">    gpg2 --list-secret-keys
</pre><p>If GPG private keys are available, you see an output, that looks similar to this: </p><pre class="fragment">    sec   rsa1024 2016-08-20 [SC]
              DDEBEF9EE2DC931701338212DAF635B17F230E8D
    uid           [ultimate] Elektra Unit Tests (DO NOT USE IN PRODUCTION) &lt;unit-tests@libelektra.org&gt;
    ssb   rsa1024 2016-08-20 [E]
</pre><p>The GPG key we use in this tutorial has the ID <code>DDEBEF9EE2DC931701338212DAF635B17F230E8D</code>.</p>
<p>A GPG private key is mandatory for the plugins to work. If you have no GPG private key available, you can generate one by entering the following command: </p><pre class="fragment">    gpg2 --generate-key
</pre><p>The <code>fcrypt</code> plugin and the <code>crypto</code> plugin support both versions (version 1 and version 2) of GPG.</p>
<h2>Introduction</h2>
<p>In this tutorial we explain the use of the <code>crypto</code> plugin and the <code>fcrypt</code> plugin by a simple example: We want to protect a password that is contained in an INI-file.</p>
<p>The following example demonstrates how the INI-file is mounted without encryption enabled. We create the password at <code>user/test/password</code> and display the contents of <code>test.ini</code>.</p>
<p><em>Step 1:</em> Mount <code>test.ini</code></p>
<div class="fragment"><div class="line">kdb set /sw/elektra/kdb/#0/current/plugins &quot;&quot;</div><div class="line">sudo kdb mount test.ini user/test ini</div></div><!-- fragment --><p><em>Step 2:</em> Set the password at <code>user/test/password</code> and display the contents of <code>test.ini</code></p>
<div class="fragment"><div class="line">kdb set user/test/password 1234</div><div class="line">#&gt; Create a new key user/test/password with string &quot;1234&quot;</div><div class="line">kdb file user/test/password | xargs cat</div><div class="line">#&gt; password = 1234</div></div><!-- fragment --><p><em>Step 3:</em> (Optional) Cleanup</p>
<div class="fragment"><div class="line">kdb rm user/test/password</div><div class="line">kdb rm /sw/elektra/kdb/#0/current/plugins</div><div class="line">sudo kdb umount user/test</div></div><!-- fragment --><p>As you can see the password is stored in plain text. In this tutorial we demonstrate two different approaches towards confidentiality:</p>
<ol type="1">
<li>with the <code>fcrypt</code> plugin, which encrypts the entire INI-file, and</li>
<li>with the <code>crypto</code> plugin, which allows the encryption of specific key values only.</li>
</ol>
<p>We also show how to approach integrity with the signature features of the <code>fcrypt</code> plugin.</p>
<h2>Configuration File Encryption/Decryption</h2>
<p>The <code>fcrypt</code> plugin enables the encryption and decryption of entire configuration files, thus protecting the confidentiality of the configuration keys and values. <code>fcrypt</code> utilizes GPG for all cryptographic operations. The GPG key, which is used for encryption and decryption, is specified in the backend configuration under <code>encrypt/key</code>. </p><pre class="fragment">    sudo kdb mount test.ini user/test fcrypt "encrypt/key=DDEBEF9EE2DC931701338212DAF635B17F230E8D" ini
</pre><p>If the above command fails, please take a look at the <a href="https://master.libelektra.org/src/plugins/fcrypt/README.md#known-issues">ReadMe of the <code>fcrypt</code> plugin</a>.</p>
<p>As a result the file <code>test.ini</code> is encrypted using GnuPG. <code>fcrypt</code> will call the <code>gpg2</code> or <code>gpg</code> binary as follows: </p><pre class="fragment">    gpg2 -o test.ini -a -r DDEBEF9EE2DC931701338212DAF635B17F230E8D -e test.ini.tmp
</pre><p>Note that <code>test.ini</code> can not only be decrypted by Elektra, but it is also possible to decrypt it with GnuPG directly. You can try to decrypt <code>test.ini</code> with GPG: </p><pre class="fragment">    gpg2 -d test.ini
</pre><p>The complete procedure looks like this:</p>
<div class="fragment"><div class="line">kdb set /sw/elektra/kdb/#0/current/plugins &quot;&quot;</div><div class="line">sudo kdb mount test.ini user/test fcrypt &quot;encrypt/key=DDEBEF9EE2DC931701338212DAF635B17F230E8D&quot; ini</div><div class="line">kdb set user/test/password 1234</div><div class="line">#&gt; Create a new key user/test/password with string &quot;1234&quot;</div><div class="line">kdb file user/test/password | xargs cat</div></div><!-- fragment --><p>To clean up the environment we run:</p>
<div class="fragment"><div class="line">kdb rm user/test/password</div><div class="line">kdb rm /sw/elektra/kdb/#0/current/plugins</div><div class="line">sudo kdb umount user/test</div></div><!-- fragment --><h2>Configuration File Signatures</h2>
<p><code>fcrypt</code> also offers the option to sign and verify configuration files, thus protecting the integrity of the configuration values. If <code>sign/key</code> is specified in the backend configuration, <code>fcrypt</code> will forward the key ID for signing the configuration file.</p>
<p>An example backend configuration is given as follows: </p><pre class="fragment">    sudo kdb mount test.ini user/test fcrypt "sign/key=DDEBEF9EE2DC931701338212DAF635B17F230E8D" ini
</pre><p>As a result the file <code>test.ini</code> will be signed using GPG. <code>fcrypt</code> will call the <code>gpg2</code> or <code>gpg</code> binary as follows: </p><pre class="fragment">    gpg2 -o test.ini -a -u DDEBEF9EE2DC931701338212DAF635B17F230E8D -r DDEBEF9EE2DC931701338212DAF635B17F230E8D -s test.ini.tmp
</pre><p>If <code>test.ini</code> is modified, all following calls of <code>kdb get</code> will fail with an error message stating that the signature of the file could not be verified.</p>
<p>The complete example looks like this:</p>
<div class="fragment"><div class="line">kdb set /sw/elektra/kdb/#0/current/plugins &quot;&quot;</div><div class="line">sudo kdb mount test.ini user/test fcrypt &quot;sign/key=DDEBEF9EE2DC931701338212DAF635B17F230E8D&quot; ini</div><div class="line">kdb set user/test/password 1234</div><div class="line">#&gt; Create a new key user/test/password with string &quot;1234&quot;</div><div class="line">kdb file user/test/password | xargs cat</div></div><!-- fragment --><p>To clean up the environment we run:</p>
<div class="fragment"><div class="line">kdb rm user/test/password</div><div class="line">kdb rm /sw/elektra/kdb/#0/current/plugins</div><div class="line">sudo kdb umount user/test</div></div><!-- fragment --><h3>Combining Signatures and Encryption</h3>
<p>The options <code>sign/key</code> and <code>encrypt/key</code> can be combined together, resulting in configuration files, that are signed and encrypted.</p>
<p>Mounting <code>test.ini</code> with signatures and encryption enabled can be done like this: </p><pre class="fragment">    sudo kdb mount test.ini user/test fcrypt "sign/key=DDEBEF9EE2DC931701338212DAF635B17F230E8D,encrypt/key=DDEBEF9EE2DC931701338212DAF635B17F230E8D" ini
</pre><p>The complete example looks like this:</p>
<div class="fragment"><div class="line">kdb set /sw/elektra/kdb/#0/current/plugins &quot;&quot;</div><div class="line">sudo kdb mount test.ini user/test fcrypt &quot;sign/key=DDEBEF9EE2DC931701338212DAF635B17F230E8D,encrypt/key&quot; ini</div><div class="line">kdb set user/test/password 1234</div><div class="line">#&gt; Create a new key user/test/password with string &quot;1234&quot;</div><div class="line">kdb file user/test/password | xargs cat</div></div><!-- fragment --><p>To clean up the environment we run:</p>
<div class="fragment"><div class="line">kdb rm user/test/password</div><div class="line">kdb rm /sw/elektra/kdb/#0/current/plugins</div><div class="line">sudo kdb umount user/test</div></div><!-- fragment --><h2>Configuration Value Encryption/Decryption</h2>
<p>So far we learned how to encrypt and decrypt entrie configuration files. Sometimes we only want to protect a smaller subset of configuration values in a bigger configuration setting. For this reason the <code>crypto</code> plugin was developed.</p>
<p>The <code>crypto</code> plugin is actually a family of plugins and comes with three different providers:</p>
<ol type="1">
<li><code>crypto_gcrypt</code> using <code>libgcrypt</code>,</li>
<li><code>crypto_openssl</code> using <code>libcrypto</code>, and</li>
<li><code>crypto_botan</code> using <code>Botan</code>.</li>
</ol>
<p>We recommend that you use <code>crypto_gcrypt</code> as it is the fastest variant. The variants of the <code>crypto</code> plugin work the same internally, but use a different crypto library for cryptographic operations.</p>
<p>The <code>crypto</code> plugins provide the option to encrypt and decrypt single configuration values (Keys) in a Keyset. GPG is required for the key-handling.</p>
<p>To follow our example of an encrypted password in <code>test.ini</code>, we first mount the INI-file with the <code>crypto_gcrypt</code> plugin enabled, like this: </p><pre class="fragment">    sudo kdb mount test.ini user/test crypto_gcrypt "crypto/key=DDEBEF9EE2DC931701338212DAF635B17F230E8D" base64 ini
</pre><p>We recommend adding the <code>base64</code> plugin to the backend, because <code>crypto</code> will output binary data. Having binary data in configuration files is hardly ever feasible. <code>base64</code> encodes all binary values within a configuration file and transforms them into Base64 strings.</p>
<h3>Marking Keys For Encryption</h3>
<p>To tell the <code>crypto</code> plugin which Keys it should process, the metakey <code>crypto/encrypt</code> is used. The <code>crypto</code> plugin searches for the metakey <code>crypto/encrypt</code>. If the value is equal to <code>1</code>, the value of the Key will be encrypted.</p>
<p>We want to protect the password, that is stored under <code>user/test/password</code>. So we set the metakey as follows: </p><pre class="fragment">    kdb setmeta user/test/password crypto/encrypt 1
</pre><p>Now we are safe to set the actual password: </p><pre class="fragment">    kdb set user/test/password "1234"
</pre><p>The resulting INI-file contains the following data: </p><pre class="fragment">    #@META crypto/encrypt = 1
    password = @BASE64IyFjcnlwdG8wMBEAAADwPI+lqp+X2b6BIfLdRYgwxmAhVUPurqkQVAI78Pn4OYONbei4NfykMPvx9C9w91KT
</pre><p>You can access the password as usual with <code>kdb get</code>: </p><pre class="fragment">    kdb get user/test/password
</pre><p>As a result you get "1234".</p>
<h3>Disabling Encryption</h3>
<p>You can disable the encryption by setting <code>crypto/encrypt</code> to a value other than <code>1</code>, for example: </p><pre class="fragment">    kdb setmeta user/test/password crypto/encrypt 0
</pre><h3>Complete Example</h3>
<p>The complete example looks like this:</p>
<div class="fragment"><div class="line">kdb set /sw/elektra/kdb/#0/current/plugins &quot;&quot;</div><div class="line">sudo kdb mount test.ini user/test crypto_gcrypt &quot;crypto/key=DDEBEF9EE2DC931701338212DAF635B17F230E8D&quot; base64 ini</div><div class="line">kdb setmeta user/test/password crypto/encrypt 1</div><div class="line">kdb file user/test/password | xargs cat</div><div class="line">kdb set user/test/password 1234</div><div class="line">#&gt; Set string to &quot;1234&quot;</div><div class="line">kdb set user/test/config &quot;I am not encrypted&quot;</div><div class="line">#&gt; Create a new key user/test/config with string &quot;I am not encrypted&quot;</div><div class="line">kdb file user/test/password | xargs cat</div></div><!-- fragment --><p>To disable encryption on <code>user/test/password</code>, we can run:</p>
<div class="fragment"><div class="line">kdb setmeta user/test/password crypto/encrypt 0</div><div class="line">kdb file user/test/password | xargs cat</div></div><!-- fragment --><p>To clean up the environment we run:</p>
<div class="fragment"><div class="line">kdb rm user/test/config</div><div class="line">kdb rm user/test/password</div><div class="line">kdb rm /sw/elektra/kdb/#0/current/plugins</div><div class="line">sudo kdb umount user/test</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
