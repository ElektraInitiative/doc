<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: REST Service for Sharing of Configuration Snippets</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Elektra
   &#160;<span id="projectnumber">0.9.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">REST Service for Sharing of Configuration Snippets </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial explains how to install, configure and run everything that is required for the Snippet Sharing service and website. As operating system we expect Debian Jessie to be used, although most parts should also be applicable to other systems.</p>
<p>The Snippet Sharing service consists of two parts, a backend (the REST server) and a frontend (an AngularJS application executed in the browser), which also includes the Elektra website. The service itself can be used to share configuration snippets, i.e. configuration files of arbitrary applications.</p>
<p>As first step we need to install some dependencies required by the applications.</p>
<p>The backend requires the most dependencies and unfortunately some of them need to be installed manually because no APT packages are available.</p>
<p>The required dependencies with their own dependencies are:</p>
<ul>
<li>CppCMS &gt;= v1.0.0<ul>
<li>Zlib library</li>
<li>PCRE library</li>
<li>Python &gt;= v2.4 (but not v3)</li>
<li>ICU library &gt;= v3.6</li>
<li>gcrypt or OpenSSL library</li>
</ul>
</li>
<li>Boost &gt;= v1.45</li>
<li>OpenSSL</li>
<li>LibJWT &gt;= v1.5<ul>
<li>Jansson</li>
<li>OpenSSL</li>
</ul>
</li>
</ul>
<p>You'll also need CMake and a modern C/C++ compiler, so in case you don't have them installed already, use <code>apt-get install build-essential cmake</code> to do so.</p>
<p><a class="anchor" id="autotoc_md2767"></a></p><h5>APT Packages</h5>
<p>To install all required APT packages at once, simply run: <code>apt-get install libboost-all-dev libpcre3-dev zlib1g-dev libgcrypt11-dev libicu-dev python libssl-dev</code></p>
<p><a class="anchor" id="autotoc_md2768"></a></p><h5>CppCMS</h5>
<p>To install CppCMS, there are two options available:</p>
<ul>
<li>Download and build from source</li>
<li>Install via dependency manager</li>
</ul>
<p>To install CppCMS manually without dependency manager:</p>
<ul>
<li>Download the (latest) CppCMS source from <a href="https://sourceforge.net/projects/cppcms/files/cppcms/">SourceForge</a></li>
<li>Extract the archive: <code>tar -xjf cppcms-1.x.x.tar.bz2 &amp;&amp; cd cppcms-1.x.x</code> (replace 1.x.x with your version)</li>
<li>Configure the build: <code>mkdir build &amp;&amp; cd build &amp;&amp; cmake ..</code></li>
<li>Execute the build, run tests and install: <code>make &amp;&amp; make test &amp;&amp; make install</code></li>
</ul>
<p>Further build and installation information can be found on their <a href="http://cppcms.com/wikipp/en/page/cppcms_1x_build">website</a>. It contains also a <a href="http://cppcms.com/wikipp/en/page/apt">guide</a> explaining the installation through a dependency manager. Unfortunately, no repository is available for Debian Jessie yet.</p>
<p><a class="anchor" id="autotoc_md2769"></a></p><h5>Jansson</h5>
<p>The Jansson library supports working with JSON data in C. To install it, use the following steps:</p>
<ul>
<li>Download the (latest) source from <a href="http://www.digip.org/jansson/releases/">their website</a></li>
<li>Extract the archive: <code>bunzip2 -c jansson-2.x.tar.bz2 | tar xf - &amp;&amp; cd jansson-2.x</code> (replace 2.x with your version)</li>
<li>Configure the build: <code>mkdir build &amp;&amp; cd build &amp;&amp; cmake ..</code></li>
<li>Execute the build, run tests and install: <code>make &amp;&amp; make check &amp;&amp; make install</code></li>
</ul>
<p><a class="anchor" id="autotoc_md2770"></a></p><h5>LibJWT</h5>
<p>Now we can also install LibJWT:</p>
<ul>
<li>Download the (latest) source from <a href="https://github.com/benmcollins/libjwt/releases">GitHub</a></li>
<li>Extract the archive: <code>tar -xjf v1.x.x &amp;&amp; cd libjwt-1.x.x</code> (replace 1.x.x with your version)</li>
<li>Configure the build: <code>autoreconf -i &amp;&amp; ./configure</code></li>
<li>Execute the build and run tests: <code>make all &amp;&amp; make check</code></li>
</ul>
<p>If you are using Ubuntu, LibJWT can also be installed through a pre-built APT package:</p>
<ul>
<li>Add APT repository: <code>add-apt-repository ppa:ben-collins/libjwt</code></li>
<li>Install via apt-get: <code>apt-get update &amp;&amp; apt-get install libjwt</code></li>
</ul>
<p>The frontend does only require the package manager <a href="https://www.npmjs.com/">npm</a> (&gt;= v3). It is preferred to install it along with <a href="https://nodejs.org/">nodeJS</a>, for example via <a href="https://nodejs.org/en/download/package-manager/">provided packages</a>. The version that comes via Debian Jessie (v1.4) is insufficient. The installation was tested with npm version 3.10.8-9, but it should also work with other versions of 3+.</p>
<p>After installing the dependencies, we are ready to build the applications. To do so, we can follow the steps explained in the <a class="el" href="doc_COMPILE_md.html">build guide</a>. Make sure to include the two tools <code>website-backend</code> and <code>website-frontend</code>, e.g. by using the arguments <code>-DTOOLS="ALL;website-backend;website-frontend"</code>.</p>
<p>After building Elektra and the applications, we can use <code>make install</code> to install them. Further information and troubleshooting can be found in the <a class="el" href="doc_INSTALL_md.html">install guide</a>.</p>
<p>The applications configure themselves as much as possible during build, but some settings have to be set manually afterwards.</p>
<p>After the installation, the configuration specification of the backend has to be mounted with the command <code>kdb mount-website-backend-config</code>. You can check if the mounting was successful by issuing <code>kdb mount</code>. There should be an entry in the list with a path like <code>spec/sw/elektra/restbackend/#0</code> and a similar one without the leading <code>spec</code>. If you do not see this mount points, have a look at the mount script in the tool_exec (which is defined during installation of Elektra). You can also run the commands manually.</p>
<p>To complete the mounting, you also need to ensure that the <code>spec</code> plugin is used as global plugin. If you have not changed anything about the global plugins yet, you can simply use <code>kdb global-mount</code> to ensure that the <code>spec</code> plugin is added as global plugin. If not, you need to add all currently mounted global plugins to the command as they will be deleted otherwise.</p>
<p>After that you need to set an additional configuration parameter that has no default value. It is recommended to set it for the system namespace if you will use a tool like <code>systemctl</code> to manage the services.</p>
<div class="fragment"><div class="line">kdb set -N system /sw/elektra/restbackend/#0/current/backend/jwt/encryption/secret &quot;use a secret key here&quot;</div></div><!-- fragment --><p>To generate a secure key, you can also use <code>pwgen</code> (install via <code>apt-get install pwgen</code>). Use</p>
<div class="fragment"><div class="line">kdb set -N system /sw/elektra/restbackend/#0/current/backend/jwt/encryption/secret &quot;$(pwgen -1cns 30)&quot;</div></div><!-- fragment --><p>to generate and set a strong random encryption secret.</p>
<p>The option <code>-N system</code> for <code>kdb set</code> defines the used namespace (in this case it is <code>system</code>). In order for the configuration specification to work (e.g. validation), we have to use cascading key names. This is why we have to define the namespace by using this option instead of passing it as part of the key name.</p>
<p>If you want to know the default values, you can get a list of used keys with <code>kdb ls /sw/elektra/restbackend/#0</code>. You can then retrieve the configuration value for each key with <code>kdb get &lt;key&gt;</code>, e.g., <code>kdb get /sw/elektra/restbackend/#0/current/backend/jwt/encryption/secret</code></p>
<p>Additionally to the settings above, CppCMS needs some configuration. All configuration options are listed on <a href="http://cppcms.com/wikipp/en/page/cppcms_1x_config">their website</a>. A stand-alone installation of the service (without proxy server) requires following configuration:</p>
<div class="fragment"><div class="line">kdb set -N system /sw/elektra/restbackend/#0/current/cppcms/service/api &quot;http&quot;</div><div class="line">kdb set -N system /sw/elektra/restbackend/#0/current/cppcms/service/ip &quot;0.0.0.0&quot;</div><div class="line">kdb set -N system /sw/elektra/restbackend/#0/current/cppcms/service/port 8080</div><div class="line">kdb set -N system /sw/elektra/restbackend/#0/current/cppcms/http/script_names/#0 &quot;/&quot;</div></div><!-- fragment --><p>Note: here we have not used the option <code>-N system</code> because the CppCMS configuration is not part of the specification. That means it does not get validated.</p>
<p>The frontend does only require small mandatory changes in its configuration. Before they can be made, the configuration file has to be mounted though. This can be achieved by issuing <code>kdb mount-website-frontend-config</code>. The configuration should then be available at <code>system/sw/elektra/restfrontend/#0/current</code>. To get a list of possible configuration parameters, use <code>kdb ls system/sw/elektra/restfrontend/#0/current</code>.</p>
<p>Note that the frontend is not elektrified, only changes within <code>system/sw/elektra/restfrontend/#0/current</code> will work.</p>
<p>The parameters that need to be changed in order for the frontend to work correctly, are:</p>
<ul>
<li><code>system/sw/elektra/restfrontend/#0/current/backend/root</code>: set it to the URL where the backend will be reachable, e.g. <code><a href="http://restapi.libelektra.org/">http://restapi.libelektra.org/</a></code> (with trailing slash!)</li>
<li><code>system/sw/elektra/restfrontend/#0/current/website/url</code>: set it to the URL where the frontend will be reachable, e.g. <code><a href="https://libelektra.org/">https://libelektra.org/</a></code> (with trailing slash!)</li>
</ul>
<p>As last step we need to run the applications:</p>
<ul>
<li>First we start the backend server with <code>kdb run-website-backend</code>. To ensure the backend is accessible, you can use <code>curl <a href="http://localhost:8080/version">http://localhost:8080/version</a></code> (change port to your setting), which should show you some version information in JSON format.</li>
<li>Although the frontend was compiled during installation already, we want to have a freshly built homepage and use <code>kdb build-website-frontend</code> to do so.</li>
<li>Then we run the frontend analogously with <code>kdb run-website-frontend</code>. It should now be reachable at the configured port.</li>
</ul>
<p>If everything went smooth, both applications should now be online and reachable.</p>
<p>Both applications can be stopped with a simple command:</p>
<ul>
<li>Backend: <code>kdb stop-website-backend</code></li>
<li>Frontend: <code>kdb stop-website-frontend</code></li>
</ul>
<p>For the backend a detailed description in the <a href="https://apiblueprint.org/">API blueprint</a> format is available. To compile the blueprint we need the <a href="https://github.com/apiaryio/apiary-client">apiary-client</a> to be installed, which in return is installed as Ruby gem:</p>
<ul>
<li>So we first install Ruby with gem: <code>apt-get install ruby</code></li>
<li>Then we install the apiary-cli: <code>gem install apiaryio</code></li>
<li>Finally we can use <code>apiary preview --path=snippet-sharing.apib --output=snippet-sharing-api.html</code> in the blueprints directory to generate the pretty version of the API description. This file can then be placed wherever it is accessible or needed.</li>
</ul>
<p>In case you change the API description (and the backend), you may want to ensure that your API blueprint is still syntax conform. To do so, you can use the tool <a href="https://github.com/apiaryio/drafter">Drafter</a>. After installing it, you can use <code>drafter &lt;filename&gt;</code> (e.g. <code>drafter snippet-sharing.apib</code>) to run the check.</p>
<p>Of course it is possible to use another webserver instead of the built-in one. To do so, simply run <code>kdb build-website-frontend</code> and copy the content of the <code>/usr/local/share/elektra/tool_data/website-frontend/public</code> directory to your desired target location.</p>
<p>It is required that you set a rewrite rule that serves the <code>index.html</code> for every request that does not access a static file (<code>js</code>, <code>css</code>, <code>png</code>, <code>md</code>, etc.). If you omit this step, it will not be possible to use direct links to access resources of the frontend; accessing the frontend from the <code>index.html</code> will still work though.</p>
<p>The following is a description of the setup we used for the Elektra website reachable at <a href="https://www.libelektra.org">https://www.libelektra.org</a>.</p>
<p>We assume that Elektra is now installed to the default path on Debian Jessie, which is <code>/usr/local</code>.</p>
<p>As web server we use Debian Jessie’s Apache2. Several domains are used for different tasks, whereas only two are relevant for the here described service:</p>
<ul>
<li><code>restapi.libelektra.org</code> for the API provided by the <code>website-backend</code></li>
<li><code>www.libelektra.org</code> for the website and frontend provided by the <code>website-frontend</code></li>
</ul>
<p>The server redirects requests on port 80 (non-SSL) to 443 using a very simple configuration like</p>
<div class="fragment"><div class="line"># file: /etc/apache2/sites-available/www.libelektra.org.conf</div><div class="line">&lt;VirtualHost *:80&gt;</div><div class="line">    ServerName www.libelektra.org</div><div class="line">    Redirect permanent / https://www.libelektra.org/</div><div class="line">&lt;/VirtualHost&gt;</div></div><!-- fragment --><p>for the <code>www.libelektra.org</code> domain (similar for <code>restapi.libelektra.org</code>).</p>
<p>The secured variant of the configuration looks like</p>
<div class="fragment"><div class="line"># file: /etc/apache2/sites-available/www.libelektra.org-le-ssl.conf</div><div class="line">&lt;IfModule mod_ssl.c&gt;</div><div class="line">&lt;VirtualHost *:443&gt;</div><div class="line">    ServerName www.libelektra.org</div><div class="line"></div><div class="line">    DocumentRoot &quot;/usr/local/share/elektra/tool_data/website-frontend/public&quot;</div><div class="line">    &lt;Directory /&gt;</div><div class="line">        FallbackResource /index.html</div><div class="line">        Options Indexes MultiViews</div><div class="line">        AllowOverride None</div><div class="line">        Require all granted</div><div class="line">        Allow from all</div><div class="line">    &lt;/Directory&gt;</div><div class="line"></div><div class="line">    LogLevel info</div><div class="line">        ErrorLog ${APACHE_LOG_DIR}/error.log</div><div class="line">        CustomLog ${APACHE_LOG_DIR}/access.log combined</div><div class="line"></div><div class="line">    SSLCertificateFile /etc/letsencrypt/live/www.libelektra.org/fullchain.pem</div><div class="line">    SSLCertificateKeyFile /etc/letsencrypt/live/www.libelektra.org/privkey.pem</div><div class="line">    Include /etc/letsencrypt/options-ssl-apache.conf</div><div class="line">&lt;/VirtualHost&gt;</div><div class="line">&lt;/IfModule&gt;</div></div><!-- fragment --><p>Important is the <code>Directory</code> configuration because the <code>website-frontend</code> requires the <code>FallbackResource</code> option to function correctly.</p>
<p>For the <code>restapi.libelektra.org</code> domain we use an SCGI setup:</p>
<div class="fragment"><div class="line"># file: /etc/apache2/sites-available/restapi.libelektra.org-le-ssl.conf</div><div class="line">&lt;IfModule mod_ssl.c&gt;</div><div class="line">&lt;VirtualHost *:443&gt;</div><div class="line">    ServerName restapi.libelektra.org</div><div class="line"></div><div class="line">    SCGIMount / 127.0.0.1:8081</div><div class="line"></div><div class="line">    LogLevel info</div><div class="line">        ErrorLog ${APACHE_LOG_DIR}/error.log</div><div class="line">        CustomLog ${APACHE_LOG_DIR}/access.log combined</div><div class="line"></div><div class="line">    SSLCertificateFile /etc/letsencrypt/live/restapi.libelektra.org/fullchain.pem</div><div class="line">    SSLCertificateKeyFile /etc/letsencrypt/live/restapi.libelektra.org/privkey.pem</div><div class="line">    Include /etc/letsencrypt/options-ssl-apache.conf</div><div class="line">&lt;/VirtualHost&gt;</div><div class="line">&lt;/IfModule&gt;</div></div><!-- fragment --><p>The <code>website-backend</code> itself is configured normally as described in the configuration section above, but with CppCMS using SCGI instead of HTTP as API variant. This requires setting the keys</p>
<div class="fragment"><div class="line">kdb set system/sw/elektra/restbackend/#0/current/cppcms/service/api &quot;scgi&quot;</div><div class="line">kdb set system/sw/elektra/restbackend/#0/current/cppcms/service/ip &quot;127.0.0.1&quot;</div><div class="line">kdb set system/sw/elektra/restbackend/#0/current/cppcms/service/port 8081</div></div><!-- fragment --><p>Additionally we are using a worker process, which ensures that in case of a crash the backend restarts automatically (= basically supervisor + worker). Config:</p>
<div class="fragment"><div class="line">kdb set system/sw/elektra/restbackend/#0/current/cppcms/service/worker_processes 1</div></div><!-- fragment --><p>Configuration snippets and users are stored at <code>system/configs</code> and <code>system/users</code>:</p>
<div class="fragment"><div class="line">kdb set system/sw/elektra/restbackend/#0/current/backend/kdb/path/configs = system/configs</div><div class="line">kdb set system/sw/elektra/restbackend/#0/current/backend/kdb/path/users = system/users</div></div><!-- fragment --><p>Because of the Apache server using the website-frontend installation directory as document root, there is no further configuration necessary other than already explained in the configuration section above.</p>
<p>During the build, the frontend will be recompiled. It is not taken offline for this though and everything that is necessary to accomplish a clean deployment is taken care of by the compile script as well.</p>
<p>The build script basically builds the applications, runs tests, installs everything and restarts the backend. Finally, it can run the configuration script for the frontend, which updates the website content.</p>
<p>The current build script can be found here. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
