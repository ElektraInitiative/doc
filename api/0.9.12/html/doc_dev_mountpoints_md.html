<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: New mountpoint config structure</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.9.12</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">New mountpoint config structure </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_dev_mountpoints"></a> A mountpoint is defined by adding keys below <code>system:/elekta/mountpoints/&lt;mountpoint&gt;</code>, where <code>&lt;mountpoint&gt;</code> is the key name for the parent key of the mountpoint with slashes properly escaped. For example for the mountpoint <code>user:/mymountpoint</code> you have to add keys below <code>system:/elekta/mountpoints/user:\/mymountpoint</code>.</p>
<p>Every mountpoint consists of four parts:</p>
<ol type="1">
<li>A set of plugins required for the mountpoint.</li>
<li>A single <em>backend plugin</em> within the set of plugins.</li>
<li>The <em>mountpoint definition</em> specific to the backend plugin.</li>
<li>The <em>mountpoint config</em> available to all plugins of this mountpoint.</li>
</ol>
<p>The set of plugins is defined below <code>system:/elektra/mountpoints/&lt;mountpoint&gt;/plugins</code>. The keys below <code>system:/elektra/mountpoints/&lt;mountpoint&gt;/plugins/&lt;ref&gt;</code> define a single instance of a plugin. The part <code>&lt;ref&gt;</code> will be used as name by which this plugin instance will be referenced later. The name may be arbitrary, but it must not be <code>backend</code>. The name <code>backend</code> is reserved for the backend plugin (see below).</p>
<p>To define a plugin instance, <code>system:/elektra/mountpoints/&lt;mountpoint&gt;/plugins/&lt;ref&gt;/name</code> must be set to the name of the plugin, i.e., it must be possible to open the plugin with <code>elektraPluginOpen</code> via this value. Optionally, the configuration keyset can be defined by the keys below <code>system:/elektra/mountpoints/&lt;mountpoint&gt;/plugins/&lt;ref&gt;/config</code>.</p>
<p>The single <em>backend plugin</em> is the only one that the <code>libelektra-kdb</code> library communicates with. It is responsible for calling other plugins when needed. A <em>backend contract</em> exists between this plugin and <code>libelektra-kdb</code>. The backend plugin alone is responsible for upholding this contract and enforcing it upon other plugins it calls.</p>
<p>The backend plugin is defined (like the other plugins) below <code>system:/elektra/mountpoints/&lt;mountpoint&gt;/plugins</code>. Specifically, it uses <code>backend</code> as <code>&lt;ref&gt;</code> and is therefore defined by the keys below <code>system:/elektra/mountpoints/&lt;mountpoint&gt;/plugins/backend</code>.</p>
<p>The <em>mountpoint definition</em> for the backend plugin is defined by the keys below <code>system:/elektra/mountpoints/&lt;mountpoint&gt;/definition</code>.</p>
<p>The <em>mountpoint config</em> is defined by the keys below <code>system:/elektra/mountpoints/&lt;mountpoint&gt;/config</code>. It is merged into the configuration keyset of every plugin of this mountpoint (including the backend plugin). Specifically, the mountpoint config is put into the <code>user:/</code> namespace, while the config from <code>system:/elektra/mountpoints/&lt;mountpoint&gt;/plugins/&lt;ref&gt;/config</code> is put into the <code>dir:/</code> namespace of the keyset passed to a plugin.</p>
<p>Additionally, the <code>config/needs</code> config from plugins' contract is moved to <code>system:/</code>. This config is not stored in <code>system:/elektra/mountpoints</code> and instead loaded at runtime by <code>libelektra-kdb</code> during the <code>open</code> operation.</p>
<p>This leaves the <code>default:/</code> namespace for plugins to add their own defaults before calling <code>ksLookup</code> to access the config keyset.</p>
<blockquote class="doxtable">
<p><b>Note</b>: This <em>mountpoint definition</em> is separate from the normal configuration keyset passed to a plugin. The backend plugin may still have such a keyset below its <code>system:/elektra/mountpoints/&lt;mountpoint&gt;/plugins/&lt;ref&gt;/config</code> key. The difference between these two keyset is that the configuration keyset should be used to define the general operation of the plugin, while the mountpoint definition should specify a mountpoint.</p>
<p>For example, a backend plugin could support a logging mode, in which it produces a log entry every time it calls another plugin. This should be configured in the configuration keyset not in the mountpoint definition, since it doesn't change how the mountpoint works.</p>
<p>Additionally, the config of a plugin is <em>always</em> processed for <em>all</em> mountpoints, no matter if the mountpoint is actually accessed or the plugin actually used. This is because config is processed during the <code>open</code> operation, which doesn't know what parts of the whole KDB are needed for the current application. The mountpoint definition meanwhile is only processed for the mountpoints that are actually accessed. In this case the processing happens during the first <code>get</code> operation (within an application) that uses this mountpoint. </p>
</blockquote>
<p>All other keys below <code>system:/elektra/mountpoints/&lt;mountpoint&gt;</code> are ignored.</p>
<p>To illustrate this structure, here is an example configuration:</p>
<div class="fragment"><div class="line"># List of plugins with their config</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/resolver/name (=&quot;resolver_fm_hpu_b&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/myglob/name (=&quot;glob&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/myglob/config/set/#0</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/myglob/config/set/#1</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/myglob/config/set/#2</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/myglob/config/set/#3</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/myglob/config/set/#4/flags</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/store/name (=&quot;hosts&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/sync/name (=&quot;sync&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/error/name (=&quot;error&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/network/name (=&quot;network&quot;)</div>
<div class="line"> </div>
<div class="line">## part of the list of plugins, but also defines backend plugin</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/backend/name (=&quot;backend&quot;)</div>
<div class="line"> </div>
<div class="line"># Configuration for backend plugin</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/path (=&quot;myhosts&quot;)</div>
<div class="line"> </div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/get/resolver (=&quot;resolver&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/get/storage (=&quot;store&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/get/poststorage/#0 (=&quot;myglob&quot;)</div>
<div class="line"> </div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/set/resolver (=&quot;resolver&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/set/prestorage/#0 (=&quot;myglob&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/set/prestorage/#1 (=&quot;error&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/set/prestorage/#2 (=&quot;network&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/set/storage (=&quot;store&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/set/precommit/#0 (=&quot;sync&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/set/commit (=&quot;resolver&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/set/rollback (=&quot;resolver&quot;)</div>
<div class="line"> </div>
<div class="line"># Everything else below system:/elektra/mountpoints/\/hosts is ignored</div>
</div><!-- fragment --><p>Explanation:</p>
<ul>
<li>This configures a mountpoint <code>/hosts</code> that loads the plugins <code>resolver_fm_hpu_b</code>, <code>glob</code>, <code>hosts</code>, <code>sync</code>, <code>error</code>, <code>network</code> and <code>backend</code>. The plugin <code>glob</code> also has some configuration keys defined.</li>
<li>The <code>backend</code> plugin is set as the backend plugin.</li>
<li>The rest is the mountpoint definition specific to the <code>backend</code> plugin.</li>
</ul>
<p>As you can see from this example, the "positions" are part of the plugin-specific mountpoint definition. This allows different backend plugins to use different "positions".</p>
<p>For example, there is the <code>version</code> backend plugin that always just provides a few keys with version information for Elektra. It doesn't need to call any other plugins and requires no configuration at all. A mountpoint with this plugin could look like this:</p>
<div class="fragment"><div class="line">system:/elektra/mountpoints/\/version/plugins/backend/name (=&quot;version&quot;)</div>
</div><!-- fragment --><blockquote class="doxtable">
<p><b>Note</b>: The above example, is also the minimal setup for a mountpoint. The key <code>system:/elektra/mountpoints/&lt;mountpoint&gt;/plugins/backend/name</code> is the only one that must be defined. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md2660"></a>
Operations and Phases</h1>
<p>See KDB Operations Documentation for a description of operations and phases.</p>
<p>In each of the phases of a <code>get</code> or <code>set</code> operation, the corresponding function of the backend plugin is called. For a description of how this works exactly read the Backend Plugins Documentation.</p>
<p>In the first example above, the phases were mapped one-to-one to what the plugin <code>backend</code> called "positions". The different terms are very much intentional, since this not a requirement.</p>
<h1><a class="anchor" id="autotoc_md2661"></a>
Further Examples</h1>
<p>We already had two examples above. Here we will look at a few more.</p>
<div class="fragment"><div class="line"># List of plugins with their config</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/resolver/name (=&quot;resolver_fm_hpu_b&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/glob/name (=&quot;glob&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/glob/config/set/#0</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/glob/config/set/#1</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/glob/config/set/#2</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/glob/config/set/#3</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/glob/config/set/#4/flags</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/hosts/name (=&quot;hosts&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/sync/name (=&quot;sync&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/network/name (=&quot;network&quot;)</div>
<div class="line"> </div>
<div class="line"># Define backend plugin</div>
<div class="line">system:/elektra/mountpoints/\/hosts/backend/name (=&quot;other_backend&quot;)</div>
<div class="line"> </div>
<div class="line"># Configuration for backend plugin</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/path (=&quot;myhosts&quot;)</div>
<div class="line"> </div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/get/resolver = (=&quot;resolver&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/get/storage = (=&quot;hosts&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/get/validation/#0 (=&quot;glob&quot;)</div>
<div class="line"> </div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/set/resolver = (=&quot;resolver&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/set/validation/#0 = (=&quot;glob&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/set/validation/#1 = (=&quot;network&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/set/storage = (=&quot;hosts&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/set/precommit/#0 = (=&quot;sync&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/set/commit = (=&quot;resolver&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/positions/set/rollback (=&quot;resolver&quot;)</div>
</div><!-- fragment --><p>This example is very similar to the first one, but the plugin <code>other_backend</code> doesn't use the <code>postorage</code> and <code>prestorage</code> "positions". Instead, there is a <code>validation</code> position that is (presumably) called in the appropriate phase. The plugin <code>other_backend</code> may also impose its own restrictions on plugins configured for the <code>validation</code> position. For example, it may define that such plugins must not generate, remove or modify keys and provide a different position for plugins that do so.</p>
<div class="fragment"><div class="line">system:/elektra/mountpoints/\/hosts/plugins/network/name (=&quot;network&quot;)</div>
<div class="line"> </div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/backend/name (=&quot;db_backend&quot;)</div>
<div class="line"> </div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/db/driver (=&quot;postgres&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/db/server (=&quot;127.0.0.1&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/db/port (=&quot;5432&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/db/user (=&quot;admin&quot;)</div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/db/password (=&quot;supersecret&quot;)</div>
<div class="line"> </div>
<div class="line">system:/elektra/mountpoints/\/hosts/definition/phases/set/prestorage/#0 (=&quot;network&quot;)</div>
</div><!-- fragment --><p>This example shows an entirely different type of backend. The hypothetical <code>db_backend</code> is backed by a database. In this case it is configured for a PostgreSQL database running on <code>127.0.0.1:5432</code> to which we connect as user <code>admin</code>.</p>
<p>We also configured the <code>network</code> plugin to run in the <code>prestorage</code> phase of the <code>set</code> operation. Which phases can be used and how they must be configured of course depends on <code>db_backend</code>.</p>
<div class="fragment"><div class="line">system:/elektra/mountpoints/\/hosts/plugins/yajl/name (=&quot;yajl&quot;)</div>
<div class="line"> </div>
<div class="line">system:/elektra/mountpoints/\/hosts/plugins/backend/name (=&quot;http_backend&quot;)</div>
<div class="line"> </div>
<div class="line">system:/elektra/mountpoints/\/hosts/url (=&quot;https://api.ipify.org/?format=JSON&quot;)</div>
<div class="line"> </div>
<div class="line">system:/elektra/mountpoints/\/hosts/decoder (=&quot;yajl&quot;)</div>
</div><!-- fragment --><p>The hypothetical <code>http_backend</code> plugin is a read-only backend plugin. In the example above, it is configured to load the URL <code><a href="https://api.ipify.org/?format=JSON">https://api.ipify.org/?format=JSON</a></code> and use the <code>yajl</code> plugin to parse the result into a keyset. Both the HTTP request and the decoding would likely happen in the <code>storage</code> phase of the <code>get</code> operation. The <code>resolver</code> phase could perform an HTTP cache check, for example. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
