<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Plugin: quickdump</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.9.14</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Plugin: quickdump </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>infos = Information about the quickdump plugin is in keys below</li>
<li>infos/author = Klemens BÃ¶swirth <a href="#" onclick="location.href='mai'+'lto:'+'k.b'+'oe'+'swi'+'rt'+'h+g'+'it'+'@gm'+'ai'+'l.c'+'om'; return false;">k.boe<span style="display: none;">.nosp@m.</span>swir<span style="display: none;">.nosp@m.</span>th+gi<span style="display: none;">.nosp@m.</span>t@gm<span style="display: none;">.nosp@m.</span>ail.c<span style="display: none;">.nosp@m.</span>om</a></li>
<li>infos/licence = BSD</li>
<li>infos/needs =</li>
<li>infos/provides = storage/quickdump</li>
<li>infos/recommends =</li>
<li>infos/placements = getstorage setstorage</li>
<li>infos/status = maintained compatible tested nodep libc preview</li>
<li>infos/metadata =</li>
<li>infos/description = much quicker version of dump (2x or more in most cases)</li>
</ul>
<h1><a class="anchor" id="src_plugins_quickdump_README_md"></a>
Introduction</h1>
<p><code>quickdump</code> is a storage plugin based on the <code>dump</code> format. It is a lot quicker (see <a class="el" href="md_src_plugins_quickdump_benchmarks.html#src_plugins_quickdump_benchmarks_md">benchmarks.md</a>) than the old <code>dump</code> plugin, because it does not use commands and stores string lengths as binary data. Through these changes all string comparisons and integer-string conversions can be eliminated, which made up for a lot of the time spent by the <code>dump</code> plugin.</p>
<p>The format is also useful for IPC and streaming, because of this it is used by the <code>specload</code> plugin.</p>
<h1><a class="anchor" id="autotoc_md439"></a>
Format</h1>
<p>A <code>quickdump</code> file starts with the magic number <code>0x454b444200000003</code>. The first 4 bytes are the ASCII codes for <code>EKDB</code> (for Elektra KDB), followed by a version number. This 64-bit is always stored as big-endian (i.e. the way it is written above).</p>
<p>After the magic number the file is just a list of Keys. Each Key consists of a name, a value and any number of metakey names and values. Each name and value is written as a 64-bit length <code>n</code> followed by exactly <code>n</code> bytes of data. For strings we do not store a null terminator. Therefore the length also does not account for that. When reading a string, the plugin allocates <code>n+1</code> bytes and sets the last one to <code>0</code>. Note that ALL lengths are stored in little-endian format, because most modern machines are little-endian. To save disk space, we use a variable length encoding for integers. The exact format is described below.</p>
<p>We don't store the full name of the key. Instead we only store the name relative to the parent key.</p>
<p>The end of a key is marked by a null byte. This cannot be confused with null bytes embedded in binary key values, because of the length prefixes before each key and metavalue.</p>
<p>To distinguish between binary and string keys the (length of the) key value is prefixed with either a <code>b</code> or an <code>s</code>. Each metakey is prefixed with an <code>m</code>, unless we detect that the same metakey was already present on a previous key (e.g. through <code>keyCopyMeta</code>). In this case the prefix <code>c</code> is used and instead of the metakey name and value, we write the name of the previous key and the metakey name.</p>
<h2><a class="anchor" id="autotoc_md440"></a>
Variable Length Integer encoding</h2>
<p>The basic idea of the format is to store integers in base 128. This means we only use 7 bits per byte and the 8th bit (marker bit) indicates whether or not there are more bytes to read. However, to make things more efficient we move all those marker bits to the first byte. Then we can read one byte and immediately know, how much bytes follow. This is similar to what UTF-8 does.</p>
<p>The table below shows how the encoding works. The first byte is shown in full (<code>x</code> is either <code>0</code> or <code>1</code>), then <code>[n]</code> indicates that <code>n</code> bytes of data follow.</p>
<div class="fragment"><div class="line">xxxxxxx1     up to  7 bits in 1 byte</div>
<div class="line">xxxxxx10 [1] up to 14 bits in 2 bytes</div>
<div class="line">xxxxx100 [2] up to 21 bits in 3 bytes</div>
<div class="line">xxxx1000 [3] up to 28 bits in 4 bytes</div>
<div class="line">xxx10000 [4] up to 35 bits in 5 bytes</div>
<div class="line">xx100000 [5] up to 42 bits in 6 bytes</div>
<div class="line">x1000000 [6] up to 49 bits in 7 bytes</div>
<div class="line">10000000 [7] up to 56 bits in 8 bytes</div>
<div class="line">00000000 [8] up to 64 bits in 9 bytes</div>
</div><!-- fragment --><p>Thanks to <a href="https://github.com/stoklund/varint">https://github.com/stoklund/varint</a> for listing various integer encodings.</p>
<h1><a class="anchor" id="autotoc_md441"></a>
Usage</h1>
<p>Like any other storage plugin, you simply use <code>quickdump</code> during mounting, import or export.</p>
<div class="fragment"><div class="line">sudo kdb mount quickdump.eqd user:/tests/quickdump quickdump</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md442"></a>
Dependencies</h1>
<p>None.</p>
<h1><a class="anchor" id="autotoc_md443"></a>
Examples</h1>
<div class="fragment"><div class="line"># Mount a backend using quickdump</div>
<div class="line">sudo kdb mount quickdump.eqd user:/tests/quickdump quickdump</div>
<div class="line"># RET: 0</div>
<div class="line"> </div>
<div class="line"># Set some keys and metakeys</div>
<div class="line">kdb set user:/tests/quickdump/key value</div>
<div class="line">#&gt; Create a new key user:/tests/quickdump/key with string &quot;value&quot;</div>
<div class="line"> </div>
<div class="line">kdb meta-set user:/tests/quickdump/key meta &quot;metavalue&quot;</div>
<div class="line"> </div>
<div class="line">kdb set user:/tests/quickdump/otherkey &quot;other value&quot;</div>
<div class="line">#&gt; Create a new key user:/tests/quickdump/otherkey with string &quot;other value&quot;</div>
<div class="line"> </div>
<div class="line"># Show resulting file (not part of test, because xxd is not available everywhere)</div>
<div class="line"># xxd $(kdb file user:/tests/quickdump/key)</div>
<div class="line"># 00000000: 454b 4442 0000 0003 076b 6579 730b 7661  EKDB.....keys.va</div>
<div class="line"># 00000010: 6c75 656d 096d 6574 6113 6d65 7461 7661  luem.meta.metava</div>
<div class="line"># 00000020: 6c75 6500 116f 7468 6572 6b65 7973 176f  lue..otherkeys.o</div>
<div class="line"># 00000030: 7468 6572 2076 616c 7565 00              ther value.</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"># Change mounted file (in a very stupid way to enable shell-recorder testing):</div>
<div class="line">cp $(kdb file user:/tests/quickdump/key) a.tmp</div>
<div class="line"> </div>
<div class="line"># 1. change key from &#39;value&#39; to &#39;other value&#39;</div>
<div class="line">(head -c 13 a.tmp; printf &quot;%bother value&quot; &#39;\0027&#39;; tail -c 40 a.tmp) &gt; b.tmp</div>
<div class="line"> </div>
<div class="line">rm a.tmp</div>
<div class="line"> </div>
<div class="line"># 2. add copy metadata instruction to otherkey</div>
<div class="line">(head -c 64 b.tmp; printf &quot;c%bkey%bmeta\0&quot; &#39;\0007&#39; &#39;\0011&#39;) &gt; c.tmp</div>
<div class="line"> </div>
<div class="line">rm b.tmp</div>
<div class="line"> </div>
<div class="line"># test file name, so KDB isn&#39;t destroyed if mounting failed</div>
<div class="line">[ &quot;x$(kdb file user:/tests/quickdump/key)&quot; != &quot;x$(kdb file user:/)&quot; ] &amp;&amp; mv c.tmp $(kdb file user:/tests/quickdump/key)</div>
<div class="line"> </div>
<div class="line">kdb get user:/tests/quickdump/key</div>
<div class="line">#&gt; other value</div>
<div class="line"> </div>
<div class="line">kdb meta-get user:/tests/quickdump/key meta</div>
<div class="line">#&gt; metavalue</div>
<div class="line"> </div>
<div class="line">kdb get user:/tests/quickdump/otherkey</div>
<div class="line">#&gt; other value</div>
<div class="line"> </div>
<div class="line">kdb meta-get user:/tests/quickdump/otherkey meta</div>
<div class="line">#&gt; metavalue</div>
<div class="line"> </div>
<div class="line"># Cleanup</div>
<div class="line">kdb rm -r user:/tests/quickdump</div>
<div class="line">sudo kdb umount user:/tests/quickdump</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md444"></a>
Limitations</h1>
<p>None. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
