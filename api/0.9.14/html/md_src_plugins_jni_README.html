<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Plugin: jni</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.9.14</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Plugin: jni </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>infos = Information about the jni plugin is in keys below</li>
<li>infos/author = Markus Raab <a href="#" onclick="location.href='mai'+'lto:'+'ele'+'kt'+'ra@'+'li'+'bel'+'ek'+'tra'+'.o'+'rg'; return false;">elekt<span style="display: none;">.nosp@m.</span>ra@l<span style="display: none;">.nosp@m.</span>ibele<span style="display: none;">.nosp@m.</span>ktra<span style="display: none;">.nosp@m.</span>.org</a></li>
<li>infos/licence = BSD</li>
<li>infos/provides =</li>
<li>infos/needs =</li>
<li>infos/placements = getstorage setstorage</li>
<li>infos/status = maintained unittest configurable global memleak experimental</li>
<li>infos/description = generic Java plugin</li>
</ul>
<h1><a class="anchor" id="src_plugins_jni_README_md"></a>
Introduction</h1>
<p>Allows you to write plugins in Java.</p>
<p>This plugin needs the JNA bindings to work. Furthermore, it requires Java 11 or later.</p>
<p>While the plugin internally uses JNI (thus the name), the Java binding for your Java plugin may use something different, e.g. JNA. The requirements for the Java bindings are:</p>
<ul>
<li>needs to have the classes <code>elektra/Key</code> and <code>elektra/KeySet</code> with<ul>
<li>a constructor that takes a C-Pointer as long (J)</li>
<li>a method "release" that gives up ownership (set internal pointer to NULL)</li>
</ul>
</li>
</ul>
<p>The Java plugin itself needs to have the following methods:</p>
<ul>
<li>constructor without arguments (i.e. default constructor)</li>
<li>open with argument <code>elektra/KeySet</code> (the plugin's conf) and <code>elektra/Key</code></li>
<li>close with argument <code>elektra/Key</code></li>
<li>get with arguments <code>elektra/KeySet</code> and <code>elektra/Key</code></li>
<li>set with arguments <code>elektra/KeySet</code> and <code>elektra/Key</code></li>
<li>error with arguments <code>elektra/KeySet</code> and <code>elektra/Key</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md284"></a>
Installation</h1>
<p>See <a class="el" href="doc_INSTALL_md.html">installation</a>. The package is called <code>libelektra5-java</code>. To actually mount plugins, you will additionally need <code>java-elektra</code>. Furthermore, at least JNA version 5.5 is required.</p>
<h1><a class="anchor" id="autotoc_md285"></a>
Plugin Config</h1>
<p>You need to pass :</p>
<ul>
<li>classname the classname to use as plugin, e.g. <code>elektra/plugin/Echo</code></li>
<li>classpath the classpath where to find JNA, the package elektra and other classes needed</li>
</ul>
<p>Additionally, you can set:</p>
<ul>
<li>option allows you to pass an option to the jvm, default: <code>-verbose:gc,class,jni</code></li>
<li>ignore allows you to ignore broken options, default: <code>false</code></li>
<li>print allows you to print java exceptions for debugging purposes</li>
</ul>
<p>If Elektra and a recent jna.jar (adapt path below) is already installed, following should output some debug logs and this README:</p>
<div class="fragment"><div class="line">kdb plugin-info -c classname=org/libelektra/plugin/Echo,classpath=.:/usr/share/java/jna.jar:/usr/share/java/libelektra.jar,print= jni</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>Note: The Java implementation of the plugin can request any other additional plugin configuration, read about it in the end of the output of plugin-info. Plugins dynamically append text after the end of this page. </p>
</blockquote>
<p>You can also mount plugins (see <a href="https://issues.libelektra.org/3881">open issues</a>):</p>
<div class="fragment"><div class="line">kdb mount -c classname=org/libelektra/plugin/PropertiesStorage,classpath=.:/usr/share/java/jna.jar:/usr/share/java/libelektra.jar,print= file.properties /jni jni classname=org/libelektra/plugin/PropertiesStorage,classpath=.:/usr/share/java/jna.jar:/usr/share/java/libelektra.jar,print=</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md286"></a>
Compiling</h1>
<p>If you do not want to use pre-compiled versions, you can compile the plugin yourself. Start by enabling the plugin using (<code>ALL;-EXPERIMENTAL</code> is default):</p>
<div class="fragment"><div class="line">cmake -DPLUGINS=&quot;ALL;-EXPERIMENTAL;jni&quot; /path/to/libelektra</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md287"></a>
on Debian 10 / Ubuntu 20.04 LTS</h2>
<p>Install package <code>openjdk-11-jdk</code> and make sure that no older Java versions are present in <code>/usr/lib/jvm</code>.</p>
<p>If you have manually installed Java, you might get errors related to <code>Could NOT find JNI</code> during <code>cmake</code>. In this case, please consider setting your <code>JAVA_HOME</code> environment variable accordingly.</p>
<h2><a class="anchor" id="autotoc_md288"></a>
on macOS</h2>
<p>Older macOS include an old apple specific version of Java, based on 1.6. However, for the jni plugin JDK version 11 is required, so either the openjdk or the oracle jdk has to be installed.</p>
<p>For example, install oracle's jdk11 via their provided installer. After that, you have to set the JAVA_HOME environment variable to the folder where the jdk is installed, usually like</p>
<div class="fragment"><div class="line">export JAVA_HOME=&quot;/Library/Java/JavaVirtualMachines/jdk-11.jdk/Contents/Home/&quot;</div>
</div><!-- fragment --><p>As macOS handles linked libraries differently, there is no ldconfig command. Instead you can export an environment variable to tell Elektra the location of Java's dynamic libraries.</p>
<div class="fragment"><div class="line">export DYLD_FALLBACK_LIBRARY_PATH=&quot;/Library/Java/JavaVirtualMachines/jdk-11.jdk/Contents/Home/jre/lib:/Library/Java/JavaVirtualMachines/jdk-11.jdk/Contents/Home/jre/lib/server/&quot;</div>
</div><!-- fragment --><p>Afterwards, the jni plugin should be included in the build and compile successfully.</p>
<h2><a class="anchor" id="autotoc_md289"></a>
Running the JNI test</h2>
<p>Make sure to run the test after compiling the plugin. Change to your Elektra's build folder and execute the following command for running the JNI plugin test and verify it works:</p>
<div class="fragment"><div class="line">ctest -V -R testmod_jni</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md290"></a>
Troubleshooting</h2>
<p>If it should still not find the correct jni version, or says the jni version is not 11, then it most likely still searches in the wrong directory for the jni header file. It has been experienced that if the project has been built already without this environment variable set, the Java location is cached. As a result, it will be resolved wrong in future builds, even though the environment variable is set. To resolve this, it should be enough to delete the CMakeCache.txt file in the build directory and reconfigure the build.</p>
<h1><a class="anchor" id="autotoc_md291"></a>
Development</h1>
<p>To know how the methods of your class are called, use:</p>
<div class="fragment"><div class="line">javap -s YourClass</div>
</div><!-- fragment --><p>Also explained <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/types.html#wp15773">here</a></p>
<p><a href="https://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/functions.html">JNI Functions</a> <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/invocation.html">Invocation</a></p>
<h1><a class="anchor" id="autotoc_md292"></a>
Open Issues</h1>
<ul>
<li>Only a single Java plugin can be loaded</li>
<li>Java plugins cannot be used from an Java application</li>
<li>If this plugin is enabled, valgrind detects memory problems even if the plugin is not mounted. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
