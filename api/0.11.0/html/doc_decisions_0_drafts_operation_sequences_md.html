<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Operation sequences</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.11.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Operation sequences </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_decisions_0_drafts_operation_sequences"></a> </p>
<h1><a class="anchor" id="autotoc_md1800"></a>
Problem</h1>
<p>The current public API allows various kind of sequences of <code>kdbGet</code> and <code>kdbSet</code> calls. There is no real guideline of allowed and/or prohibited sequences, other than <code>kdbGet</code> for a certain parent key must be called before <code>kdbSet</code>:</p>
<ul>
<li>initially after <code>kdbOpen</code></li>
<li>after conflict errors in <code>kdbSet</code></li>
</ul>
<p>We discovered that some sequences are currently legal but problematic for change tracking and maybe also other use cases.</p>
<p>Currently, notification plugins assume that a <code>kdbSet</code> operation for a certain parent key always directly follows the <code>kdbGet</code> operation for that same key. However, this is not enforced in any way within Elektra, nor is it documented that it should.</p>
<p>In applications, <code>kdbGet</code> and <code>kdbSet</code> of different parent keys might be interwoven in any way. This is problematic, as plugins may store the result of <code>kdbGet</code> and use the stored data in the following <code>kdbSet</code> to calculate a changeset. Plugins have to do this, as there isn't any other Elektra-provided mechanism currently to do change tracking for them.</p>
<p>Note, that erroneous behavior only occurs if plugins are used globally, i.e. as <code>notification-send</code> hook plugins. If they are mounted for specific backends (via <code>kdb mount</code>), this behavior will not occur as plugins from different backends are isolated.</p>
<h2><a class="anchor" id="autotoc_md1801"></a>
Reproducible Example</h2>
<p>The following example will demonstrate the problematic sequence as real, runnable code. This example will show the erroneous behavior for the <code>dbus</code> and <code>logchange</code> plugins, if used as <code>notification-send</code> hooks. These both plugins just serve as a general demonstration, and there may be more plugins that do change tracking this way.</p>
<p>First, run some setup steps:</p>
<div class="fragment"><div class="line"># enable the dbus plugin as a notification-send hook</div>
<div class="line">kdb set system:/elektra/hook/notification/send/plugins/#0 dbus</div>
<div class="line"> </div>
<div class="line"># enable the logchange plugin as a notification-send hook</div>
<div class="line">kdb set system:/elektra/hook/notification/send/plugins/#1 logchange</div>
<div class="line"> </div>
<div class="line"># mount user:/a and user:/b as two backends</div>
<div class="line">kdb mount a.ecf user:/a</div>
<div class="line">kdb mount b.ecf user:/b</div>
<div class="line"> </div>
<div class="line"># populate user:/a and user:/b with values</div>
<div class="line">kdb set user:/a/brightness 1</div>
<div class="line">kdb set user:/a/saturation 1</div>
<div class="line">kdb set user:/b/foreground 1</div>
<div class="line">kdb set user:/b/background 1</div>
</div><!-- fragment --><p>Then, run the following command to monitor the notifications by the <code>dbus</code> plugins:</p>
<div class="fragment"><div class="line">dbus-monitor --session type=&#39;signal&#39;,interface=&#39;org.libelektra&#39;</div>
</div><!-- fragment --><p>Finally, execute the following program:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;kdb.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="testio__doc_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a> (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">        Key * root = <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (<span class="stringliteral">&quot;/&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>);</div>
<div class="line">        KDB * handle = <a class="code" href="group__kdb.html#ga844e1299a84c3fbf1d3a905c5c893ba5">kdbOpen</a> (NULL, root);</div>
<div class="line"> </div>
<div class="line">        Key * keyA = <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (<span class="stringliteral">&quot;user:/a&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>);</div>
<div class="line">        Key * keyB = <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (<span class="stringliteral">&quot;user:/b&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>);</div>
<div class="line"> </div>
<div class="line">        KeySet * a = <a class="code" href="group__keyset.html#ga671e1aaee3ae9dc13b4834a4ddbd2c3c">ksNew</a> (0, <a class="code" href="group__keyset.html#ga7a28fce3773b2c873c94ac80b8b4cd54">KS_END</a>);</div>
<div class="line">        KeySet * b = <a class="code" href="group__keyset.html#ga671e1aaee3ae9dc13b4834a4ddbd2c3c">ksNew</a> (0, <a class="code" href="group__keyset.html#ga7a28fce3773b2c873c94ac80b8b4cd54">KS_END</a>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a> (handle, a, keyA);  <span class="comment">// (A)</span></div>
<div class="line">        <a class="code" href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a> (handle, b, keyB);  <span class="comment">// (B)</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// we need to change *something*, otherwise the backend would assume nothing changed</span></div>
<div class="line">        <span class="comment">// and never even execute all of kdbSet</span></div>
<div class="line">        <a class="code" href="group__keyset.html#gaa5a1d467a4d71041edce68ea7748ce45">ksAppendKey</a> (a, <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (<span class="stringliteral">&quot;user:/a/test&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8ac66e4a49d09212b79f5754ca6db5bd2e">KEY_VALUE</a>, <span class="stringliteral">&quot;hi&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>));</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="group__kdb.html#ga11436b058408f83d303ca5e996832bcf">kdbSet</a> (handle, a, keyA);  <span class="comment">// (C)</span></div>
<div class="line"> </div>
<div class="line">        <a class="code" href="group__keyset.html#ga27e5c16473b02a422238c8d970db7ac8">ksDel</a> (a);</div>
<div class="line">        <a class="code" href="group__keyset.html#ga27e5c16473b02a422238c8d970db7ac8">ksDel</a> (b);</div>
<div class="line">        <a class="code" href="group__key.html#ga3df95bbc2494e3e6703ece5639be5bb1">keyDel</a> (keyA);</div>
<div class="line">        <a class="code" href="group__key.html#ga3df95bbc2494e3e6703ece5639be5bb1">keyDel</a> (keyB);</div>
<div class="line">        <a class="code" href="group__key.html#ga3df95bbc2494e3e6703ece5639be5bb1">keyDel</a> (root);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="group__kdb.html#gadb54dc9fda17ee07deb9444df745c96f">kdbClose</a> (handle, 0);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__kdb_html_ga11436b058408f83d303ca5e996832bcf"><div class="ttname"><a href="group__kdb.html#ga11436b058408f83d303ca5e996832bcf">kdbSet</a></div><div class="ttdeci">int kdbSet(KDB *handle, KeySet *ks, Key *parentKey)</div><div class="ttdoc">Set Keys to the Key database in an atomic and universal way.</div><div class="ttdef"><b>Definition:</b> kdb.c:2343</div></div>
<div class="ttc" id="agroup__kdb_html_ga28e385fd9cb7ccfe0b2f1ed2f62453a1"><div class="ttname"><a href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a></div><div class="ttdeci">int kdbGet(KDB *handle, KeySet *ks, Key *parentKey)</div><div class="ttdoc">Retrieve Keys from the Key database in an atomic and universal way.</div><div class="ttdef"><b>Definition:</b> kdb.c:1734</div></div>
<div class="ttc" id="agroup__kdb_html_ga844e1299a84c3fbf1d3a905c5c893ba5"><div class="ttname"><a href="group__kdb.html#ga844e1299a84c3fbf1d3a905c5c893ba5">kdbOpen</a></div><div class="ttdeci">KDB * kdbOpen(const KeySet *contract, Key *errorKey)</div><div class="ttdoc">Opens the session with the Key database.</div><div class="ttdef"><b>Definition:</b> kdb.c:967</div></div>
<div class="ttc" id="agroup__kdb_html_gadb54dc9fda17ee07deb9444df745c96f"><div class="ttname"><a href="group__kdb.html#gadb54dc9fda17ee07deb9444df745c96f">kdbClose</a></div><div class="ttdeci">int kdbClose(KDB *handle, Key *errorKey)</div><div class="ttdoc">Closes the session with the Key database.</div><div class="ttdef"><b>Definition:</b> kdb.c:1105</div></div>
<div class="ttc" id="agroup__key_html_ga3df95bbc2494e3e6703ece5639be5bb1"><div class="ttname"><a href="group__key.html#ga3df95bbc2494e3e6703ece5639be5bb1">keyDel</a></div><div class="ttdeci">int keyDel(Key *key)</div><div class="ttdoc">A destructor for Key objects.</div><div class="ttdef"><b>Definition:</b> key.c:459</div></div>
<div class="ttc" id="agroup__key_html_gad23c65b44bf48d773759e1f9a4d43b89"><div class="ttname"><a href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a></div><div class="ttdeci">Key * keyNew(const char *name,...)</div><div class="ttdoc">A practical way to fully create a Key object in one step.</div><div class="ttdef"><b>Definition:</b> key.c:144</div></div>
<div class="ttc" id="agroup__key_html_gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403"><div class="ttname"><a href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a></div><div class="ttdeci">@ KEY_END</div><div class="ttdef"><b>Definition:</b> kdbenum.c:95</div></div>
<div class="ttc" id="agroup__key_html_gga9b703ca49f48b482def322b77d3e6bc8ac66e4a49d09212b79f5754ca6db5bd2e"><div class="ttname"><a href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8ac66e4a49d09212b79f5754ca6db5bd2e">KEY_VALUE</a></div><div class="ttdeci">@ KEY_VALUE</div><div class="ttdef"><b>Definition:</b> kdbenum.c:88</div></div>
<div class="ttc" id="agroup__keyset_html_ga27e5c16473b02a422238c8d970db7ac8"><div class="ttname"><a href="group__keyset.html#ga27e5c16473b02a422238c8d970db7ac8">ksDel</a></div><div class="ttdeci">int ksDel(KeySet *ks)</div><div class="ttdoc">A destructor for KeySet objects.</div><div class="ttdef"><b>Definition:</b> keyset.c:521</div></div>
<div class="ttc" id="agroup__keyset_html_ga671e1aaee3ae9dc13b4834a4ddbd2c3c"><div class="ttname"><a href="group__keyset.html#ga671e1aaee3ae9dc13b4834a4ddbd2c3c">ksNew</a></div><div class="ttdeci">KeySet * ksNew(size_t alloc,...)</div><div class="ttdoc">Allocate, initialize and return a new KeySet object.</div><div class="ttdef"><b>Definition:</b> keyset.c:282</div></div>
<div class="ttc" id="agroup__keyset_html_ga7a28fce3773b2c873c94ac80b8b4cd54"><div class="ttname"><a href="group__keyset.html#ga7a28fce3773b2c873c94ac80b8b4cd54">KS_END</a></div><div class="ttdeci">#define KS_END</div><div class="ttdoc">End of a list of keys.</div><div class="ttdef"><b>Definition:</b> kdbenum.c:156</div></div>
<div class="ttc" id="agroup__keyset_html_gaa5a1d467a4d71041edce68ea7748ce45"><div class="ttname"><a href="group__keyset.html#gaa5a1d467a4d71041edce68ea7748ce45">ksAppendKey</a></div><div class="ttdeci">ssize_t ksAppendKey(KeySet *ks, Key *toAppend)</div><div class="ttdoc">Appends a Key to the end of ks.</div><div class="ttdef"><b>Definition:</b> keyset.c:968</div></div>
<div class="ttc" id="atestio__doc_8c_html_a3c04138a5bfe5d72780bb7e82a18e627"><div class="ttname"><a href="testio__doc_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a></div><div class="ttdeci">int main(int argc, char **argv)</div><div class="ttdoc">[kdbio testsuite main]</div><div class="ttdef"><b>Definition:</b> testio_doc.c:48</div></div>
</div><!-- fragment --><ul>
<li>At point <code>(A)</code> the plugins internally store the data below the parent <code>keyA</code>.</li>
<li>At point <code>(B)</code> the same thing happens for the data below the parent <code>keyB</code>. This <b>replaces</b> the data from <code>(A)</code>.</li>
<li>At point <code>(C)</code> plugins that do change tracking need to generate a changeset. The changeset will be calculated between the stored data and the new data in the KeySet <code>a</code>. Because the stored data is now from <code>(B)</code> and <b>not</b> from <code>(A)</code>, this changeset will be wrong. The calculation will wrongly assume everything in KeySet <code>b</code> was removed and everything in KeySet <code>a</code> is newly added.</li>
</ul>
<p>Right after <code>(B)</code>, the two keysets are filled with the following values:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone"><code>a</code>   </th><th class="markdownTableHeadNone"><code>b</code>    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>user:/a/brightness</code>   </td><td class="markdownTableBodyNone"><code>user:/b/background</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>user:/a/saturation</code>   </td><td class="markdownTableBodyNone"><code>user:/b/foreground</code>   </td></tr>
</table>
<p>If a plugin calculates a changeset during <code>kdbSet</code> by comparing to the <code>KeySet</code> from the last <code>kdbGet</code> (as described above), the plugin will wrongly calculate the following changeset at <code>(C)</code>:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Added Keys   </th><th class="markdownTableHeadNone">Removed Keys   </th><th class="markdownTableHeadNone">Modified Keys    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>user:/a/brightness</code>   </td><td class="markdownTableBodyNone"><code>user:/b/background</code>   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>user:/a/saturation</code>   </td><td class="markdownTableBodyNone"><code>user:/b/foreground</code>   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>user:/a/test</code>   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td></tr>
</table>
<p>This is obviously wrong. Looking at the example above, the changeset should only contain <code>user:/a/test</code>, as nothing else has been changed in keyset <code>a</code>. So the correct changeset should look like:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Added Keys   </th><th class="markdownTableHeadNone">Removed Keys   </th><th class="markdownTableHeadNone">Modified Keys    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>user:/a/test</code>   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td></tr>
</table>
<p>The erroneous behavior can be noticed by the output of <code>dbus-monitor</code>:</p>
<div class="fragment"><div class="line">signal time=1666993066.749997 sender=:1.364 -&gt; destination=(null destination) serial=2 path=/org/libelektra/configuration; interface=org.libelektra; member=KeyAdded</div>
<div class="line">   string &quot;user:/a/brightness&quot;</div>
<div class="line">signal time=1666993066.750161 sender=:1.364 -&gt; destination=(null destination) serial=3 path=/org/libelektra/configuration; interface=org.libelektra; member=KeyAdded</div>
<div class="line">   string &quot;user:/a/saturation&quot;</div>
<div class="line">signal time=1666993066.750551 sender=:1.364 -&gt; destination=(null destination) serial=4 path=/org/libelektra/configuration; interface=org.libelektra; member=KeyAdded</div>
<div class="line">   string &quot;user:/a/test&quot;</div>
<div class="line">signal time=1666993066.750628 sender=:1.364 -&gt; destination=(null destination) serial=5 path=/org/libelektra/configuration; interface=org.libelektra; member=KeyDeleted</div>
<div class="line">   string &quot;user:/b/background&quot;</div>
<div class="line">signal time=1666993066.750866 sender=:1.364 -&gt; destination=(null destination) serial=6 path=/org/libelektra/configuration; interface=org.libelektra; member=KeyDeleted</div>
<div class="line">   string &quot;user:/b/foreground&quot;</div>
</div><!-- fragment --><p>The same behavior is present in the <code>logchange</code> plugin. Notice its output onto <code>stdout</code>:</p>
<div class="fragment"><div class="line">added key: user:/a/brightness</div>
<div class="line">added key: user:/a/saturation</div>
<div class="line">added key: user:/a/test</div>
<div class="line">removed key: user:/b/background</div>
<div class="line">removed key: user:/b/foreground</div>
</div><!-- fragment --><p>As can be seen, the change tracking within the <code>dbus</code> and <code>logchange</code> plugins wrongly calculates everything below <code>user:/a</code> are new keys that have been added, and everything below <code>user:/b</code> was removed.</p>
<h1><a class="anchor" id="autotoc_md1802"></a>
Constraints</h1>
<ol type="1">
<li>As far as possible, we must check for illegal sequences and raise an error when an illegal sequence occurs</li>
</ol>
<h1><a class="anchor" id="autotoc_md1803"></a>
Assumptions</h1>
<p>1. 2. 3.</p>
<h1><a class="anchor" id="autotoc_md1804"></a>
Considered Alternatives</h1>
<ol type="1">
<li><p class="startli">Document which sequences are allowed without raising errors in all illegal cases. Least-effort approach, but at least offers some transparency for developers. Developers utilizing Elektra can still ignore it, and may cause problems in certain setups without knowing.</p>
<p class="startli">(Violates constraint 1)</p>
</li>
<li>Enforce that the <code>parentKey</code> used in <code>kdbSet</code> is below the one used in the last <code>kdbGet</code>. If this is not the case, <code>kdbSet</code> will abort and report an error in <code>parentKey</code>. Developers might still wrongly mix the sequences, but they will get an error and have to fix it.<ul>
<li>Adding a <code>Key * lastGetParent</code> to <code>struct _KDB</code></li>
<li>Doing <code>keyCopy (handle-&gt;lastGetParent, parentKey, KEY_CP_NAME)</code> in <code>kdbGet</code></li>
<li>And checking <code>keyIsSameOrBelow (handle-&gt;lastGetParent, parentKey) == 1</code> in <code>kdbSet</code></li>
</ul>
</li>
</ol>
<div class="fragment"><div class="line">KDB * <a class="code" href="namespacekdb.html">kdb</a> = ...;</div>
<div class="line"> </div>
<div class="line">Key * keyA = ...;</div>
<div class="line">Key * keyB = ...;</div>
<div class="line"> </div>
<div class="line">KeySet * a = ...;</div>
<div class="line">KeySet * b = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// These sequences will work fine</span></div>
<div class="line">assert (<a class="code" href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a> (<a class="code" href="namespacekdb.html">kdb</a>, a, keyA) == 0);</div>
<div class="line">assert (<a class="code" href="group__kdb.html#ga11436b058408f83d303ca5e996832bcf">kdbSet</a> (<a class="code" href="namespacekdb.html">kdb</a>, a, keyA) == 0);</div>
<div class="line">assert (<a class="code" href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a> (<a class="code" href="namespacekdb.html">kdb</a>, b, keyB) == 0);</div>
<div class="line">assert (<a class="code" href="group__kdb.html#ga11436b058408f83d303ca5e996832bcf">kdbSet</a> (<a class="code" href="namespacekdb.html">kdb</a>, b, keyB) == 0);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// These will not</span></div>
<div class="line">assert (<a class="code" href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a> (<a class="code" href="namespacekdb.html">kdb</a>, a, keyA) == 0);</div>
<div class="line">assert (<a class="code" href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a> (<a class="code" href="namespacekdb.html">kdb</a>, b, keyB) == 0);</div>
<div class="line">assert (<a class="code" href="group__kdb.html#ga11436b058408f83d303ca5e996832bcf">kdbSet</a> (<a class="code" href="namespacekdb.html">kdb</a>, a, keyA) == -1); <span class="comment">// Error! keyA is different from last used key in kdbGet (keyB)</span></div>
<div class="ttc" id="anamespacekdb_html"><div class="ttname"><a href="namespacekdb.html">kdb</a></div><div class="ttdoc">This is the main namespace for the C++ binding and libraries.</div><div class="ttdef"><b>Definition:</b> backend.hpp:31</div></div>
</div><!-- fragment --><ol type="1">
<li>Enforce that <code>ks</code> used in <code>kdbSet</code> is the same as in the last <code>kdbGet</code> Similar to (2), but we check for the pointer of the <code>KeySet</code> instead of having a copy of the parent key, which saves some memory.<ul>
<li>Adding a <code>KeySet * lastGetKs</code> to <code>struct _KDB</code></li>
<li>Doing <code>handle-&gt;lastGetKs = ks</code> in <code>kdbGet</code></li>
<li>And checking <code>lastGetKs == ks</code> in <code>kdbSet</code></li>
</ul>
</li>
<li>Change the API so that a single instance of KDB can only contain a single instance of a <code>KeySet</code>. This solution completely eliminates problematic sequences.</li>
</ol>
<div class="fragment"><div class="line"><span class="comment">// same as before but uses handle-&gt;data instead of the ks argument</span></div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a> (KDB * handle, Key * parentKey);</div>
<div class="line"><span class="comment">// same as before but uses handle-&gt;data instead of the ks argument</span></div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="group__kdb.html#ga11436b058408f83d303ca5e996832bcf">kdbSet</a> (KDB * handle, Key * parentKey);</div>
<div class="line"> </div>
<div class="line">KeySet * kdbData (KDB * handle) {</div>
<div class="line">    <span class="keywordflow">return</span> handle-&gt;data;</div>
<div class="line">}</div>
</div><!-- fragment --><ol type="1">
<li>Allow arbitrary sequences and let each plugin deal with it on a case-by-case basis. This alternative would put most of the burden onto the plugin authors. Depending on what the plugins do, every plugin may also need to deep-dup every keyset of every parent it ever receives via <code>kdbGet</code>. This will increase memory usage. However, this could be paired with the <a class="el" href="doc_decisions_4_decided_internal_cache_md.html">COW semantics</a> so the memory toll would not be that big of a deal. The biggest problem with this approach would be the unnecessary duplication of the non-trivial change tracking algorithm.</li>
<li><p class="startli">Don't restrict sequences further and provide a common framework to handle change tracking correctly.</p>
<p class="startli">As the problem has only been observed with plugins doing their own change tracking, we could provide a general change tracking framework within Elektra. This way, we have only one such algorithm in a central place, and plugin authors don't have to think about the sequences their plugins are called by developers.</p>
<p class="startli">This approach can also be paired with <a class="el" href="doc_decisions_4_decided_internal_cache_md.html">COW semantics</a>, so that memory toll will be kept low. A separate <a class="el" href="doc_decisions_3_in_review_change_tracking_md.html">decision for change tracking</a> is currently in progress.</p>
<p class="startli">Should we observe this problem with use cases other than change tracking, we can provide general frameworks for those too.</p>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md1805"></a>
Decision</h1>
<h1><a class="anchor" id="autotoc_md1806"></a>
Rationale</h1>
<h1><a class="anchor" id="autotoc_md1807"></a>
Implications</h1>
<ul>
<li></li>
<li></li>
<li></li>
</ul>
<h1><a class="anchor" id="autotoc_md1808"></a>
Related Decisions</h1>
<ul>
<li><a class="el" href="doc_decisions_3_in_review_change_tracking_md.html">Change Tracking</a></li>
<li><a class="el" href="doc_decisions_4_decided_internal_cache_md.html">Internal KeySet Cache</a></li>
<li>[](doc_decisions_0_drafts__README_md)</li>
</ul>
<h1><a class="anchor" id="autotoc_md1809"></a>
Notes</h1>
<ul>
<li>Issue <a href="https://issues.libelektra.org/4514">#4514</a> uncovered a problem in the current change tracking approach relating to sequences of <code>kdbGet</code> and <code>kdbSet</code></li>
<li>Issue <a href="https://issues.libelektra.org/4520">#4512</a> explored some possible solutions </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
