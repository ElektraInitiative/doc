<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Transformations</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.9.13</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Transformations </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_decisions_0_drafts_transformations"></a> </p>
<h1><a class="anchor" id="autotoc_md1808"></a>
Problem</h1>
<p>Certain plugins, e.g. <code>rename</code>, perform transformations on keys and keysets within Elektra. Those transformations include, but are not limited to:</p>
<ul>
<li>Changing the names of the keys back and forth</li>
<li>Changing values back and forth for normalization, e.g. <code>true</code> -&gt; <code>1</code>, <code>1</code> -&gt; <code>true</code></li>
</ul>
<p>While these features are useful, they do create feature-interaction problems. More specifically, problems have been observed in conjunction with the following (overlapping) types of plugins:</p>
<ul>
<li>notification plugins</li>
<li>plugins that do change tracking</li>
</ul>
<p>The problem, in general, can be described as: Which representation of the KDB should be used for notifications/change tracking?</p>
<p>We differentiate between:</p>
<ul>
<li><em>persistent</em> name/value/metadata: How it is actually stored, i.e. the state returned by and passed to the <code>storage</code> plugins.</li>
<li><em>transient</em> name/value/metadata: How it is at runtime, i.e. what is returned by <code>kdbGet</code> and passed to <code>kdbSet</code>.</li>
<li><em>intermediate</em> name/value/metadata: Any state inbetween the two.</li>
</ul>
<h2><a class="anchor" id="autotoc_md1809"></a>
Observed problems with changing key names</h2>
<p>Suppose there is a plugin that changes key names. It converts to lowercase for the runtime representation, and to uppercase for the stored representation. The plugin is executed in the post-storage phase for the <code>get</code> operation and the pre-storage phase for the <code>set</code> operation. This results in the keys being in UPPERCASE in the configuration files, but they are presented in lowercase to other plugins and applications using the Elektra API.</p>
<p>For example, here is a configuration file with a hypothetical format:</p>
<div class="fragment"><div class="line">/DISPLAY/BRIGHTNESS = 100</div>
</div><!-- fragment --><p>As can be seen, the keys are in UPPERCASE within the configuration file. In Elektra keys are case-sensitive. As operations on keysets such as <code>ksLookup</code> operate with <em>runtime</em> data after the post-storage phase, <code>kdb get /DISPLAY/BRIGHTNESS</code> will fail. For Elektra, the key <code>/DISPLAY/BRIGHTNESS</code> does not exist, as the <code>rename</code> plugin transformed this into the lowercase <code>/display/brightness</code>.</p>
<p>This leads to problems with the notification plugins. As notification plugins are executed after the post-storage phase of the <code>set</code> operation, they will receive a keyset with the already transformed keys. In this example, the notification plugins will receive all-UPPERCASE keys, and send out notifications with those all-UPPERCASE keys. An application listening to those notifications will not be able to query Elektra for those keys, as for Elektra those UPPERCASE keys do not exist.</p>
<p>Apart from the problems with notifications, the way key name changing plugins work also breaks change tracking in plugins like <code>dbus</code>. This is because key names are read-only when they are contained in a <code>KeySet</code>. In order to change the name of a key, such a plugin has to create a new key with the changed name, and delete the key with the old name. The <code>dbus</code> plugin implements change tracking by checking the 'key needs sync' flag instead of comparing the values. As new keys by design have the 'key needs sync' flag set, the plugins that implement change tracking via the flag will always erroneously detect transformed keys as changed.</p>
<h2><a class="anchor" id="autotoc_md1810"></a>
Observed problems with changing values (normalization)</h2>
<p>Suppose we have a plugin that changes the value of a key to the hard coded value <code>1</code> during the storage phase of the <code>set</code> operation. If a plugin does change tracking, this will lead to false positives.</p>
<div class="fragment"><div class="line">user:/limits/openfiles = 1</div>
</div><!-- fragment --><p>If the user changes the value, e.g. using <code>kdb set user:/limits/openfiles 23</code>, plugins will observe the new value <code>23</code>. The value-changing plugin, however, will reset that value back to <code>1</code>. So in practice, the configuration has not been changed. Plugins relying on change tracking plugins (e.g. notification plugins) will however think that it has.</p>
<h1><a class="anchor" id="autotoc_md1811"></a>
Constraints</h1>
<ol type="1">
<li>We want to enable some kind of transformations</li>
<li>Renaming keys should be possible, at least in storage plugins 3.</li>
</ol>
<h1><a class="anchor" id="autotoc_md1812"></a>
Assumptions</h1>
<ol type="1">
<li>False positives for change tracking algorithms are only a minor problem. False positives are that changes are detected, even though nothing changed.</li>
<li>There is no reason to modify or delete existing <code>meta:/</code> keys.</li>
<li>Newly generated <code>meta:/...</code> keys can<ul>
<li>either stay and get permanently stored during <code>kdbSet</code></li>
<li>or be written as <code>meta:/generated/...</code>. The <code>meta:/generated/...</code> metakeys are never stored and are automatically removed during <code>kdbSet</code> before <code>storage</code> is called.</li>
</ul>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md1813"></a>
Considered Alternatives</h1>
<h2><a class="anchor" id="autotoc_md1814"></a>
Enable setting and unsetting of the &lt;tt&gt;keyNeedsSync&lt;/tt&gt; flag</h2>
<p>Require plugins that rename keys to remove the <code>keyNeedsSync</code> flag. This would require making the 'key sync' APIs public. Letting user code modify these internal flags may lead to serious bugs. This does not solve the problem of changing values.</p>
<h2><a class="anchor" id="autotoc_md1815"></a>
Use change tracking to replace the &lt;tt&gt;keyNeedsSync&lt;/tt&gt; flag</h2>
<p>Eliminate the need of the <code>keyNeedsSync</code> flag by utilizing the planned change tracking API. This does not solve the problem of changing values and false positives.</p>
<h2><a class="anchor" id="autotoc_md1816"></a>
Store original names and values in metadata.</h2>
<p>For key name transformations require that transformation plugins set a metakey (e.g. <code>meta:/elektra/runtimename</code>) with the runtime name before they do any transformations in the <code>kdbSet</code> phase. This <em>must not</em> be done if this metakey already exists, i.e. another plugin already tranformed it beforehand. This allows notification and change tracking functionality to work determine and work with the runtime name of the key.</p>
<p>A similiar thing was already attempted for values, i.e. <code>meta:/origvalue</code>.</p>
<h2><a class="anchor" id="autotoc_md1817"></a>
Create an API for transformations</h2>
<p>Plugins must use a special function to transform key names, e.g.:</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * (*ElektraNameTransform)(<span class="keyword">const</span> Key *);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> elektraApplyNameTransform (KeySet * ks, ElektraNameTransform transform);</div>
</div><!-- fragment --><p>How the <code>elektraApplyNameTransform</code> function marks the original name is an internal implementation detail. May be as <code>meta:/</code> or something else entireley.</p>
<p>Something similar could be done for the value of a key as well.</p>
<h2><a class="anchor" id="autotoc_md1818"></a>
Introduce a new phase for transformations</h2>
<p>We could also introduce a new phase between before/after storage exclusively for transformations. Then we can just do a "fake" call to that phase to get back the transient names for change tracking.</p>
<h2><a class="anchor" id="autotoc_md1819"></a>
Call value transformation plugin(s) when &lt;tt&gt;keySetValue&lt;/tt&gt; / &lt;tt&gt;keySetString&lt;/tt&gt; is called</h2>
<p>After a value has been set by the user, call the transformation plugin. We could store those callbacks as metakeys, i.e. <code>meta:/generated/transformation/value/callback/#1</code>. Alternatively, we could implement a linked list or other data structure for the callbacks.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>callback {</div>
<div class="line">    callback_fn <span class="keyword">function</span>;</div>
<div class="line">    <span class="keyword">struct </span>callback * next;</div>
<div class="line">}</div>
</div><!-- fragment --><p>There will be 3 possibilities where transformations take place:</p>
<ol type="1">
<li>For keys with a registered callback:<ul>
<li>Within <code>keySetValue</code> / <code>keySetString</code> the callbacks are called.</li>
</ul>
</li>
<li>For new keys, i.e. keys without a callback:<ul>
<li>Within <code>kdbSet</code>, as it is now.</li>
</ul>
</li>
<li>For new keys that override keys with an intact callback:<ul>
<li>Within <code>ksAppend</code> and/or <code>ksAppendKey</code> the callbacks are copied from the original key and then executed on the new key.</li>
</ul>
</li>
</ol>
<div class="fragment"><div class="line"><a class="code" href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a> (<a class="code" href="namespacekdb.html">kdb</a>, ks, parent);</div>
<div class="line"><span class="comment">// ks contains two keys:</span></div>
<div class="line"><span class="comment">//  - user:/limits/openfiles</span></div>
<div class="line"><span class="comment">//  - user:/background/color</span></div>
<div class="line"> </div>
<div class="line">Key * background = <a class="code" href="group__keyset.html#gad65d2cdcbb5381194a1688e169af8a83">ksLookupByName</a>(ks, <span class="stringliteral">&quot;user:/background/color&quot;</span>, 0);</div>
<div class="line"><a class="code" href="group__keyvalue.html#ga622bde1eb0e0c4994728331326340ef2">keySetString</a>(background, <span class="stringliteral">&quot;#ff00ff&quot;</span>); <span class="comment">// (1) -&gt; callbacks are called.</span></div>
<div class="line"><a class="code" href="group__keyset.html#gaa5a1d467a4d71041edce68ea7748ce45">ksAppendKey</a> (ks, <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (<span class="stringliteral">&quot;user:/my/key&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8ac66e4a49d09212b79f5754ca6db5bd2e">KEY_VALUE</a>, <span class="stringliteral">&quot;1234&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>); <span class="comment">// (2) -&gt; transformation will happen inside kdbSet</span></div>
<div class="line"><a class="code" href="group__keyset.html#gaa5a1d467a4d71041edce68ea7748ce45">ksAppendKey</a> (ks, <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (<span class="stringliteral">&quot;user:/limits/openfiles&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8ac66e4a49d09212b79f5754ca6db5bd2e">KEY_VALUE</a>, <span class="stringliteral">&quot;23&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>); <span class="comment">// (3) -&gt; replaces existing key, callbacks of existing key are copied and then executed</span></div>
<div class="line"><a class="code" href="group__kdb.html#ga11436b058408f83d303ca5e996832bcf">kdbSet</a> (<a class="code" href="namespacekdb.html">kdb</a>, ks, parent);</div>
<div class="ttc" id="agroup__kdb_html_ga11436b058408f83d303ca5e996832bcf"><div class="ttname"><a href="group__kdb.html#ga11436b058408f83d303ca5e996832bcf">kdbSet</a></div><div class="ttdeci">int kdbSet(KDB *handle, KeySet *ks, Key *parentKey)</div><div class="ttdoc">Set Keys to the Key database in an atomic and universal way.</div><div class="ttdef"><b>Definition:</b> kdb.c:2293</div></div>
<div class="ttc" id="agroup__kdb_html_ga28e385fd9cb7ccfe0b2f1ed2f62453a1"><div class="ttname"><a href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a></div><div class="ttdeci">int kdbGet(KDB *handle, KeySet *ks, Key *parentKey)</div><div class="ttdoc">Retrieve Keys from the Key database in an atomic and universal way.</div><div class="ttdef"><b>Definition:</b> kdb.c:1697</div></div>
<div class="ttc" id="agroup__key_html_gad23c65b44bf48d773759e1f9a4d43b89"><div class="ttname"><a href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a></div><div class="ttdeci">Key * keyNew(const char *name,...)</div><div class="ttdoc">A practical way to fully create a Key object in one step.</div><div class="ttdef"><b>Definition:</b> key.c:144</div></div>
<div class="ttc" id="agroup__key_html_gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403"><div class="ttname"><a href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a></div><div class="ttdeci">@ KEY_END</div><div class="ttdef"><b>Definition:</b> kdbenum.c:95</div></div>
<div class="ttc" id="agroup__key_html_gga9b703ca49f48b482def322b77d3e6bc8ac66e4a49d09212b79f5754ca6db5bd2e"><div class="ttname"><a href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8ac66e4a49d09212b79f5754ca6db5bd2e">KEY_VALUE</a></div><div class="ttdeci">@ KEY_VALUE</div><div class="ttdef"><b>Definition:</b> kdbenum.c:88</div></div>
<div class="ttc" id="agroup__keyset_html_gaa5a1d467a4d71041edce68ea7748ce45"><div class="ttname"><a href="group__keyset.html#gaa5a1d467a4d71041edce68ea7748ce45">ksAppendKey</a></div><div class="ttdeci">ssize_t ksAppendKey(KeySet *ks, Key *toAppend)</div><div class="ttdoc">Appends a Key to the end of ks.</div><div class="ttdef"><b>Definition:</b> keyset.c:971</div></div>
<div class="ttc" id="agroup__keyset_html_gad65d2cdcbb5381194a1688e169af8a83"><div class="ttname"><a href="group__keyset.html#gad65d2cdcbb5381194a1688e169af8a83">ksLookupByName</a></div><div class="ttdeci">Key * ksLookupByName(KeySet *ks, const char *name, elektraLookupFlags options)</div><div class="ttdoc">Convenience method to look for a Key contained in ks with name name.</div><div class="ttdef"><b>Definition:</b> keyset.c:2781</div></div>
<div class="ttc" id="agroup__keyvalue_html_ga622bde1eb0e0c4994728331326340ef2"><div class="ttname"><a href="group__keyvalue.html#ga622bde1eb0e0c4994728331326340ef2">keySetString</a></div><div class="ttdeci">ssize_t keySetString(Key *key, const char *newStringValue)</div><div class="ttdoc">Set the value for key as newStringValue.</div><div class="ttdef"><b>Definition:</b> keyvalue.c:381</div></div>
<div class="ttc" id="anamespacekdb_html"><div class="ttname"><a href="namespacekdb.html">kdb</a></div><div class="ttdoc">This is the main namespace for the C++ binding and libraries.</div><div class="ttdef"><b>Definition:</b> backend.hpp:31</div></div>
</div><!-- fragment --><p>We also need to provide a simple API to plugins to register such callbacks for a key.</p>
<p>As the transformations for existing keys will be applied before <code>kdbSet</code>, this will elimate false positives in changetracking.</p>
<p>A drawback to this solution is that it adds some complexity to <code>libelektra-core</code>.</p>
<h1><a class="anchor" id="autotoc_md1820"></a>
Decision</h1>
<h1><a class="anchor" id="autotoc_md1821"></a>
Rationale</h1>
<h1><a class="anchor" id="autotoc_md1822"></a>
Implications</h1>
<ul>
<li></li>
<li></li>
<li></li>
</ul>
<h1><a class="anchor" id="autotoc_md1823"></a>
Related Decisions</h1>
<ul>
<li><a class="el" href="doc_decisions_5_partially_implemented_hooks_md.html">Hooks</a></li>
<li><a class="el" href="doc_decisions_1_problem_clear_change_tracking_md.html">Change Tracking</a></li>
<li><a class="el" href="doc_decisions_0_drafts_operation_sequences_md.html">Operation Sequences</a></li>
<li><a class="el" href="doc_decisions_4_decided_internal_cache_md.html">Internal Cache</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md1824"></a>
Notes</h1>
<ul>
<li><a href="https://issues.libelektra.org/404">Issue #404</a> - dbus and rename plugin do not work together</li>
<li><a href="https://issues.libelektra.org/955">Issue #955</a> - dbus: non-UTF8 key names</li>
<li><a href="https://issues.libelektra.org/3626">Issue #3626</a> - origvalue </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
