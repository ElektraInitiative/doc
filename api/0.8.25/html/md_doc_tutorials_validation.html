<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: validation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Elektra
   &#160;<span id="projectnumber">0.8.25</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">validation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr/>
<p> author: Markus Raab <a href="#" onclick="location.href='mai'+'lto:'+'ele'+'kt'+'ra@'+'ma'+'rku'+'s-'+'raa'+'b.'+'org'; return false;">elekt<span style="display: none;">.nosp@m.</span>ra@m<span style="display: none;">.nosp@m.</span>arkus<span style="display: none;">.nosp@m.</span>-raa<span style="display: none;">.nosp@m.</span>b.org</a> brief: Describes validation capabilities of Elektra. tags: validation, spec, metadata </p><h2>review: pending </h2>
<h1><a class="anchor" id="doc_tutorials_validation_md"></a>
Validation</h1>
<h2>Introduction</h2>
<p>Configuration in &lt;abbr title="Free/Libre and Open Source Software"&gt;FLOSS&lt;/abbr&gt; unfortunately is often stored completely without validation. Notable exceptions are sudo (<code>visudo</code>), or user accounts (<code>adduser</code>) but in most cases you only get feedback of non-validating configuration when the application fails to start.</p>
<p>Elektra provides a generic way to validate any configuration before it is written to disc.</p>
<h2>User Interfaces</h2>
<p>Any of Elektra's user interfaces will work with the technique described in this tutorial, e.g.:</p>
<ol type="1">
<li><code>kdb qt-gui</code>: graphical user interface</li>
<li><code>kdb editor</code>: starts up your favorite text editor and allows you to edit configuration in any syntax. (generalization of <code>visudo</code>)</li>
<li><code>kdb set</code>: manipulate or add individual configuration entries. (generalization of <code>adduser</code>)</li>
<li>Any other tool using Elektra to store configuration (e.g. if the application itself has capabilities to modify its configuration)</li>
</ol>
<h2>Metadata Together With Keys</h2>
<p>The most direct way to validate keys is</p>
<div class="fragment"><div class="line">sudo kdb mount validation.dump user/tests/together dump validation</div><div class="line">kdb vset user/tests/together/test 123 &quot;[1-9][0-9]*&quot; &quot;Not a number&quot;</div><div class="line">kdb set user/tests/together/test abc</div><div class="line"># STDERR: The command kdb.* set failed while accessing the key database .*</div><div class="line"># ERROR:  42</div><div class="line"># RET:5</div></div><!-- fragment --><p>For all other plugins (except <code>validation</code>) the convenience tool <code>kdb vset</code> is missing. Let us see what <code>kdb vset</code> actually did:</p>
<div class="fragment"><div class="line">kdb lsmeta user/tests/together/test</div><div class="line">#&gt; check/validation</div><div class="line">#&gt; check/validation/match</div><div class="line">#&gt; check/validation/message</div></div><!-- fragment --><p>So it only appended some metadata (data describing the data) next to the key, which we also could do by:</p>
<div class="fragment"><div class="line"># Following lines are (except for error conditions) identical to</div><div class="line"># kdb vset user/tests/together/test 123 &quot;[1-9][0-9]*&quot; &quot;Not a number&quot;</div><div class="line">kdb setmeta user/tests/together/test check/validation &quot;[1-9][0-9]*&quot;</div><div class="line">kdb setmeta user/tests/together/test check/validation/match LINE</div><div class="line">kdb setmeta user/tests/together/test check/validation/message &quot;Not a number&quot;</div><div class="line">kdb set user/tests/together/test 123</div><div class="line">#&gt; Set string to &quot;123&quot;</div><div class="line"></div><div class="line"># Undo modifications</div><div class="line">kdb rm -r user/tests/together</div><div class="line">sudo kdb umount user/tests/together</div></div><!-- fragment --><p>The approach is not limited to validation via regular expressions, but any values-validation plugin can be used, e.g. <a class="el" href="md_src_plugins_enum_README.html#src_plugins_enum_README_md">enum</a>. For a full list refer to the section "Value Validation" in the <a class="el" href="md_src_plugins_README.html#src_plugins_README_md">list of all plugins</a>.</p>
<p>Note that it also easy <a class="el" href="doc_tutorials_plugins_md.html">to write your own (value validation) plugin</a>.</p>
<p>The drawbacks of this approach are:</p>
<ul>
<li>The administrator needs to take care that the validation plugins are available where needed.</li>
<li>Some metadata (in this case <code>check/validation</code>) needs to be stored next to the key which won't work with most configuration files. This is the reason why we explicitly used <code>dump</code> as storage in <code>kdb mount</code>.</li>
<li>After the key is removed, the validation information is gone, too.</li>
<li>It only works for the <a class="el" href="doc_tutorials_namespaces_md.html">namespace</a> where <code>vset</code> was used. In the example above we could override the cascading key <code>/tutorial/together/test</code> with the unvalidated key <code>dir/tutorial/together/test</code>.</li>
<li>You cannot validate structure of which keys must be present or absent.</li>
</ul>
<h2>Get Started with <code>spec</code></h2>
<p>These issues are resolved straightforward by separating the configuration from its configuration specification (often called schemata in XML or JSON). The purpose of the <a class="el" href="doc_tutorials_namespaces_md.html">spec namespace</a> is to hold the configuration specification, i.e., the description of how to validate the keys of all other namespaces.</p>
<p>To make this work, we need a plugin that applies all metadata found in the <code>spec</code>-namespace to all other namespaces. This plugin is called <code>spec</code> and needs to be mounted globally (will be added by default and also with any <code>kdb global-mount</code> call).</p>
<p>Before we start, let us make a backup of the current data in the spec and user namespace:</p>
<div class="fragment"><div class="line">kdb set system/tests/spec $(mktemp)</div><div class="line">kdb set system/tests/user $(mktemp)</div><div class="line">kdb export spec dump &gt; $(kdb get system/tests/spec)</div><div class="line">kdb export user dump &gt; $(kdb get system/tests/user)</div></div><!-- fragment --><p>We write metadata to the namespace <code>spec</code> and the plugin <code>spec</code> applies it to every cascading key:</p>
<div class="fragment"><div class="line">kdb setmeta spec/tests/spec/test hello world</div><div class="line">kdb set /tests/spec/test value</div><div class="line">#&gt; Using name user/tests/spec/test</div><div class="line">#&gt; Create a new key user/tests/spec/test with string &quot;value&quot;</div><div class="line">kdb lsmeta spec/tests/spec/test | grep -v &#39;^internal/ini&#39;</div><div class="line">#&gt; hello</div><div class="line">kdb lsmeta /tests/spec/test | grep -v &#39;^internal/ini&#39;</div><div class="line">#&gt; hello</div><div class="line">kdb getmeta /tests/spec/test hello</div><div class="line">#&gt; world</div><div class="line">kdb getmeta user/tests/spec/test hello</div><div class="line">#&gt; world</div></div><!-- fragment --><p>But it also supports globbing (<code>_</code> for any key, <code>?</code> for any char, <code>[]</code> for character classes):</p>
<div class="fragment"><div class="line">kdb setmeta &quot;spec/tests/spec/_&quot; new metaval</div><div class="line">kdb set /tests/spec/test value</div><div class="line">#&gt; Using name user/tests/spec/test</div><div class="line">#&gt; Set string to &quot;value&quot;</div><div class="line">kdb lsmeta /tests/spec/test | grep -v &#39;^internal/ini&#39;</div><div class="line">#&gt; hello</div><div class="line">#&gt; new</div><div class="line"></div><div class="line"># Remove keys and metadata from the commands above</div><div class="line">kdb rm -r spec/tests/spec</div><div class="line">kdb rm -r user/tests/spec</div></div><!-- fragment --><p>So let us combine this functionality with validation plugins. So we would specify:</p>
<div class="fragment"><div class="line">kdb setmeta spec/tests/spec/test check/validation &quot;[1-9][0-9]*&quot;</div><div class="line">kdb setmeta spec/tests/spec/test check/validation/match LINE</div><div class="line">kdb setmeta spec/tests/spec/test check/validation/message &quot;Not a number&quot;</div></div><!-- fragment --><p>If we now set a new key with </p><div class="fragment"><div class="line">kdb set /tests/spec/test &quot;not a number&quot;</div><div class="line">#&gt; Using name user/tests/spec/test</div><div class="line">#&gt; Create a new key user/tests/spec/test with string &quot;not a number&quot;</div></div><!-- fragment --><p> this key has adopted all metadata from the spec namespace: </p><div class="fragment"><div class="line">kdb lsmeta /tests/spec/test | grep -v &#39;^internal/ini&#39;</div><div class="line">#&gt; check/validation</div><div class="line">#&gt; check/validation/match</div><div class="line">#&gt; check/validation/message</div></div><!-- fragment --><p> Note that this key should not have passed the validation that we defined in the spec namespace. Nonetheless we were able to set this key, because the validation plugin was not active for this key. On that behalf we have to make sure that the validation plugin is loaded for this key with: </p><div class="fragment"><div class="line">kdb mount tutorial.dump user/tutorial dump validation</div></div><!-- fragment --><p> This <a class="el" href="doc_tutorials_mount_md.html">mounts</a> the backend <code>tutorial.dump</code> to the mount point <b>user/tutorial</b> and activates the validation plugin for the keys below the mount point. The validation plugin now uses the metadata of the keys below <b>user/tutorial</b> to validate values before storing them in <code>tutorial.dump</code>.</p>
<p>Although this is better than defining metadata in the same place as the data itself, we can still do better. The reason for that is that one of the aims of Elektra is to remove the trouble of validation and finding the files that hold your configuration from the users. At the moment a user still has to know which files should hold the configuration and which plugins must be loaded when he mounts configuration files.</p>
<p>This problem can be addressed by recognizing that the location of the configuration files and the plugins that must be loaded is part of the <em>schema</em> of our configuration and therefore should be stored in the spec namespace.</p>
<div class="fragment"><div class="line"># Undo modifications</div><div class="line">kdb rm -r spec/tests/spec/test</div><div class="line">kdb rm -r user/tests/spec/test</div></div><!-- fragment --><h3>Specfiles</h3>
<p>We call the files, that contain a complete schema for configuration below a specific path in form of metadata, <em>Specfiles</em>.</p>
<p>Particularly a <em>Specfile</em> contains metadata that defines</p><ul>
<li>the mount points of paths,</li>
<li>the plugins to load and</li>
<li>the behavior of these plugins.</li>
</ul>
<p>Let us create an example <em>Specfile</em> in the dump format, which supports metadata (altough the specfile is stored in the dump format, we can still create it using the human readable <a class="el" href="md_src_plugins_ni_README.html#src_plugins_ni_README_md">ni format</a> by using <code>kdb import</code>): </p><div class="fragment"><div class="line">sudo kdb mount tutorial.dump spec/tests/tutorial dump</div><div class="line">cat &lt;&lt; HERE | kdb import spec/tests/tutorial ni  \</div><div class="line">[]                                         \</div><div class="line"> mountpoint = tutorial.dump                \</div><div class="line"> infos/plugins = dump validation           \</div><div class="line">                                           \</div><div class="line">[/links/_]                                 \</div><div class="line">check/validation = https?://.*\..*         \</div><div class="line">check/validation/match = LINE              \</div><div class="line">check/validation/message = not a valid URL \</div><div class="line">description = A link to some website       \</div><div class="line">HERE</div><div class="line">kdb lsmeta spec/tests/tutorial</div><div class="line">#&gt; infos/plugins</div><div class="line">#&gt; mountpoint</div></div><!-- fragment --><p> We now have all the metadata that we need to mount and validate the data below <code>/tutorial</code> in one file.</p>
<p>Now we apply this <em>Specfile</em> to the key database to all keys below <code>tests/tutorial</code>. </p><div class="fragment"><div class="line">kdb spec-mount /tests/tutorial</div></div><!-- fragment --><p> This command automatically mounts <code>/tests/tutorial</code> to the backend <code>tutorial.dump</code>. Furthermore it adds all plugins necessary for all metadata within the specification. So in this example the validation plugin will be loaded automatically for us. <code>spec-mount</code> basically does a normal mount except that it automatically selects plugins. As a result there is no <code>spec-umount</code> command since the normal <code>umount</code> is sufficient.</p>
<p>Please be aware that if you require many plugins for the same mount point, you can run into <a href="https://github.com/ElektraInitiative/libelektra/issues/2133">this</a> error.</p>
<div class="fragment"><div class="line">kdb set /tests/tutorial/links/url &quot;invalid url&quot;</div><div class="line">#&gt; Using name user/tests/tutorial/links/url</div><div class="line"># STDERR: .*key value failed to validate.*not a valid URL.*</div><div class="line"># ERROR:  42</div><div class="line"># RET:    5</div></div><!-- fragment --><p>Note that the backend <code>tutorial.dump</code> is mounted for all namespaces: </p><div class="fragment"><div class="line">kdb file user/tests/tutorial</div><div class="line"># STDOUT-REGEX: /.*/tutorial\.dump</div><div class="line">kdb file system/tests/tutorial</div><div class="line"># STDOUT-REGEX: /.*/tutorial\.dump</div><div class="line">kdb file dir/tests/tutorial</div><div class="line"># STDOUT-REGEX: /.*/tutorial\.dump</div></div><!-- fragment --><p>If you want to set a key for another namespace and do not want to go without validation, consider that the spec plugin works only when you use cascading keys. You can work around that by setting the keys with the <code>-N</code> option: </p><div class="fragment"><div class="line">kdb set -N system /tests/tutorial/links/elektra https://www.libelektra.org</div><div class="line">#&gt; Using name system/tests/tutorial/links/elektra</div><div class="line">#&gt; Create a new key system/tests/tutorial/links/elektra with string &quot;https://www.libelektra.org&quot;</div></div><!-- fragment --><h2>Rejecting Configuration Keys</h2>
<p>Up to now we only discussed how to reject keys that have unwanted values. Sometimes, however, applications require the presence or absence of keys. There are many ways to do so directly supported by <a class="el" href="md_src_plugins_spec_README.html#src_plugins_spec_README_md">the spec plugin</a>. Another way is to trigger errors with the <a class="el" href="md_src_plugins_error_README.html#src_plugins_error_README_md">error plugin</a>:</p>
<div class="fragment"><div class="line">kdb setmeta /tests/tutorial/spec/should_not_be_here trigger/error 10</div><div class="line">#&gt; Using keyname spec/tests/tutorial/spec/should_not_be_here</div><div class="line">kdb spec-mount /tests/tutorial</div><div class="line">kdb set /tests/tutorial/spec/should_not_be_here abc</div><div class="line">#&gt; Using name user/tests/tutorial/spec/should_not_be_here</div><div class="line"># RET:    5</div><div class="line"># STDERR: .*error.*10.*occurred.*</div><div class="line">kdb get /tests/tutorial/spec/should_not_be_here</div><div class="line"># RET: 11</div><div class="line"># STDERR: Did not find key &#39;/tests/tutorial/spec/should_not_be_here&#39;</div></div><!-- fragment --><p>If we want to reject every optional key (and only want to allow required keys) we can use the plugin <code>required</code> as further discussed below.</p>
<p>Before we look further let us undo the modifications to the key database.</p>
<div class="fragment"><div class="line">kdb rm -r spec/tests/tutorial</div><div class="line">kdb rm -r system/tests/tutorial</div><div class="line">kdb umount spec/tests/tutorial</div><div class="line">kdb umount /tests/tutorial</div><div class="line">kdb rm -rf spec</div><div class="line">kdb rm -rf user</div><div class="line">kdb import spec dump &lt; $(kdb get system/tests/spec)</div><div class="line">kdb import user dump &lt; $(kdb get system/tests/user)</div><div class="line">rm $(kdb get system/tests/spec)</div><div class="line">rm $(kdb get system/tests/user)</div><div class="line">kdb rm system/tests/spec</div><div class="line">kdb rm system/tests/user</div></div><!-- fragment --><h2>Customized Schemas</h2>
<p>Sometimes we already have configuration specifications given in some other format which is more compact and more directed to the needs of an individual application. We can write a plugin that parses that format and transform the content to key-value <em>and</em> metadata (describing how to validate).</p>
<p>For example, let us assume we have enum validations in the file <code>schema.txt</code>:</p>
<div class="fragment"><div class="line">cat &gt; &quot;$PWD/schema.txt&quot; &lt;&lt; HERE           \</div><div class="line">%: notation TBD ? graph text semi         \</div><div class="line">%: tool-support* TBD ? none compiler ide  \</div><div class="line">%: applied-to TBD ? none small real-world \</div><div class="line">mountpoint file.txt                       \</div><div class="line">plugins required                          \</div><div class="line">HERE</div></div><!-- fragment --><p>And by convention for keys ending with <code>*</code>, multiple values are allowed. So we want to transform above syntax to:</p>
<div class="fragment"><div class="line">%:notation TBD ? graph text semi</div><div class="line">%:tool-support* TBD ? none compiler ide</div><div class="line">%:applied-to TBD ? none small real-world</div></div><!-- fragment --><p>Lucky, we already have a plugin which allows us to so:</p>
<div class="fragment"><div class="line">kdb mount &quot;$PWD/schema.txt&quot; spec/tutorial/schema simplespeclang keyword/enum=%:,keyword/assign=TBD</div><div class="line">kdb spec-mount /tutorial/schema</div></div><!-- fragment --><p>We configure the plugin <code>simplespeclang</code> so that it conforms to our "weird" syntax. Because in <code>schema.txt</code> we have the line <code>mountpoint file.txt</code> we can also mount the schema using <code>spec-mount</code>.</p>
<p>Now we have enforced that the 3 configuration options <code>notation tool-support* applied-to</code> need to be present (and no other). For example we can import:</p>
<div class="fragment"><div class="line">kdb import -s validate -c &quot;format=% : %&quot; /tutorial/schema simpleini &lt;&lt; HERE \</div><div class="line">notation : graph                                                            \</div><div class="line">tool-support : ? none                                                       \</div><div class="line">applied-to : small                                                          \</div><div class="line">HERE                                                                        \</div></div><!-- fragment --><p>Or (afterwards) setting individual values:</p>
<div class="fragment"><div class="line">kdb set /tutorial/schema/applied-to smal # fails, not a valid enum</div></div><!-- fragment --><p>Or (in <code>visudo</code> fashion):</p>
<div class="fragment"><div class="line">kdb editor -s validate /tutorial/schema simpleini</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
