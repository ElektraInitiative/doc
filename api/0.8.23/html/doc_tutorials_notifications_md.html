<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Notification Tutorial</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Elektra
   &#160;<span id="projectnumber">0.8.23</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Notification Tutorial </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Preface</h2>
<p><b>Not all of the features described in this document are implemented yet.</b></p>
<p>Development state:</p>
<ul>
<li>[x] internalnotification plugin (support for int and callback)</li>
<li>[x] notification wrapper (support for int and callback)</li>
<li>[X] transport plugin dbus</li>
<li>[ ] transport plugin zeromq</li>
<li>[ ] transport plugin redis</li>
<li>[ ] internalnotification plugin &amp; notfication wrapper (support for Elektra's basic types)</li>
</ul>
<p>This document explains how notifications are implemented in Elektra and how they can be used by application developers.</p>
<h2>Notifications - Overview &amp; Concept</h2>
<p>Elektra's notification feature consists of several components. While sending and receiving notifications is implemented by plugins, applications use APIs provided by wrappers in order to use different plugins.</p>
<p>A <a href="https://doc.libelektra.org/api/current/html/group__kdbnotification.html">wrapper for notifications</a> provides the API for receiving and handling notifications. A <a href="https://doc.libelektra.org/api/current/html/group__kdbio.html">wrapper for I/O operations</a> allows asynchronous notification processing by compatible plugins. The I/O wrapper consists of an <em>interface</em> used by transport plugins and multiple implementations of that interface called <em>I/O bindings</em>. A I/O binding implements the actual I/O management functions for a specific I/O management library. Applications typically use one I/O binding but can also use none or multiple I/O bindings.</p>
<p>Transport plugins exchange notifications via different protocols like D-Bus, Redis and ZeroMQ. For each type of transport there are two types of plugins: One for sending and one for receiving notifications. Developers do not interact with those plugins directly. The underlying transports are transparent to them. An internal-notification plugin implements notification handling functions and feeds back configuration changes from within the application.</p>
<div class="image">
<object type="image/svg+xml" data="../images/notifications.svg" alt="Overview"></object>
</div>
<p>When a configuration key is changed Elektra can generate change notifications that allow applications to process those changes. Developers can choose whether and how they want to receive and handle those notifications but not whether notifications are sent or which transport is used. How notifications are sent is specified in the <em>notification configuration</em> by the system operator.</p>
<h2>Notification configuration</h2>
<p>System operators can mount the desired transport plugins and configure them (e.g. set channel, host, port and credentials) either globally or when mounting a configuration file.</p>
<p>They need to mount both sending and receiving plugins in order to use a transport.</p>
<div class="fragment"><div class="line">kdb mount file.ini system/example ini dbussend dbusreceive</div></div><!-- fragment --><h2>How to integrate an I/O binding and send notifications asynchronously</h2>
<p>Developers do not need to change their programs in order to start sending notifications. However without the integration of an I/O binding notifications are sent synchronously which will block normal program execution. For programs without time constraints (e.g. CLI programs) this may not be important, but for GUIs or network services this will have negative impact.</p>
<p>Since many different I/O management libraries exist (e.g. libuv, glib or libev) the transport plugins use the I/O interface for their I/O operations. Each I/O management library needs its own I/O binding. Developers can also create their own I/O binding for the I/O management library of their choice. This is described in the last section.</p>
<p>Each I/O binding has its own initialization function that creates a new I/O binding and connects it to the I/O management library. For this tutorial we will assume that libuv is used. For details on how to use a specific binding please look at the bindings' README.md in <code>src/bindings/io/&lt;binding&gt;</code>.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;elektra/kdb.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;elektra/kdbio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;elektra/kdbio_uv.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;elektra/kdbnotification.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;uv.h&gt;</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="testio__doc_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a> (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        KDB* repo;</div><div class="line"></div><div class="line">        <span class="comment">// .. open KDB</span></div><div class="line"></div><div class="line">        <span class="comment">// Create libuv event loop</span></div><div class="line">        uv_loop_t * loop = uv_default_loop ();</div><div class="line"></div><div class="line">        <span class="comment">// Initialize I/O binding tied to event loop</span></div><div class="line">        <a class="code" href="kdbio_8h.html#aabcd87b8c09d4d4c1033fc1baa417391">ElektraIoInterface</a> * binding = <a class="code" href="kdbio__uv_8h.html#a45e8a50dca7d8097bc2c38c54b49958b">elektraIoUvNew</a> (loop);</div><div class="line"></div><div class="line">  <span class="comment">// Use I/O binding for our kdb instance</span></div><div class="line">  <a class="code" href="group__kdbio.html#ga187345483bdfbb404919c6797bc2db77">elektraIoSetBinding</a> (<a class="code" href="namespacekdb.html">kdb</a>, binding);</div><div class="line"></div><div class="line">        <span class="comment">// Initialize notification wrapper</span></div><div class="line">        <a class="code" href="notification_8c.html#aeae96154abdb5fdbf1b34a01e2b23e44">elektraNotificationOpen</a> (<a class="code" href="namespacekdb.html">kdb</a>);</div><div class="line"></div><div class="line">        <span class="comment">// Start the event loop</span></div><div class="line">        uv_run (loop, UV_RUN_DEFAULT);</div><div class="line"></div><div class="line">        <span class="comment">// Cleanup</span></div><div class="line">  <a class="code" href="notification_8c.html#a5685dafbd4131011365628d6d9213594">elektraNotificationClose</a> (<a class="code" href="namespacekdb.html">kdb</a>);</div><div class="line">  <a class="code" href="io_8c.html#a062e9d7d5305201dfe5ba437f3f03224">elektraIoBindingCleanup</a> (binding);</div><div class="line">        uv_loop_close (loop);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> someFunction (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="comment">// notifications are sent asynchronously on kdbSet</span></div><div class="line">        <span class="comment">// over configured transports using our uv event loop</span></div><div class="line">        <a class="code" href="group__kdb.html#ga11436b058408f83d303ca5e996832bcf">kdbSet</a> (repo, key, parentKey);</div><div class="line">}</div></div><!-- fragment --><h2>How to receive notifications</h2>
<p>We extend the example from the previous section where we already created our I/O binding and initialized the notification-wrapper. In order to handle change notifications a developer can either register a variable or a callback.</p>
<h3>Register a variable</h3>
<p>Values of registered variables are automatically updated when the value of the assigned key has changed. In the following example we will register an integer variable:</p>
<div class="fragment"><div class="line">KDB * repo;</div><div class="line"></div><div class="line"><span class="comment">//  ... initialization of KDB and I/O binding</span></div><div class="line"></div><div class="line">Key * key = <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (<span class="stringliteral">&quot;/sw/myorg/myprogram/#0/current/value&quot;</span>, <a class="code" href="group__key.html#gga91fb3178848bd682000958089abbaf40aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>);</div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__keyvalue.html#ga6f29609c5da53c6dc26a98678d5752af">keyValue</a>;</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> result = <a class="code" href="notification_8c.html#a362d557489c4199f6c765480a8a3cade">elektraNotificationRegisterInt</a> (repo, key, &amp;keyValue);</div><div class="line"><span class="keywordflow">if</span> (!result)</div><div class="line">{</div><div class="line">        printf (<span class="stringliteral">&quot;could not register variable!\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// repeatedly print variable</span></div><div class="line"><span class="keywordflow">while</span> (1) {</div><div class="line">        printf (<span class="stringliteral">&quot;value is %d\n&quot;</span>, keyValue);</div><div class="line"></div><div class="line">        sleep(2);</div><div class="line">}</div></div><!-- fragment --><p>After calling <code>elektraNotificationRegisterInt</code> the variable <code>keyValue</code> will be automatically updated if the key in the program above is changed by another program (e.g. by using the <code>kdb</code> CLI command). For automatic updates to work transport plugins have to be in place either at a mountpoint above the configuration or mounted globally.</p>
<h3>Callbacks</h3>
<p>Registering a variable is suitable for programs where the key's value is simply displayed or used repeatedly (e.g. by a timer or in a loop). If an initialization code needs to be redone after configuration changes (e.g. a value sets the number of worker threads) updating a registered variable will not suffice. For these situations a callback should be used.</p>
<p>The following snippet shows how a callback can be used if the value of the changed key needs further processing.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"></div><div class="line"><span class="comment">// from https://en.wikipedia.org/wiki/ANSI_escape_code#Colors</span></div><div class="line"><span class="preprocessor">#define ANSI_COLOR_RED                  &quot;\x1b[31m&quot;</span></div><div class="line"><span class="preprocessor">#define ANSI_COLOR_GREEN                &quot;\x1b[32m&quot;</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> setTerminalColor (Key * color)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> * value = <a class="code" href="group__keyvalue.html#ga880936f2481d28e6e2acbe7486a21d05">keyString</a> (color);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (strcmp (value, <span class="stringliteral">&quot;red&quot;</span>) == 0)</div><div class="line">        {</div><div class="line">                printf (ANSI_COLOR_RED);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (strcmp (value, <span class="stringliteral">&quot;green&quot;</span>) == 0)</div><div class="line">        {</div><div class="line">                printf (ANSI_COLOR_GREEN);</div><div class="line">        }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="testio__doc_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a> (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        KDB * repo;</div><div class="line"></div><div class="line">        <span class="comment">// ... initialization of KDB, I/O binding and notifications</span></div><div class="line"></div><div class="line">        Key * configBase = <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (<span class="stringliteral">&quot;/sw/myorg/myprogram/#0/current&quot;</span>, <a class="code" href="group__key.html#gga91fb3178848bd682000958089abbaf40aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>);</div><div class="line">        Key * color = <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (<span class="stringliteral">&quot;/sw/myorg/myprogram/#0/current/color&quot;</span>, <a class="code" href="group__key.html#gga91fb3178848bd682000958089abbaf40aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>);</div><div class="line"></div><div class="line">        <span class="comment">// Retrieve key from kdb</span></div><div class="line">        KeySet * ks = <a class="code" href="group__keyset.html#ga671e1aaee3ae9dc13b4834a4ddbd2c3c">ksNew</a> (10, <a class="code" href="kdbenum_8c.html#a7a28fce3773b2c873c94ac80b8b4cd54">KS_END</a>);</div><div class="line">        <a class="code" href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a> (repo, ks, configBase);</div><div class="line">        Key * key = <a class="code" href="group__keyset.html#gaa34fc43a081e6b01e4120daa6c112004">ksLookup</a> (ks, color, 0);</div><div class="line">        <span class="keywordflow">if</span> (key) {</div><div class="line">                <span class="comment">// Initialization</span></div><div class="line">                setTerminalColor (key);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Re-Initialize on key changes</span></div><div class="line">        <span class="keywordtype">int</span> result = <a class="code" href="notification_8c.html#aec859714220d1e6a476910433bb77d83">elektraNotificationRegisterCallback</a>(repo, color, &amp;setTerminalColor);</div><div class="line">        <span class="keywordflow">if</span> (!result) {</div><div class="line">                printf (<span class="stringliteral">&quot;could not register callback!\n&quot;</span>);</div><div class="line">                <span class="keywordflow">return</span> -1;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// ... start loop, etc.</span></div><div class="line">}</div></div><!-- fragment --><h2>How to create your own I/O Binding</h2>
<p>Developers can create their own bindings if the I/O management library of their choice is not supported by an existing I/O binding.</p>
<p>For details on see the <a class="el" href="md_src_bindings_io_doc_README.html#src_bindings_io_doc_README_md">example </a>doc" binding" or the <a href="https://doc.libelektra.org/api/current/html/group__kdbio.html">API documentation</a>. Existing I/O bindings provide a good inspiration on how to implement a custom binding. Since a binding is generic and not application specific it is much appreciated if you contribute your I/O binding back to the Elektra project. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
