<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Cryptographic Key Handling</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.9.13</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Cryptographic Key Handling </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_decisions_6_implemented_cryptograhic_key_handling"></a> </p>
<h1><a class="anchor" id="autotoc_md2277"></a>
Problem</h1>
<p>The crypto plugin applies cryptographic operations to Keys and KeySets. In order to do that it needs keys and initialization vectors (IV). The problem is how to retrieve or derivate those keys in a safe way and how to pass them on to the underlying crypto libraries (OpenSSL and libgcrypt at the time of writing).</p>
<h1><a class="anchor" id="autotoc_md2278"></a>
Constraints</h1>
<p>The solution must be reasonable to the user (not just experimental setups).</p>
<p>The key handling should follow best practises when dealing with cryptographic operations, thus:</p>
<ul>
<li>the combination of key and IV must not be used twice for symmetric encryption</li>
<li>the key and IV material must be as random as possible (using an SNRG)</li>
<li>the key is not exposed to other Elektra modules or the user</li>
</ul>
<h1><a class="anchor" id="autotoc_md2279"></a>
Assumptions</h1>
<ul>
<li>The user knows or is willing to learn how to use GPG.</li>
<li>The user is willing to configure <code>pinentry</code> on her system, as it does not always run out of the box (depending on the distribution)</li>
<li>The user knows how to create and identify an asymmetric key pair using <code>gpg</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md2280"></a>
Considered Alternatives</h1>
<p>We considered passing the key and IV in form of plugin configuration and metakeys, but this approach possibly exposes the key to other modules. Thus our constraints are violated.</p>
<p>Also we considered using the gpg-agent (or pcscd, which uses a similar protocol) for providing asymmetric cryptographic operations. The problem with gpg-agent is that it only provides operations which require the private part of the key-pair (i.e. signing and decrypting). We would still have to implement the counterpart operations (i.e. verifying and encrypting) on our own. Starting the gpg-agent and the whole interprocess communication is either tedious work (when implemented by oneself) or adds another dependency (when using libassuan). So we do not consider the gpg-agent to be a viable option.</p>
<h1><a class="anchor" id="autotoc_md2281"></a>
Decision</h1>
<h2><a class="anchor" id="autotoc_md2282"></a>
General Approach</h2>
<p>The introduction of a GPG interface enables the user to utilize her existing key-pairs for cryptographic operations in Elektra. The private key is used for encrypting a random sequence, which serves as seed for a key derivation function (KDF). This way we can safely derivate cryptographic keys for symmetric value encryption. Both OpenSSL and libgcrypt have built-in support for the PBKDF2 (see RFC 2898).</p>
<p>The PBKDF2 needs an iteration number and a salt in order to work. Those values will be stored per Key as MetaKey.</p>
<h2><a class="anchor" id="autotoc_md2283"></a>
Implementation Details</h2>
<p>During the <b>mount phase</b> a random master password <em>r</em> is being generated. <em>r</em> is sent to the gpg binary for encryption. The resulting encrypted master password <em>m</em> is stored in the plugin configuration at <code>config/masterChallenge</code>.</p>
<p>During the <b>set phase</b> the master password <em>m</em> is sent to the gpg binary for decryption in order to retrieve <em>r</em>. The following steps will be repeated for every Key <em>k</em>, that is supposed to be encrypted. A random salt <em>s(k)</em> is generated. By applying the PBKDF2 (mentioned earlier) with <em>r</em> and <em>s(k)</em>, the cryptographic key <em>e(k)</em> and the initialization vector <em>i(k)</em> is being derived. The value of <em>k</em> will be encrypted using <em>e(k)</em> and <em>i(k)</em>. The seed <em>s(k)</em> will be encoded as prefix into the encrypted value.</p>
<p>During the <b>get phase</b> the master password <em>m</em> is sent to the gpg binary for decryption in order to retrieve <em>r</em>. The following steps will be repeated for every Key <em>k</em>, that is supposed to be decrypted. The salt <em>s(k)</em> is read from the encrypted message. By applying the PBKDF2 with <em>r</em> and <em>s(k)</em> the values of <em>e(k)</em> and <em>i(k)</em> are restored. Then the encrypted message can be decrypted.</p>
<h1><a class="anchor" id="autotoc_md2284"></a>
Rationale</h1>
<p>The solution is reasonable to all users who are in favor of GPG. Also the solution might lead to a decline in dependencies (i.e. all cryptographic operations could be handled by the gpg binary).</p>
<p>The constraints considering the key handling are met.</p>
<h1><a class="anchor" id="autotoc_md2285"></a>
Implications</h1>
<p>To manipulate the plugin configuration during the <b>mount phase</b> a hook is required within the <code>BackendBuilder</code>. See pull request <a href="https://github.com/ElektraInitiative/libelektra/pull/733">#733</a> for full discussion.</p>
<h1><a class="anchor" id="autotoc_md2286"></a>
Related Decisions</h1>
<h1><a class="anchor" id="autotoc_md2287"></a>
Notes</h1>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
