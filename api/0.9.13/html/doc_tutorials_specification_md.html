<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: How to Write a Specification in Elektra</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.9.13</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">How to Write a Specification in Elektra </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_tutorials_specification"></a> </p>
<h1><a class="anchor" id="autotoc_md4445"></a>
Overview</h1>
<h2><a class="anchor" id="autotoc_md4446"></a>
Introduction</h2>
<p>In this tutorial you will learn how to interactively use the <code>SpecElektra</code> specification language and <code>kdb</code> to write a configuration specification for an example application.</p>
<h2><a class="anchor" id="autotoc_md4447"></a>
What you should already know</h2>
<ul>
<li><a href="https://www.libelektra.org/getstarted/guide#installation">how to install Elektra</a></li>
<li>basic Elektra commands and concepts (<code>kdb get</code>, <code>kdb set</code>, <code>kdb ls</code>)</li>
<li>how to open and use a terminal</li>
</ul>
<h2><a class="anchor" id="autotoc_md4448"></a>
What youâ€™ll learn</h2>
<ul>
<li>how to create and mount a specification using <code>kdb</code></li>
<li>how to add keys with different types, defaults and examples to your specification and how to validate them</li>
<li>the benefits of using <code>kdb</code> to generate a specification, instead of writing one by hand</li>
<li>how to use the final specification during the installation process of applications</li>
</ul>
<h2><a class="anchor" id="autotoc_md4449"></a>
What you'll do</h2>
<ul>
<li>use <code>kdb</code> to create and mount a specification for an example CRUD (Create, Read, Update, Delete) application</li>
<li>define defaults, examples and checks for keys in the validation</li>
<li>use the specification as a starting point for customizing the configuration of installed applications</li>
</ul>
<h1><a class="anchor" id="autotoc_md4450"></a>
Example App Overview</h1>
<p>For this tutorial you will write a specification for a simple CRUD backend application. You need to configure a <code>port</code> and a <code>secure</code> property, that toggles SSL usage, for the REST server. An <code>ip</code> and a SQL <code>dialect</code> for the database server the app will connect to and finally a <code>date</code> where all the data will be saved to a backup.</p>
<p>So the application will need the following configuration options:</p>
<ul>
<li>a server port</li>
<li>server secure</li>
<li>a database ip</li>
<li>a database dialect</li>
<li>a backup date</li>
</ul>
<h1><a class="anchor" id="autotoc_md4451"></a>
Getting Started</h1>
<p>Make sure you have <code>Elektra</code> installed on your local machine:</p>
<div class="fragment"><div class="line">kdb --version</div>
<div class="line"> </div>
<div class="line"># KDB_VERSION: 0.9.9</div>
<div class="line"># SO_VERSION: 5</div>
</div><!-- fragment --><p>Otherwise refer to the <a href="https://www.libelektra.org/getstarted/guide">getting started guide</a> to install it.</p>
<h1><a class="anchor" id="autotoc_md4452"></a>
Mounting the Specification</h1>
<h2><a class="anchor" id="autotoc_md4453"></a>
Step 1: Mount a Specification File</h2>
<p>First you need to mount a specification file, in this case <code>spec.ni</code> to the <code>spec:/</code> namespace. You can define the path inside the <code>spec:/</code> namespace as <code>/tests/sw/org/app/#0/current</code>, refer to <a href="https://www.libelektra.org/tutorials/integration-of-your-c-application">the documentation</a> to find out more about constructing the name.</p>
<p>You will be using the profile <code>current</code>, you can find out more about profiles in <a href="https://www.libelektra.org/plugins/profile">the documentation</a> as well.</p>
<p>We will be writing values mostly to the <code>user:/</code> namespace. If you want to learn more about namespaces in general, refer to the <a href="https://www.libelektra.org/tutorials/namespaces">the documentation on namespaces</a></p>
<p>You also need to specify the plugin you will use for writing to the file in the correct format. In this case you can choose the <code>ni</code> plugin to write to the specification file.</p>
<div class="fragment"><div class="line">sudo kdb mount `pwd`/spec.ni spec:/tests/sw/org/app/\#0/current ni</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>**_Attention_**: Mounting the specification by supplying an absolute path (like in the previous example with <code>`pwd`</code>) is only recommended for defining the specification in the first place. It is not recommended when mounting the final specification for usage with the application, especially not in production environments!</p>
<p>Please read the section <a href="#elektra-use-spec">Using the specification</a> at the end of this document for further information. </p>
</blockquote>
<p>Using the command below you can get the location of the concrete file that is used by Elektra.</p>
<div class="fragment"><div class="line">kdb file spec:/tests/sw/org/app/\#0/current</div>
<div class="line"># /current/working/directory/spec.ni</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md4454"></a>
Step 2: Define a mountpoint</h2>
<p>Next you can define, that this specification uses a specific mountpoint for a concrete application configuration. So you can say the concrete configuration should be written to <code>app.ni</code>.</p>
<div class="fragment"><div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current mountpoint app.ni</div>
</div><!-- fragment --><p>Your <code>spec.ni</code> file should now look something like this:</p>
<div class="fragment"><div class="line">cat $(kdb file spec:/tests/sw/org/app/\#0/current)</div>
<div class="line"> </div>
<div class="line"># ;Ni1</div>
<div class="line"># ; Generated by the ni plugin using Elektra (see libelektra.org).</div>
<div class="line"> </div>
<div class="line"># =</div>
<div class="line"> </div>
<div class="line"># []</div>
<div class="line">#  meta:/mountpoint = app.ni</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md4455"></a>
Step 3: Do a specification mount</h2>
<div class="fragment"><div class="line">sudo kdb spec-mount /tests/sw/org/app/\#0/current ni</div>
</div><!-- fragment --><p>This specification mount makes sure that the paths where the concrete configuration should be (<code>app.ni</code>) are ready to fulfill our specification (<code>spec.ni</code>). Be aware that different files get mounted for different namespaces. You've a specification file (<code>spec.ni</code>) for the <code>spec</code>-namespace and three files (<code>app.ni</code>) on different locations for the <code>dir</code>- <code>user</code>- and <code>system</code>-namespaces.</p>
<p>You can see the files by providing the namespace as prefix to the <code>kdb file</code> command:</p>
<div class="fragment"><div class="line">kdb file system:/tests/sw/org/app/#0/current</div>
<div class="line"># /etc/kdb/app.ni</div>
<div class="line"> </div>
<div class="line">kdb file user:/tests/sw/org/app/#0/current</div>
<div class="line"># /home/user/.config/app.ni</div>
<div class="line"> </div>
<div class="line">kdb file dir:/tests/sw/org/app/#0/current</div>
<div class="line"># /current/working/directory/.dir/app.ni</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>**_Note_**: The files only exist, when configuration values are stored there, i.e. they are created on the first <code>kdb set</code> and removed with the last <code>kdb rm</code>. </p>
</blockquote>
<p>For more information about namespaces in Elektra please see <a href="https://www.libelektra.org/man-pages/elektra-namespaces">here</a>, a tutorial about the topic is available <a href="https://www.libelektra.org/tutorials/namespaces">here</a>.</p>
<h1><a class="anchor" id="autotoc_md4456"></a>
Adding your first key to the specification</h1>
<h2><a class="anchor" id="autotoc_md4457"></a>
Step 1: Adding the server port</h2>
<p>The first key you will add to your specification is the port of the server. You add it by using the following command:</p>
<div class="fragment"><div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/server/port type unsigned_short</div>
</div><!-- fragment --><p>What you also specified in the command above is the type of the configuration value. Elektra uses the <a href="https://www.libelektra.org/plugins/type">CORBA type system</a> and will check if values conform to the type specified.</p>
<p>So after adding the initial key, your specification should look something like this:</p>
<div class="fragment"><div class="line">cat $(kdb file spec:/tests/sw/org/app/\#0/current)</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"># ;Ni1</div>
<div class="line"># ; Generated by the ni plugin using Elektra (see libelektra.org).</div>
<div class="line"> </div>
<div class="line">#  =</div>
<div class="line"># server/port =</div>
<div class="line"> </div>
<div class="line"># []</div>
<div class="line">#  meta:/mountpoint = app.ni</div>
<div class="line"> </div>
<div class="line"># [server/port]</div>
<div class="line">#  meta:/type = unsigned_short</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md4458"></a>
Step 2: Adding more metadata</h2>
<p>So with your first key added, you of course want to specify more information for the port. There surely is more information to a port than just the type. What about a <code>default</code>, or what about an <code>example</code> for a usable port? Maybe a <code>description</code> what the port really is for? Let's add that next!</p>
<div class="fragment"><div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/server/port default 8080</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/server/port example 8080</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/server/port description &quot;port of the REST server that runs the application&quot;</div>
</div><!-- fragment --><p>Beautiful! Your specification is starting to look like something useful. But wait! Shouldn't a port just use values between <code>1</code> and <code>65535</code>?</p>
<p>Of course Elektra also has a plugin for that. You can just use the <a href="https://www.libelektra.org/plugins/network">network</a> checker plugin.</p>
<div class="fragment"><div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/server/port check/port &#39;&#39;</div>
</div><!-- fragment --><p>Now we define the plugins that we want to load. In our example we need the <code>ni</code>-Plugin for reading and writing the configuration files, the <code>type</code>-plugin for validating data types and the <code>network</code>-plugin for validating port numbers.</p>
<div class="fragment"><div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current infos/plugins &quot;ni type network&quot;</div>
</div><!-- fragment --><p>Nice! You just have to do one more thing when using a new plugin. Elektra needs to remount the spec to use the new plugin. Use the command from before:</p>
<div class="fragment"><div class="line">sudo kdb spec-mount /tests/sw/org/app/\#0/current</div>
</div><!-- fragment --><p>Your final specification after adding the port should now look something like this:</p>
<div class="fragment"><div class="line">cat $(kdb file spec:/tests/sw/org/app/\#0/current)</div>
<div class="line"> </div>
<div class="line"># ;Ni1</div>
<div class="line"># ; Generated by the ni plugin using Elektra (see libelektra.org).</div>
<div class="line"> </div>
<div class="line">#  =</div>
<div class="line"># server/port =</div>
<div class="line"> </div>
<div class="line"># []</div>
<div class="line">#  meta:/mountpoint = app.ni</div>
<div class="line">#  meta:/infos/plugins = ni type network</div>
<div class="line"> </div>
<div class="line"># [server/port]</div>
<div class="line">#  meta:/check/port =</div>
<div class="line">#  meta:/type = unsigned_short</div>
<div class="line">#  meta:/example = 8080</div>
<div class="line">#  meta:/description = port of the REST server that runs the application</div>
<div class="line">#  meta:/default = 8080</div>
</div><!-- fragment --><p>You can now try to read the value of the newly created configuration. Since you did not set the value to anything yet, you will get the default value back.</p>
<div class="fragment"><div class="line">kdb get /tests/sw/org/app/\#0/current/server/port</div>
<div class="line"> </div>
<div class="line">#&gt; 8080</div>
</div><!-- fragment --><p>Try to set the port to <code>65536</code> now.</p>
<div class="fragment"><div class="line">kdb set user:/tests/sw/org/app/\#0/current/server/port 65536</div>
<div class="line"># RET: 5</div>
<div class="line">#  Sorry, 1 warning was issued ;(</div>
<div class="line">#  1: Module network issued the warning C03200:</div>
<div class="line">#       Validation Semantic: Port 65536 on key user:/tests/sw/org/app/#0/current/server/port was not within 0 - 65535</div>
<div class="line"># Sorry, module type issued the error C03200:</div>
<div class="line"># Validation Semantic: The type &#39;unsigned_short&#39; failed to match for &#39;user:/tests/sw/org/app/#0/current/server/port&#39; with string &#39;65536&#39;</div>
</div><!-- fragment --><p>Did it work? I hope not. The validation plugins you specified will now correctly validate the port you enter and give you an error.</p>
<p>In this example, the <code>network</code> plugin and the <code>type</code> plugin are emitting warnings or errors, because the valid ranges for <code>port</code> and <code>unsigned_short</code> are the same.</p>
<h2><a class="anchor" id="autotoc_md4459"></a>
Step 3: Adding boolean keys</h2>
<p>Next up you will configure the <code>secure</code> property of our server. This boolean key will toggle if your server encrypts the communication via SSL.</p>
<p>So we will add the key and some metadata for it:</p>
<div class="fragment"><div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/server/secure type boolean</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/server/secure default 1</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/server/secure example 0</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/server/secure description &quot;true if the REST server uses SSL for communication&quot;</div>
</div><!-- fragment --><p>By default the <code>type</code> plugin will normalize boolean values when setting them, before storing them. This only works for the concrete config, so when setting the values for the spec you have to use the unnormalized values. In the case it uses <code>1</code> for boolean <code>true</code> and <code>0</code> for boolean <code>false</code>.</p>
<p>Since the key <code>/sw/org/app/\#0/current/server/secure</code> has a default value of <code>1</code>, we are able to retrieve the default value from the key database:</p>
<div class="fragment"><div class="line">kdb get /tests/sw/org/app/\#0/current/server/secure</div>
<div class="line"> </div>
<div class="line">#&gt; 1</div>
</div><!-- fragment --><p>You can read more about this in the documentation for the <a href="https://www.libelektra.org/plugins/type#normalization">type plugin</a>.</p>
<h1><a class="anchor" id="autotoc_md4460"></a>
Adding the database keys to the specification</h1>
<h2><a class="anchor" id="autotoc_md4461"></a>
Step 1: Adding the database ip</h2>
<p>Next up you will add a key for the database <code>ip</code> address. Like with the key before, you will add a <code>type</code>, <code>default</code>, <code>example</code> and a <code>description</code> so that the configuration will be easily usable.</p>
<p>Don't forget the most important rule of configurations: <b>Always add sensible defaults!</b></p>
<p>Now let's try something different. What if you change the file manually? Will Elektra pick up on the changes? And save you from writing <b>a lot</b> of <code>kdb</code> commands?</p>
<p><em>of course</em></p>
<p>So just open your file using good old <code>vim</code> and add the following lines to specify configuration for the <code>ip</code> address.</p>
<div class="fragment"><div class="line">vim $(kdb file spec:/tests/sw/org/app/\#0/current)</div>
<div class="line"> </div>
<div class="line"># ;Ni1</div>
<div class="line"># ; Generated by the ni plugin using Elektra (see libelektra.org).</div>
<div class="line"> </div>
<div class="line">database/ip =</div>
<div class="line">#  =</div>
<div class="line"># server/port =</div>
<div class="line"># server/secure =</div>
<div class="line"> </div>
<div class="line">[database/ip]</div>
<div class="line"> meta:/check/ipaddr =</div>
<div class="line"> meta:/type = string</div>
<div class="line"> meta:/example = 127.0.0.1</div>
<div class="line"> meta:/description = ip address of the database server, that the application will connect to</div>
<div class="line"> meta:/default = 127.0.0.1</div>
<div class="line"> </div>
<div class="line"># []</div>
<div class="line">#  meta:/mountpoint = app.ni</div>
<div class="line">#  meta:/infos/plugins = ni type network</div>
<div class="line"> </div>
<div class="line"># [server/port]</div>
<div class="line">#  meta:/check/port =</div>
<div class="line">#  meta:/type = unsigned_short</div>
<div class="line">#  meta:/example = 8080</div>
<div class="line">#  meta:/description = port of the REST server that runs the application</div>
<div class="line">#  meta:/default = 8080</div>
<div class="line"> </div>
<div class="line"># [server/secure]</div>
<div class="line">#  meta:/type = boolean</div>
<div class="line">#  meta:/example = 0</div>
<div class="line">#  meta:/description = true if the REST server uses SSL for communication</div>
<div class="line">#  meta:/default = 1</div>
</div><!-- fragment --><p>Alternatively you can of course use <code>kdb</code> again to set the configuration values that way. Here are the commands to do that.</p>
<div class="fragment"><div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/database/ip type string</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/database/ip default 127.0.0.1</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/database/ip example 127.0.0.1</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/database/ip description &quot;ip address of the database server, that the application will connect to&quot;</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/database/ip check/ipaddr &#39;&#39;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md4462"></a>
Step 2: Adding the database dialect</h2>
<p>Next up you will add a key for the SQL <code>dialect</code> the database will use. Since there are only a few databases your application will support, you can define the possible dialects via an <a href="https://www.libelektra.org/plugins/type#enums">enum</a> type. This allows us to prohibit all other possible dialects that are not SQL.</p>
<p>First you define the size of the <code>enum</code> type, and then you can add the different <code>enum</code> values.</p>
<div class="fragment"><div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/database/dialect type enum</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/database/dialect check/enum &quot;#4&quot;</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/database/dialect check/enum/\#0 postgresql</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/database/dialect check/enum/\#1 mysql</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/database/dialect check/enum/\#2 mssql</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/database/dialect check/enum/\#3 mariadb</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/database/dialect check/enum/\#4 sqlite</div>
</div><!-- fragment --><p>Afterwards you define all the other parameters, just as before.</p>
<div class="fragment"><div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/database/dialect default sqlite</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/database/dialect example mysql</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/database/dialect description &quot;SQL dialect of the database server, that the application will connect to&quot;</div>
</div><!-- fragment --><p>After this meta-setting bonanza your specification file should look something like this:</p>
<div class="fragment"><div class="line">cat $(kdb file spec:/tests/sw/org/app/\#0/current)</div>
<div class="line"> </div>
<div class="line"># ;Ni1</div>
<div class="line"># ; Generated by the ni plugin using Elektra (see libelektra.org).</div>
<div class="line"> </div>
<div class="line"># database/ip =</div>
<div class="line">#  =</div>
<div class="line"># server/port =</div>
<div class="line"># server/secure =</div>
<div class="line"># database/dialect =</div>
<div class="line"> </div>
<div class="line"># [database/ip]</div>
<div class="line">#  meta:/check/ipaddr =</div>
<div class="line">#  meta:/type = string</div>
<div class="line">#  meta:/example = 127.0.0.1</div>
<div class="line">#  meta:/description = ip address of the database server, that the application will connect to</div>
<div class="line">#  meta:/default = 127.0.0.1</div>
<div class="line"> </div>
<div class="line"># []</div>
<div class="line">#  meta:/mountpoint = app.ni</div>
<div class="line">#  meta:/infos/plugins = ni type network</div>
<div class="line"> </div>
<div class="line"># [server/port]</div>
<div class="line">#  meta:/check/port =</div>
<div class="line">#  meta:/type = unsigned_short</div>
<div class="line">#  meta:/example = 8080</div>
<div class="line">#  meta:/description = port of the REST server that runs the application</div>
<div class="line">#  meta:/default = 8080</div>
<div class="line"> </div>
<div class="line"># [server/secure]</div>
<div class="line">#  meta:/type = boolean</div>
<div class="line">#  meta:/example = 0</div>
<div class="line">#  meta:/description = true if the REST server uses SSL for communication</div>
<div class="line">#  meta:/default = 1</div>
<div class="line"> </div>
<div class="line"># [database/dialect]</div>
<div class="line">#  meta:/check/enum/#2 = mssql</div>
<div class="line">#  meta:/check/enum/\#0 = postgresql</div>
<div class="line">#  meta:/type = enum</div>
<div class="line">#  meta:/check/enum/#1 = mysql</div>
<div class="line">#  meta:/example = mysql</div>
<div class="line">#  meta:/description = SQL dialect of the database server, that the application will connect to</div>
<div class="line">#  meta:/check/enum/#4 = sqlite</div>
<div class="line">#  meta:/check/enum/#3 = mariadb</div>
<div class="line">#  meta:/default = sqlite</div>
<div class="line">#  meta:/check/enum = #4</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md4463"></a>
Adding the backup date</h1>
<p>The last key you will add to our specification is a <code>date</code> key for the annual backup and restart (this should probably not be annually in a real application). Here you use the <a href="https://www.libelektra.org/plugins/date">check/date</a> plugin with the <code>ISO8601</code> format. You also specify a <code>check/date/format</code>. You can find all possible date formats on the <a href="https://www.libelektra.org/plugins/date">plugin page</a>. For this you can use the following commands:</p>
<div class="fragment"><div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/backup/date type string</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/backup/date check/date ISO8601</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/backup/date check/date/format &quot;calendardate complete extended&quot;</div>
</div><!-- fragment --><p>Then just add examples, defaults and description as always.</p>
<div class="fragment"><div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/backup/date default 2021-11-01</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/backup/date example 2021-01-12</div>
<div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current/backup/date description &quot;date of the annual server and database backup&quot;</div>
</div><!-- fragment --><p>Now we add the validation plugin for dates and remount the specification:</p>
<div class="fragment"><div class="line">kdb meta-set spec:/tests/sw/org/app/\#0/current infos/plugins &quot;ni type network date&quot;</div>
<div class="line">sudo kdb spec-mount /tests/sw/org/app/\#0/current</div>
</div><!-- fragment --><p>If we try to add a value that is not in the specified format, an error should get emitted.</p>
<div class="fragment"><div class="line">kdb set user:/tests/sw/org/app/\#0/current/backup/date &quot;03.04.2022&quot;</div>
<div class="line"># RET: 5</div>
<div class="line"># Sorry, module date issued the error C03100:</div>
<div class="line"># Validation Syntactic: Date &#39;03.04.2022&#39; doesn&#39;t match iso specification calendardate complete extended</div>
</div><!-- fragment --><p>To double-check if things are correct, we try to get the value from the <code>user</code>-namespace and via cascading lookup.</p>
<div class="fragment"><div class="line">kdb get user:/tests/sw/org/app/\#0/current/backup/date</div>
<div class="line"># RET: 11</div>
<div class="line"># STDERR: Did not find key &#39;user:/tests/sw/org/app/#0/current/backup/date&#39;</div>
<div class="line"> </div>
<div class="line">kdb get /tests/sw/org/app/\#0/current/backup/date</div>
<div class="line">#&gt; 2021-11-01</div>
</div><!-- fragment --><p>As expected, no value was written to the <code>user</code>-namespace and a cascading lookup returns the date that was given as default value in the specification. If we now use the correct format, the new date should be stored in the <code>user</code>-namespace and retrieved with both <code>kdb get</code> lookups.</p>
<div class="fragment"><div class="line">kdb set user:/tests/sw/org/app/\#0/current/backup/date &quot;2022-04-03&quot;</div>
<div class="line">#&gt; Create a new key user:/tests/sw/org/app/#0/current/backup/date with string &quot;2022-04-03&quot;</div>
<div class="line"> </div>
<div class="line">kdb get user:/tests/sw/org/app/\#0/current/backup/date</div>
<div class="line">#&gt; 2022-04-03</div>
<div class="line"> </div>
<div class="line">kdb get /tests/sw/org/app/\#0/current/backup/date</div>
<div class="line">#&gt; 2022-04-03</div>
</div><!-- fragment --><p>If we explicitly query the <code>system</code>-namespace, no key is found.</p>
<div class="fragment"><div class="line">kdb get system:/tests/sw/org/app/\#0/current/backup/date</div>
<div class="line"># RET: 11</div>
<div class="line"># STDERR: Did not find key &#39;system:/tests/sw/org/app/#0/current/backup/date&#39;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md4464"></a>
Final specification code</h1>
<p>Your specification should be complete now! After adding all the keys that are necessary for our application, your specification should look something like this:</p>
<div class="fragment"><div class="line">cat $(kdb file spec:/tests/sw/org/app/\#0/current)</div>
<div class="line"> </div>
<div class="line"># ;Ni1</div>
<div class="line"># ; Generated by the ni plugin using Elektra (see libelektra.org).</div>
<div class="line"> </div>
<div class="line"># backup/date =</div>
<div class="line"># database/ip =</div>
<div class="line">#  =</div>
<div class="line"># server/port =</div>
<div class="line"># server/secure =</div>
<div class="line"># database/dialect =</div>
<div class="line"> </div>
<div class="line"># [backup/date]</div>
<div class="line">#  meta:/check/date/format = calendardate complete extended</div>
<div class="line">#  meta:/type = string</div>
<div class="line">#  meta:/example = 2021-01-12</div>
<div class="line">#  meta:/description = date of the annual server and database backup</div>
<div class="line">#  meta:/default = 2021-11-01</div>
<div class="line">#  meta:/check/date = ISO8601</div>
<div class="line"> </div>
<div class="line"># [database/ip]</div>
<div class="line">#  meta:/check/ipaddr =</div>
<div class="line">#  meta:/type = string</div>
<div class="line">#  meta:/example = 127.0.0.1</div>
<div class="line">#  meta:/description = ip address of the database server, that the application will connect to</div>
<div class="line">#  meta:/default = 127.0.0.1</div>
<div class="line"> </div>
<div class="line"># []</div>
<div class="line">#  meta:/mountpoint = app.ni</div>
<div class="line">#  meta:/infos/plugins = ni type network date</div>
<div class="line"> </div>
<div class="line"># [server/port]</div>
<div class="line">#  meta:/check/port =</div>
<div class="line">#  meta:/type = unsigned_short</div>
<div class="line">#  meta:/example = 8080</div>
<div class="line">#  meta:/description = port of the REST server that runs the application</div>
<div class="line">#  meta:/default = 8080</div>
<div class="line"> </div>
<div class="line"># [server/secure]</div>
<div class="line">#  meta:/type = boolean</div>
<div class="line">#  meta:/example = 0</div>
<div class="line">#  meta:/description = true if the REST server uses SSL for communication</div>
<div class="line">#  meta:/default = 1</div>
<div class="line"> </div>
<div class="line"># [database/dialect]</div>
<div class="line">#  meta:/check/enum/#2 = mssql</div>
<div class="line">#  meta:/check/enum/\#0 = postgresql</div>
<div class="line">#  meta:/type = enum</div>
<div class="line">#  meta:/check/enum/#1 = mysql</div>
<div class="line">#  meta:/example = mysql</div>
<div class="line">#  meta:/description = SQL dialect of the database server, that the application will connect to</div>
<div class="line">#  meta:/check/enum/#4 = sqlite</div>
<div class="line">#  meta:/check/enum/#3 = mariadb</div>
<div class="line">#  meta:/default = sqlite</div>
<div class="line">#  meta:/check/enum = #4</div>
</div><!-- fragment --><p><a class="anchor" id="elektra-use-spec"></a></p>
<h1><a class="anchor" id="autotoc_md4465"></a>
Using the specification</h1>
<p>Now, after you've finished your specification and want to use it for daily business, some aspects have to be considered. A specification usually is written to cover the most common use cases and to provide sensible defaults. In some cases, the administrator may want to change the specification, e.g. for extending it or introducing further restrictions.</p>
<p>In such cases, <b>directly changing</b> the specification that was designed for and delivered with the application, is <b>not</b> the <b>recommended</b> approach.</p>
<p>The recommended way is making a <b>copy</b> of the default specification while installing the application and then saving changes to that copy. If misconfiguration occurs, you can easily look at the default specification or reapply it to start over.</p>
<p>If you mount the specification with an absolute path (e.g. by using <code>`pwd`</code> in scripts), like it was done for defining the specification with <code>kdb</code>, the file gets changed directly. If <code>`pwd`</code> refers to the installation directory of the application, this would be totally fine, but if this is done during development and <code>`pwd`</code> refers to the source directory, the source specification would be modified via <code>kdb set spec:/...</code> calls.</p>
<p>First we have to unmount our original configuration file we just created:</p>
<div class="fragment"><div class="line">sudo kdb umount spec:/tests/sw/org/app/\#0/current</div>
</div><!-- fragment --><p>The <b>recommended way</b> to apply the specification is:</p>
<div class="fragment"><div class="line"># choose a unique filename for your application instead of spec.ni</div>
<div class="line">sudo kdb mount spec.ni spec:/tests/sw/org/app/\#0/current ni</div>
<div class="line">sudo kdb import spec:/tests/sw/org/app/\#0/current ni ./spec.ni</div>
</div><!-- fragment --><p>Because we used a relative path (not starting with <code>/</code>), Elektra will use a file within the <code>spec</code> directory (<code>/usr/share/elektra/specification</code> by default) for storing the specification.</p>
<p>The <code>kdb import</code> command just tells Elektra to load the file <code>./spec.ni</code> with the <code>ni</code> plugin and write it into <code>spec:/tests/sw/org/app/\#0/current</code>. Using a separate <code>kdb import</code> also means we could use a different storage plugin for mounting than what <code>./spec.ni</code> uses.</p>
<p>Another alternative is copying the file manually:</p>
<div class="fragment"><div class="line">sudo kdb mount spec.ni spec:/tests/sw/org/app/\#0/current ni</div>
<div class="line">sudo cp ./spec.ni $(kdb file spec:/tests/sw/org/app/\#0/current)</div>
</div><!-- fragment --><p>This works like the previous snippet, except that we directly modify the spec file without going through Elektra. For very big specifications this might be faster, but we get no validation that the file is actually readable and <code>./spec.ni</code> has to be readable by the storage plugin used with <code>kdb mount</code>.</p>
<p>Finally, in some cases you may want to control where the mounted spec file is stored (e.g. if you are updating a legacy application that has an existing configuration directory). In those cases using an absolute path is fine:</p>
<div class="fragment"><div class="line">kdb mount /etc/spec.ni spec:/tests/sw/org/app/\#0/current ni</div>
<div class="line">kdb import spec:/tests/sw/org/app/\#0/current ni ./my-spec.ini</div>
</div><!-- fragment --><p>or</p>
<div class="fragment"><div class="line">sudo kdb mount /etc/spec.ni spec:/tests/sw/org/app/\#0/current ni</div>
<div class="line">sudo cp ./spec.ni $(kdb file spec:/tests/sw/org/app/\#0/current)</div>
</div><!-- fragment --><p>Please note that also in these examples, the file referred to by the absolute path <code>/etc/spec.ni</code> is a <b>new file</b> where the content of the file <code>./spec.ni</code> in the working directory gets imported or copied to.</p>
<h1><a class="anchor" id="autotoc_md4466"></a>
Cleanup</h1>
<p>If you want to remove the files that were created in the course of the tutorial, the following steps are necessary.</p>
<div class="fragment"><div class="line">sudo rm -v `kdb file spec:/tests/sw/org/app/#0/current`</div>
<div class="line">rm -v `kdb file user:/tests/sw/org/app/#0/current`</div>
<div class="line">sudo rm -v /usr/share/elektra/specification/spec.ni</div>
<div class="line">sudo rm -v /etc/spec.ni</div>
</div><!-- fragment --><p>If you take a look at <code>kdb mount</code>, you'll see that there are currently two mountpoints open.</p>
<p>Mountpoints are meant to mount (external) files into the key database structure of Elektra. This mechanism is similar to <code>mount</code> on Linux: changes made to the key database will be written to the underlying mounted file. If you want to learn more on mounting and mountpoints in Eletra, refer to <a href="https://www.libelektra.org/tutorials/mount-configuration-files">the documentation</a>.</p>
<p>To round up this tutorial, we will <code>kdb umount</code> these two mountpoints:</p>
<div class="fragment"><div class="line">rm -v ./spec.ni</div>
<div class="line">sudo kdb umount /tests/sw/org/app/#0/current</div>
</div><!-- fragment --><div class="fragment"><div class="line">sudo kdb umount spec:/tests/sw/org/app/#0/current</div>
</div><!-- fragment --><p>In case something went wrong and you want to reset the whole content of your kdb, please refer to <a href="https://www.libelektra.org/man-pages/kdb-reset">the man page of kdb reset</a>.</p>
<h1><a class="anchor" id="autotoc_md4467"></a>
Summary</h1>
<ul>
<li>You set up and mounted a specification using <code>kdb mount</code> and <code>kdb spec-mount</code>.</li>
<li>You added keys to the specification using <code>kdb meta-set</code>.</li>
<li>You added different types of keys with <code>type string</code>, <code>type boolean</code> or <code>type unsigned_short</code>.</li>
<li>You added keys with <code>enum types</code>, to restrict specific configuration settings to a defined set of possible values.</li>
<li>You added default parameters, examples and descriptions with <code>example</code>, <code>default</code>, <code>description</code>.</li>
<li>You also added validation checks using different plugins, like <code>check/port</code> or <code>check/date</code>.</li>
<li>You know how to use the specification for installed applications (esp. in production environments).</li>
</ul>
<h1><a class="anchor" id="autotoc_md4468"></a>
Learn more</h1>
<ul>
<li><a href="https://www.libelektra.org/tutorials/readme">Tutorial Overview</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
