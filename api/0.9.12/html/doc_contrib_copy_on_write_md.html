<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Copy-on-Write</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.9.12</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Copy-on-Write </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_contrib_copy_on_write"></a> The two basic Elektra datastructures <code>Key</code> and <code>KeySet</code> implement full copy-on-write (COW) functionality. If a key or a keyset gets copied, only a shallow copy with references to the original data (name, value, contained keys, etc.) is created. When this shared data is modified, new memory is allocated to keep the shared version in tact. Each piece of data (name, value, etc.) has a separate reference count to facilitate this. As a consequence, duplicated keys or keysets only require a fraction of the memory compared to their source counterparts.</p>
<h1><a class="anchor" id="autotoc_md1695"></a>
Working principle</h1>
<p>The main principle for the copy-on-write approach is simple: separate the data from the identity of a <code>Key</code> or <code>KeySet</code>. Developers using Elektra only get references to <code>Key</code> and <code>KeySet</code> objects. Those objects themselves do not hold any data. They only contain references to other entities holding the data. This allows transparently sharing the data-holding entities between multiple identifying entities.</p>
<p>The main entities for copy-on-write are depicted in the following diagram:</p>
<div class="fragment"><div class="line">classDiagram</div>
<div class="line">    Key *-- &quot;0..1&quot; KeyName : keyName</div>
<div class="line">    Key *-- &quot;0..1&quot; KeyData : keyData</div>
<div class="line"> </div>
<div class="line">    KeySet *-- &quot;0..1&quot; KeySetData : data</div>
<div class="line"> </div>
<div class="line">    Key o-- &quot;0..1&quot; KeySet : meta</div>
<div class="line">    KeySetData o-- &quot;*&quot; Key : array</div>
<div class="line"> </div>
<div class="line">    Key : - uint16_t refs</div>
<div class="line">    Key : - keyflag_t flags</div>
<div class="line"> </div>
<div class="line">    KeyName : - char * name</div>
<div class="line">    KeyName : - char * uname</div>
<div class="line">    KeyName : - uint16_t refs</div>
<div class="line">    KeyName : - uint16_t flags</div>
<div class="line"> </div>
<div class="line">    KeyData : - void * data</div>
<div class="line">    KeyData : - uint16_t refs</div>
<div class="line">    KeyData : - uint16_t flags</div>
<div class="line"> </div>
<div class="line">    KeySet : - uint16_t refs</div>
<div class="line">    KeySet : - ksflag_t flags</div>
<div class="line"> </div>
<div class="line">    KeySetData : - uint16_t refs</div>
<div class="line">    KeySetData : - uint16_t flags</div>
</div><!-- fragment --><ul>
<li><code>Key</code>: logically represents a key. No data is actually stored in it.<ul>
<li><code>KeyName</code>: holds the name of a key. May be shared between multiple <code>Key</code> objects.</li>
<li><code>KeyData</code>: holds the value of a key. May be shared between multiple <code>Key</code> objects.</li>
</ul>
</li>
<li><code>KeySet</code>: logically represents a collection of keys. No data is actually stored in it.<ul>
<li><code>KeySetData</code>: holds an array of <code>Key</code> objects. May be shared between multiple <code>KeySet</code> objects.</li>
</ul>
</li>
</ul>
<p>When creating instances of <code>Key</code> and <code>KeySet</code> via <code>keyNew</code> or <code>ksNew</code>, we allocate the least amount possible. For <code>Key</code>, we only allocate a <code>KeyName</code> entity (while not technically necessary, it significantly simplifies some internal uses). For <code>KeySet</code>, we allocate no other entities. The missing entities will get allocated when needed.</p>
<p>If the name of a key gets modified, we first ensure that the <code>Key</code> holds the only reference to its <code>KeyName</code>. If it isn't, then a new <code>KeyName</code> object is allocated for it. Depending on the type of modification, the value of the name is also copied. The modifications to the name are then performed on the new <code>KeyName</code> entity.</p>
<p>The same applies for the value of a key, and for the data contained in keysets.</p>
<p>When copying the name or value of a key, or data of a keyset, via <code>keyCopy</code>, <code>ksCopy</code>, <code>keyDup</code> or <code>ksDup</code>, we point the according references in the <code>destination</code> object to the entities of the <code>source</code> object. The reference counter of those entities is increased accordingly. The previous entities of the <code>destination</code> object will get their reference count decreased, and if they reach 0 they will be <code>free</code>d.</p>
<h1><a class="anchor" id="autotoc_md1696"></a>
Reference counting</h1>
<p>All entities are reference counted. The reference count is stored in each entity in an unsigned 16-bit integer variable <code>refs</code>. The special value <code>UINT16_MAX</code> is reserved as an error indicator, so the maximum number of references for each entity is <code>UINT16_MAX - 1</code> or 65534.</p>
<p>The reference counting mechanisms for <code>Key</code> and <code>KeySet</code> are part of the public API.</p>
<p>A reference count of 0 for <code>KeyName</code>, <code>KeyData</code> and <code>KeySetData</code> is illegal outside the public API function calls that cause the creation/deletion these structures.</p>
<h1><a class="anchor" id="autotoc_md1697"></a>
Integration with &lt;tt&gt;mmapstorage&lt;/tt&gt;</h1>
<p>The <code>mmapstorage</code> plugin needs a flag for every entity to indicate whether the entity is stored via <code>mmap</code> or normally allocated via <code>malloc</code>. If an entity is flagged as being stored in <code>mmap</code>, it must <b>never</b> be freed using <code>free</code>.</p>
<p>The following flags are responsible for each entity:</p>
<ul>
<li><code>Key</code>: <code>KEY_FLAG_MMAP_STRUCT</code> is set on the <code>flags</code> field</li>
<li><code>KeyName</code>: <code>KEY_FLAG_MMAP_KEY</code> is set on the <code>flags</code> field</li>
<li><code>KeyData</code>: <code>KS_FLAG_MMAP_Data</code> is set on the <code>flags</code> field</li>
<li><code>KeySet</code>: <code>KS_FLAG_MMAP_STRUCT</code> is set on the <code>flags</code> field</li>
<li><code>KeySetData</code>: <code>KS_FLAG_MMAP_ARRAY</code> is set on the <code>flags</code> field </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
