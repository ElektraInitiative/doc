<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Internal KeySet Cache</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.9.12</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Internal KeySet Cache </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_decisions_4_decided_internal_cache"></a> </p>
<h1><a class="anchor" id="autotoc_md2071"></a>
Problem</h1>
<p><code>kdbGet</code> might return more or fewer keys than requested. This was found confusing several times.</p>
<h2><a class="anchor" id="autotoc_md2072"></a>
More Keys</h2>
<p>Even if calling <code>kdbGet</code> with a parent key below a mountpoint, <code>kdbGet</code> will nevertheless return all keys of the mountpoint. Pseudo code example, assuming there is a mountpoint at <code>/mountpoint</code> and a key <code>/mountpoint/other</code>:</p>
<div class="fragment"><div class="line"><a class="code" href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a> (<a class="code" href="namespacekdb.html">kdb</a>, ks, <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a>(<span class="stringliteral">&quot;/mountpoint/below&quot;</span>));</div>
<div class="line">assert (<a class="code" href="group__keyset.html#ga60f1ddcf23272f2b29b90e92ebe9b56f">ksLookup</a> (ks, <span class="stringliteral">&quot;/mountpoint/other&quot;</span>) == NULL);</div>
<div class="ttc" id="agroup__kdb_html_ga28e385fd9cb7ccfe0b2f1ed2f62453a1"><div class="ttname"><a href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a></div><div class="ttdeci">int kdbGet(KDB *handle, KeySet *ks, Key *parentKey)</div><div class="ttdoc">Retrieve Keys from the Key database in an atomic and universal way.</div><div class="ttdef"><b>Definition:</b> kdb.c:1697</div></div>
<div class="ttc" id="agroup__key_html_gad23c65b44bf48d773759e1f9a4d43b89"><div class="ttname"><a href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a></div><div class="ttdeci">Key * keyNew(const char *name,...)</div><div class="ttdoc">A practical way to fully create a Key object in one step.</div><div class="ttdef"><b>Definition:</b> key.c:144</div></div>
<div class="ttc" id="agroup__keyset_html_ga60f1ddcf23272f2b29b90e92ebe9b56f"><div class="ttname"><a href="group__keyset.html#ga60f1ddcf23272f2b29b90e92ebe9b56f">ksLookup</a></div><div class="ttdeci">Key * ksLookup(KeySet *ks, Key *key, elektraLookupFlags options)</div><div class="ttdoc">Look for a Key contained in ks that matches the name of the key.</div><div class="ttdef"><b>Definition:</b> keyset.c:2717</div></div>
<div class="ttc" id="anamespacekdb_html"><div class="ttname"><a href="namespacekdb.html">kdb</a></div><div class="ttdoc">This is the main namespace for the C++ binding and libraries.</div><div class="ttdef"><b>Definition:</b> backend.hpp:31</div></div>
</div><!-- fragment --><p>It was found unexpected that this assert will fail.</p>
<p>In a similar fashion, calling <code>kdbSet</code> without the seemingly superfluous keys causes Elektra to unintentionally delete them from disk.</p>
<div class="fragment"><div class="line"><a class="code" href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a> (<a class="code" href="namespacekdb.html">kdb</a>, ks, <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a>(<span class="stringliteral">&quot;/mountpoint/below&quot;</span>));</div>
<div class="line">KeySet * below = <a class="code" href="group__keyset.html#ga6b00cf82b59af4d883a9bad6cf4a4a4a">ksCut</a> (ks, <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a>(<span class="stringliteral">&quot;/mountpoint/below&quot;</span>));</div>
<div class="line"> </div>
<div class="line">ksSet (<a class="code" href="namespacekdb.html">kdb</a>, below, <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a>(<span class="stringliteral">&quot;/mountpoint/below&quot;</span>));</div>
<div class="line"><span class="comment">// suddenly /mountpoint/other has been removed from the configuration file on disk, even if the user explicitly stated to only change stuff in /mountpoint/below</span></div>
<div class="ttc" id="agroup__keyset_html_ga6b00cf82b59af4d883a9bad6cf4a4a4a"><div class="ttname"><a href="group__keyset.html#ga6b00cf82b59af4d883a9bad6cf4a4a4a">ksCut</a></div><div class="ttdeci">KeySet * ksCut(KeySet *ks, const Key *cutpoint)</div><div class="ttdoc">Cuts out all Keys from KeySet ks that are below or at cutpoint.</div><div class="ttdef"><b>Definition:</b> keyset.c:1611</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2073"></a>
Fewer Keys</h2>
<p>When doing a second <code>kdbGet</code> with a new keyset no keys will be returned when no backends report changed data, because kdb internally thinks the data is already up-to-date:</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> test_doubleGet (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">        printf(<span class="stringliteral">&quot;running %s\n&quot;</span>, __func__);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Setup</span></div>
<div class="line">        Key * parentKey = <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a>(<span class="stringliteral">&quot;/somewhere&quot;</span>, <a class="code" href="group__keyset.html#ga7a28fce3773b2c873c94ac80b8b4cd54">KS_END</a>);</div>
<div class="line">        KeySet * ks = <a class="code" href="group__keyset.html#ga671e1aaee3ae9dc13b4834a4ddbd2c3c">ksNew</a>(0, <a class="code" href="group__keyset.html#ga7a28fce3773b2c873c94ac80b8b4cd54">KS_END</a>);</div>
<div class="line">        KDB * <a class="code" href="namespacekdb.html">kdb</a> = <a class="code" href="group__kdb.html#ga844e1299a84c3fbf1d3a905c5c893ba5">kdbOpen</a> (<a class="code" href="group__keyset.html#ga671e1aaee3ae9dc13b4834a4ddbd2c3c">ksNew</a>(0, <a class="code" href="group__keyset.html#ga7a28fce3773b2c873c94ac80b8b4cd54">KS_END</a>), parentKey);</div>
<div class="line">        <a class="code" href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a> (<a class="code" href="namespacekdb.html">kdb</a>, ks, parentKey);</div>
<div class="line">        <a class="code" href="group__keyset.html#gaa5a1d467a4d71041edce68ea7748ce45">ksAppendKey</a> (ks, <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (<span class="stringliteral">&quot;user:/somewhere&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8ac66e4a49d09212b79f5754ca6db5bd2e">KEY_VALUE</a>, <span class="stringliteral">&quot;abc&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>));</div>
<div class="line">        <a class="code" href="group__keyset.html#gaa5a1d467a4d71041edce68ea7748ce45">ksAppendKey</a> (ks, <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (<span class="stringliteral">&quot;user:/somewhere/key&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8ac66e4a49d09212b79f5754ca6db5bd2e">KEY_VALUE</a>, <span class="stringliteral">&quot;xyz&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>));</div>
<div class="line">        <a class="code" href="group__kdb.html#ga11436b058408f83d303ca5e996832bcf">kdbSet</a> (<a class="code" href="namespacekdb.html">kdb</a>, ks, parentKey);</div>
<div class="line">        <a class="code" href="group__kdb.html#gadb54dc9fda17ee07deb9444df745c96f">kdbClose</a> (<a class="code" href="namespacekdb.html">kdb</a>, parentKey);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Scenario</span></div>
<div class="line">        <a class="code" href="namespacekdb.html">kdb</a> = <a class="code" href="group__kdb.html#ga844e1299a84c3fbf1d3a905c5c893ba5">kdbOpen</a> (<a class="code" href="group__keyset.html#ga671e1aaee3ae9dc13b4834a4ddbd2c3c">ksNew</a>(0, <a class="code" href="group__keyset.html#ga7a28fce3773b2c873c94ac80b8b4cd54">KS_END</a>), parentKey);</div>
<div class="line"> </div>
<div class="line">        KeySet * ks1 = <a class="code" href="group__keyset.html#ga671e1aaee3ae9dc13b4834a4ddbd2c3c">ksNew</a> (0, <a class="code" href="group__keyset.html#ga7a28fce3773b2c873c94ac80b8b4cd54">KS_END</a>);</div>
<div class="line">        KeySet * ks2 = <a class="code" href="group__keyset.html#ga671e1aaee3ae9dc13b4834a4ddbd2c3c">ksNew</a> (0, <a class="code" href="group__keyset.html#ga7a28fce3773b2c873c94ac80b8b4cd54">KS_END</a>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a> (<a class="code" href="namespacekdb.html">kdb</a>, ks1, <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a>(<span class="stringliteral">&quot;/somewhere&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>));</div>
<div class="line">        succeed_if (<a class="code" href="group__keyset.html#gad65d2cdcbb5381194a1688e169af8a83">ksLookupByName</a> (ks1, <span class="stringliteral">&quot;/somewhere/key&quot;</span>, 0) != NULL, <span class="stringliteral">&quot;should find key (1)&quot;</span>);</div>
<div class="line">        <a class="code" href="group__kdb.html#ga28e385fd9cb7ccfe0b2f1ed2f62453a1">kdbGet</a> (<a class="code" href="namespacekdb.html">kdb</a>, ks2, <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a>(<span class="stringliteral">&quot;/somewhere&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>));</div>
<div class="line">        succeed_if (<a class="code" href="group__keyset.html#gad65d2cdcbb5381194a1688e169af8a83">ksLookupByName</a> (ks2, <span class="stringliteral">&quot;/somewhere/key&quot;</span>, 0) != NULL, <span class="stringliteral">&quot;should find key (2)&quot;</span>);</div>
<div class="line">}</div>
<div class="ttc" id="agroup__kdb_html_ga11436b058408f83d303ca5e996832bcf"><div class="ttname"><a href="group__kdb.html#ga11436b058408f83d303ca5e996832bcf">kdbSet</a></div><div class="ttdeci">int kdbSet(KDB *handle, KeySet *ks, Key *parentKey)</div><div class="ttdoc">Set Keys to the Key database in an atomic and universal way.</div><div class="ttdef"><b>Definition:</b> kdb.c:2293</div></div>
<div class="ttc" id="agroup__kdb_html_ga844e1299a84c3fbf1d3a905c5c893ba5"><div class="ttname"><a href="group__kdb.html#ga844e1299a84c3fbf1d3a905c5c893ba5">kdbOpen</a></div><div class="ttdeci">KDB * kdbOpen(const KeySet *contract, Key *errorKey)</div><div class="ttdoc">Opens the session with the Key database.</div><div class="ttdef"><b>Definition:</b> kdb.c:924</div></div>
<div class="ttc" id="agroup__kdb_html_gadb54dc9fda17ee07deb9444df745c96f"><div class="ttname"><a href="group__kdb.html#gadb54dc9fda17ee07deb9444df745c96f">kdbClose</a></div><div class="ttdeci">int kdbClose(KDB *handle, Key *errorKey)</div><div class="ttdoc">Closes the session with the Key database.</div><div class="ttdef"><b>Definition:</b> kdb.c:1045</div></div>
<div class="ttc" id="agroup__key_html_gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403"><div class="ttname"><a href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a></div><div class="ttdeci">@ KEY_END</div><div class="ttdef"><b>Definition:</b> kdbenum.c:95</div></div>
<div class="ttc" id="agroup__key_html_gga9b703ca49f48b482def322b77d3e6bc8ac66e4a49d09212b79f5754ca6db5bd2e"><div class="ttname"><a href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8ac66e4a49d09212b79f5754ca6db5bd2e">KEY_VALUE</a></div><div class="ttdeci">@ KEY_VALUE</div><div class="ttdef"><b>Definition:</b> kdbenum.c:88</div></div>
<div class="ttc" id="agroup__keyset_html_ga671e1aaee3ae9dc13b4834a4ddbd2c3c"><div class="ttname"><a href="group__keyset.html#ga671e1aaee3ae9dc13b4834a4ddbd2c3c">ksNew</a></div><div class="ttdeci">KeySet * ksNew(size_t alloc,...)</div><div class="ttdoc">Allocate, initialize and return a new KeySet object.</div><div class="ttdef"><b>Definition:</b> keyset.c:282</div></div>
<div class="ttc" id="agroup__keyset_html_ga7a28fce3773b2c873c94ac80b8b4cd54"><div class="ttname"><a href="group__keyset.html#ga7a28fce3773b2c873c94ac80b8b4cd54">KS_END</a></div><div class="ttdeci">#define KS_END</div><div class="ttdoc">End of a list of keys.</div><div class="ttdef"><b>Definition:</b> kdbenum.c:156</div></div>
<div class="ttc" id="agroup__keyset_html_gaa5a1d467a4d71041edce68ea7748ce45"><div class="ttname"><a href="group__keyset.html#gaa5a1d467a4d71041edce68ea7748ce45">ksAppendKey</a></div><div class="ttdeci">ssize_t ksAppendKey(KeySet *ks, Key *toAppend)</div><div class="ttdoc">Appends a Key to the end of ks.</div><div class="ttdef"><b>Definition:</b> keyset.c:971</div></div>
<div class="ttc" id="agroup__keyset_html_gad65d2cdcbb5381194a1688e169af8a83"><div class="ttname"><a href="group__keyset.html#gad65d2cdcbb5381194a1688e169af8a83">ksLookupByName</a></div><div class="ttdeci">Key * ksLookupByName(KeySet *ks, const char *name, elektraLookupFlags options)</div><div class="ttdoc">Convenience method to look for a Key contained in ks with name name.</div><div class="ttdef"><b>Definition:</b> keyset.c:2781</div></div>
</div><!-- fragment --><p>It was found unexpected that the second assert - should find key (2) - will fail.</p>
<h1><a class="anchor" id="autotoc_md2074"></a>
Constraints</h1>
<ul>
<li>memory consumption must be low for <code>kdbGet</code>, see <a class="el" href="doc_GOALS_md.html">4. Goal: Performance</a>, in particular, deep duplication is too expensive</li>
<li>For non-optional parts of Elektra, also non-POSIX systems must be supported</li>
</ul>
<h1><a class="anchor" id="autotoc_md2075"></a>
Assumptions</h1>
<h1><a class="anchor" id="autotoc_md2076"></a>
Considered Alternatives</h1>
<h2><a class="anchor" id="autotoc_md2077"></a>
Keep Current Situation</h2>
<p>Improve documentation to make people more aware of these two problems:</p>
<ul>
<li>add a tutorial about <code>kdbGet</code> semantics</li>
<li>add full examples how to correctly work with <code>kdbGet</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md2078"></a>
Changing &lt;tt&gt;parentKey&lt;/tt&gt; according to mountpoints</h2>
<p>"More keys":</p>
<p>Upon returning from <code>kdbGet</code>/<code>kdbSet</code>, set the keyname of parentKey to the key that actually is parent of the data that was loaded. I.e. to the mountpoint of the backend that contains parentKey. <code>parentKey</code> is already an inout-type argument, since we use both it's value and metadata to return some information.</p>
<p>A few people found this behavior just as unexpected as the current problem. E.g. a sequence of <code>kdbGet</code> and <code>kdbSet</code> with the same parent key might lead to different outcomes depending on the mountpoints.</p>
<p>"Fewer keys":</p>
<p>This is a bug in the logic of the "nothing changed" optimization. A partial solution would be to copy the keys from <code>backendData-&gt;keys</code>, so they are actually there, and we don't just assume they are there. Still some extra steps are required to make it work in all cases, e.g.:</p>
<div class="fragment"><div class="line">TEST_F (Simple, NothingToDo2)</div>
<div class="line">{</div>
<div class="line">        <span class="keyword">using namespace </span><a class="code" href="namespacekdb.html">kdb</a>;</div>
<div class="line">        KDB <a class="code" href="namespacekdb.html">kdb</a>;</div>
<div class="line">        KeySet ks;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">auto</span> parentKey = <span class="stringliteral">&quot;system:&quot;</span> + testRoot;</div>
<div class="line"> </div>
<div class="line">        EXPECT_EQ (<a class="code" href="namespacekdb.html">kdb</a>.get (ks, parentKey), 0) &lt;&lt; <span class="stringliteral">&quot;nothing to do in get&quot;</span>;</div>
<div class="line"> </div>
<div class="line">        ks.append (Key (parentKey + <span class="stringliteral">&quot;a&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8ac66e4a49d09212b79f5754ca6db5bd2e">KEY_VALUE</a>, <span class="stringliteral">&quot;x&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>));</div>
<div class="line">        <a class="code" href="namespacekdb.html">kdb</a>.set (ks, parentKey);</div>
<div class="line"> </div>
<div class="line">        EXPECT_EQ (<a class="code" href="namespacekdb.html">kdb</a>.get (ks, parentKey), 0) &lt;&lt; <span class="stringliteral">&quot;nothing to do in get&quot;</span>;</div>
<div class="line">        EXPECT_TRUE (ks.lookup (parentKey + <span class="stringliteral">&quot;a&quot;</span>)) &lt;&lt; <span class="stringliteral">&quot;key a not found&quot;</span>;</div>
<div class="line">        EXPECT_EQ (ks.lookup (parentKey + <span class="stringliteral">&quot;a&quot;</span>).get&lt;std::string&gt; (), <span class="stringliteral">&quot;x&quot;</span>) &lt;&lt; <span class="stringliteral">&quot;key a with wrong value&quot;</span>;</div>
<div class="line">        <span class="comment">// TODO: adding the line below breaks the test</span></div>
<div class="line">        <span class="comment">//       This is because the Key instance is shared between `ks` and the internal data of `kdb`.</span></div>
<div class="line">        <span class="comment">// ks.lookup(parentKey + &quot;a&quot;).set(&quot;y&quot;);</span></div>
<div class="line"> </div>
<div class="line">        KeySet ks2;</div>
<div class="line">        EXPECT_EQ (<a class="code" href="namespacekdb.html">kdb</a>.get (ks2, parentKey), 0) &lt;&lt; <span class="stringliteral">&quot;nothing to do in get&quot;</span>;</div>
<div class="line">        EXPECT_TRUE (ks2.lookup (parentKey + <span class="stringliteral">&quot;a&quot;</span>)) &lt;&lt; <span class="stringliteral">&quot;key a not found&quot;</span>;</div>
<div class="line">        EXPECT_EQ (ks2.lookup (parentKey + <span class="stringliteral">&quot;a&quot;</span>).get&lt;std::string&gt; (), <span class="stringliteral">&quot;x&quot;</span>) &lt;&lt; <span class="stringliteral">&quot;key a with wrong value&quot;</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p>A very simple way to make it work would be to make the keys returned by kdbGet read-only. If we do not do this, we need a deep-copy or a copy-on-write copy.</p>
<h2><a class="anchor" id="autotoc_md2079"></a>
Cachefilter Plugin</h2>
<p>Naively one would simply cache the whole keyset and use <code>ksBelow</code> to always get the keyset.</p>
<p>This idea was implemented and later on <a href="https://github.com/ElektraInitiative/libelektra/commit/a3d95f07160d792fdd0f169d8543138c32a2f580">discarded: a3d95f</a></p>
<p>The main problems are:</p>
<ul>
<li>very high memory consumption (duplication of KeySets)</li>
<li>problems specific to <a class="el" href="doc_decisions_5_partially_implemented_hooks_md.html">hooks</a>, see <a href="https://issues.libelektra.org/1072">#1072</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md2080"></a>
MMAP Cache with parent key</h2>
<p>We make the mmap cache non-optional so that we always have a keyset of configuration data internally. The cache will be used to do change tracking. From this keyset, we use <code>ksBelow</code> to return the correct keyset.</p>
<p>Disadvantage: mmap implementation for Windows would be needed.</p>
<p>The cache should be updated at the end of every kdbGet that was a cache miss. So during kdbSet (assuming there is no external modification, i.e. conflict) the on-disk data of the cache should always be up-to-date. The idea would be to just read the cached keyset from disk and diff against the current keyset in kdbSet.</p>
<p>This would mean enabling change tracking also enables the cache (or at least updating the cache, we don't have to use it in kdbGet). If that's not wanted or if the cache data cannot be used directly for some other reason, the same approach could still be used. We'd just have to write the keyset to disk during kdbGet and use it during kdbSet. Since disk space is far less precious than RAM, we could even create separate files for every parent key. If we do go down this route, kdbClose should clean up the files created by this KDB instance to avoid wasting disk space.</p>
<h2><a class="anchor" id="autotoc_md2081"></a>
MMAP Cache without parent key</h2>
<p>We make the mmap cache non-optional and only use a single cache, caching everything. We remove the parent key of <code>kdbGet</code> and <code>kdbSet</code> and always return the keyset of the whole KDB.</p>
<ul>
<li>Disadvantage: mmap implementation for Windows would be needed</li>
<li>Then also symlinks (fallback, override etc.) and constraints for keys outside of the parentKey would work. It would make the <code>-a</code> option of <code>kdb get</code> unnecessary.</li>
</ul>
<p>It is still unclear whether this would actually be a good default behavior. Normally it is expected for mountpoints to be isolated If symlinks work like this, the isolation is partially broken. One could argue that the problem right now is that such "broken" symlinks are not prevented. The proposed solution doesn't completely fix the problem either</p>
<p>For example:</p>
<ul>
<li><code>system:/foo</code> is a mountpoint, there are no other mountpoints</li>
<li><code>spec:/foo/bar</code> refers to <code>system:/abc</code> via <code>meta:/override</code></li>
</ul>
<p>Now in a plugin that is part of the mountpoint <code>system:/foo</code> doing a <code>ksLookupByName (ks, "/foo/bar", 0)</code> would NOT use <code>system:/abc</code>, because that key is never part of the keyset passed to this plugin.</p>
<p>However, in an application that used <code>system:/foo</code> as the parent, the <code>meta:/override</code> would work with your proposal. This seems like very confusing behavior, because both the application and the plugin seemingly use the same parent key.</p>
<h2><a class="anchor" id="autotoc_md2082"></a>
Data restrictions</h2>
<p>Make all the keys returned by kdbGet completely read-only. To change the data it is required to append an entirely new key to replace the existing one. Then we just need to keep a shallow copy internally.</p>
<h2><a class="anchor" id="autotoc_md2083"></a>
API restrictions</h2>
<p>Change the API and remove KeySet from kdbGet and kdbSet also option 4 in <a class="el" href="doc_decisions_0_drafts_operation_sequences_md.html">the operation sequences decision</a>. If the keyset is owned by the KDB handle, it should not be such a big surprise, if there is extra data in there.</p>
<p>This only fixes the "Fewer Keys" issue.</p>
<h2><a class="anchor" id="autotoc_md2084"></a>
Copy On Write</h2>
<p>We keep a duplicated keyset in-memory and tag the keys as copy-on-write (COW). From this keyset, we use <code>ksBelow</code> to return the correct keyset. If the user tries to change the value or metadata of these keys, the data gets duplicated. I.e. the original keyset is not changed. The name is not relevant. It is always read-only, because the key is in at least one keyset (the internal one).</p>
<p>Possible copy-on-write implementations are described in <a class="el" href="doc_decisions_6_implemented_copy_on_write_md.html">another decision</a>.</p>
<h1><a class="anchor" id="autotoc_md2085"></a>
Decision</h1>
<p>Implement the copy-on-write approach.</p>
<p>We keep a copy of all keys returned by the backends in memory. We use <code>ksBelow</code> to only return a copy-on-write copy of keys the user requested on <code>kdbGet</code>.</p>
<p>If the user tries to change the value or metadata of these keys, the data gets duplicated (copy-on-write). I.e. the data of the original keys is not changed. The name is not relevant. It is always read-only, because the key is in at least one keyset (the internal one). Possible copy-on-write implementations are described in <a class="el" href="doc_decisions_6_implemented_copy_on_write_md.html">another decision</a>.</p>
<p>In <code>kdbSet</code> we use the user-provided <code>KeySet</code> for all backends strictly below <code>parentKey</code> as before. For the backend that contains <code>parentKey</code>, we start with the internally cached data. We then remove everything that is at or below <code>parentKey</code> (via <code>ksCut</code>) and replace it with the data from the user-provided <code>KeySet</code>. Keys not at or below <code>parentKey</code> therefore remain untouched.</p>
<h1><a class="anchor" id="autotoc_md2086"></a>
Rationale</h1>
<p>Semantics can be provided without additional code or overhead in the core. As we need copy-on-write for efficient change tracking anyway, it makes sense to also use this approach for the internal cache. The copy-on-write solution also does not require any changes or restrictions to the current API.</p>
<h1><a class="anchor" id="autotoc_md2087"></a>
Implications</h1>
<ul>
<li>Before we can implement this decision, we need to implement the <a class="el" href="doc_decisions_6_implemented_copy_on_write_md.html">copy-on-write decision</a>.</li>
<li><code>kdbGet</code> will only return copy-on-write copies of keys below <code>parentKey</code> from the internal cache.</li>
<li><code>kdbSet</code> will use the keys within the internal cache to supplement all the keys above <code>parentKey</code> so that backends can write the correct data.</li>
</ul>
<h1><a class="anchor" id="autotoc_md2088"></a>
Related Decisions</h1>
<ul>
<li><a class="el" href="doc_decisions_0a_postponed_global_validation_md.html">Global Validation</a></li>
<li><a class="el" href="doc_decisions_6_implemented_copy_on_write_md.html">Copy On Write</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md2089"></a>
Notes</h1>
<p>Problem "Fewer Keys" was found to be a <a href="https://pull.libelektra.org/4619">"horrible problem"</a></p>
<p>Issues where the problem described here was found confusing:</p>
<ul>
<li><a href="https://issues.libelektra.org/760">#760</a></li>
<li><a href="https://issues.libelektra.org/1363">#1363</a></li>
</ul>
<p>@mpranj wrote about the performance for <code>MMAP Cache without parent key</code>:</p>
<blockquote class="doxtable">
<p>in my benchmarks the pointer correction was never a bottleneck. </p>
</blockquote>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
