<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: How-To: Write a (Well Behaved) Storage Plugin</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Elektra
   &#160;<span id="projectnumber">0.9.6</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">How-To: Write a (Well Behaved) Storage Plugin </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_tutorials_storage_plugins"></a> The <a class="el" href="doc_tutorials_plugins_md.html">plugin tutorial</a> already covers some of the most interesting parts on how to write a (storage) plugin. This text will tell you a little bit more about how a storage plugin should act. While it is usually relatively easy to create a plugin that stores basic key-value pairs, adding advanced features such as support for</p>
<ul>
<li><a class="el" href="doc_tutorials_arrays_md.html">arrays</a>, and</li>
<li><a class="el" href="doc_dev_metadata_md.html">metadata</a>,</li>
</ul>
<p>takes more work. Before you continue with this text, please make sure that you read all of the linked documents above.</p>
<h1><a class="anchor" id="autotoc_md3654"></a>
Don‚Äôt Add Additional Keys</h1>
<p>One common problem of storage plugins is, that they store too many keys. For example, if the user adds the keys</p>
<ul>
<li><code>user:/tests/storage/root</code> and</li>
<li><code>user:/tests/storage/root/level1/level2/level3</code>,</li>
</ul>
<p>then your plugin should only store those two keys. <b>Do not</b> add the keys</p>
<ul>
<li><code>user:/tests/storage/root/level1</code>, or</li>
<li><code>user:/tests/storage/root/level1/level2</code></li>
</ul>
<p>to the key set. One plugin that handles this situation properly is <a class="el" href="md_src_plugins_yamlcpp_README.html#src_plugins_yamlcpp_README_md">YAML CPP</a>, as the following <a href="https://master.libelektra.org/tests/shell/shell_recorder/tutorial_wrapper">Markdown Shell Recorder</a> test shows:</p>
<div class="fragment"><div class="line"># Mount plugin</div>
<div class="line">sudo kdb mount config.yaml user:/tests/storage yamlcpp</div>
<div class="line"> </div>
<div class="line"># Add key-value pairs</div>
<div class="line">kdb set user:/tests/storage/root üêì</div>
<div class="line">kdb set user:/tests/storage/root/level1/level2/level3 üê£</div>
<div class="line"> </div>
<div class="line"># Make sure that YAML CPP did not store any additional keys</div>
<div class="line">kdb ls user:/tests/storage/root</div>
<div class="line">#&gt; user:/tests/storage/root</div>
<div class="line">#&gt; user:/tests/storage/root/level1/level2/level3</div>
<div class="line"> </div>
<div class="line"># Undo modifications to the key database</div>
<div class="line">kdb rm -r user:/tests/storage</div>
<div class="line">sudo kdb umount user:/tests/storage</div>
</div><!-- fragment --><p>. For more information on why we allow ‚Äúholes‚Äù in the hierarchy, please take a look <a class="el" href="doc_decisions_holes_md.html">here</a>.</p>
<h1><a class="anchor" id="autotoc_md3655"></a>
Differentiate Between Empty Keys and Keys Containing an Empty String</h1>
<p>Elektra supports both binary and textual values. The main difference between binary and textual data is that textual data always ends with a null byte. Therefore you are not allowed to store the code point <code>0</code> inside textual data. Binary data does not have this limitation.</p>
<p>The simplest textual data is the empty string (<code>""</code> = <code>0</code>) and has length 1, while the simplest binary data stores nothing at all and therefore has length 0. In the <code>kdb</code> utility you can disambiguate between these value by checking for the <a class="el" href="doc_help_elektra-metadata_md.html">metakey `binary`</a>. The following <a href="https://master.libelektra.org/tests/shell/shell_recorder/tutorial_wrapper">Markdown Shell Recorder</a> test shows how a storage plugin should handle empty values.</p>
<div class="fragment"><div class="line"># Mount plugin</div>
<div class="line">sudo kdb mount config.yaml user:/tests/storage yamlcpp</div>
<div class="line"> </div>
<div class="line">kdb set user:/tests/storage/empty &#39;&#39;</div>
<div class="line">#&gt; Create a new key user:/tests/storage/empty with string &quot;&quot;</div>
<div class="line">kdb get user:/tests/storage/empty</div>
<div class="line">#&gt;</div>
<div class="line">kdb meta-ls user:/tests/storage/empty</div>
<div class="line">#&gt;</div>
<div class="line"> </div>
<div class="line"># Undo modifications to the key database</div>
<div class="line">kdb rm -r user:/tests/storage</div>
<div class="line">sudo kdb umount user:/tests/storage</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md3656"></a>
Convert Boolean Data</h1>
<p>Elektra uses <a class="el" href="doc_decisions_boolean_md.html">`0` and `1` to represent binary data</a>. A storage plugin that uses other values (e.g. <code>false</code> and <code>true</code>) needs to convert these values to <code>0</code> and <code>1</code>. The <a href="https://master.libelektra.org/tests/shell/shell_recorder/tutorial_wrapper">Markdown Shell Recorder</a> test below shows that <a class="el" href="md_src_plugins_yamlcpp_README.html#src_plugins_yamlcpp_README_md">YAML CPP</a> handles the conversion from and to <a href="https://yaml.org/spec/1.2/spec.html#id2803629">YAML‚Äôs boolean type</a> properly. In the test we also use the <a class="el" href="md_src_plugins_type_README.html#src_plugins_type_README_md">`type` plugin</a> to makes sure that YAML CPP interacts correctly with this essential plugin.</p>
<div class="fragment"><div class="line"># Mount plugin</div>
<div class="line">sudo kdb mount config.yaml user:/tests/storage yamlcpp type</div>
<div class="line"> </div>
<div class="line">kdb set user:/tests/storage/bool/value true</div>
<div class="line">kdb meta-set user:/tests/storage/bool/value type boolean</div>
<div class="line">kdb get user:/tests/storage/bool/value</div>
<div class="line">#&gt; 1</div>
<div class="line"> </div>
<div class="line">kdb set user:/tests/storage/bool/value 1</div>
<div class="line">kdb get user:/tests/storage/bool/value</div>
<div class="line">#&gt; 1</div>
<div class="line"> </div>
<div class="line">kdb set user:/tests/storage/bool/value false</div>
<div class="line">kdb get user:/tests/storage/bool/value</div>
<div class="line">#&gt; 0</div>
<div class="line"> </div>
<div class="line">kdb set user:/tests/storage/bool/value &#39;non boolean&#39;</div>
<div class="line"># RET: 5</div>
<div class="line"> </div>
<div class="line">kdb get user:/tests/storage/bool/value</div>
<div class="line">#&gt; 0</div>
<div class="line"> </div>
<div class="line"># Undo modifications to the key database</div>
<div class="line">kdb rm -r user:/tests/storage</div>
<div class="line">sudo kdb umount user:/tests/storage</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md3657"></a>
Support Values Inside Non-Leaf Keys</h1>
<p>Sometimes the most ‚Äúnatural‚Äù mapping of key-value pairs to a file format might cause a storage plugin to not be able to store values in so called directory (non-leaf) keys.</p>
<p>For example, in a key set that contains the keys:</p>
<div class="fragment"><div class="line">user:/directory</div>
<div class="line">user:/directory/leaf1</div>
<div class="line">user:/directory/leaf2</div>
<div class="line">user:/leaf3</div>
</div><!-- fragment --><p>, all keys at the bottom of the hierarchy:</p>
<div class="fragment"><div class="line">        user</div>
<div class="line">      /      \</div>
<div class="line">  directory  leaf3</div>
<div class="line">   /     \</div>
<div class="line">leaf1   leaf2</div>
</div><!-- fragment --><p>, such as</p>
<ul>
<li><code>user:/directory/leaf1</code></li>
<li><code>user:/directory/leaf2</code></li>
<li><code>user:/leaf3</code></li>
</ul>
<p>are called leaf keys, while <code>user:/directory</code> is a directory key. Plugins such as <a class="el" href="md_src_plugins_yajl_README.html#src_plugins_yajl_README_md">YAJL</a> or <a class="el" href="md_src_plugins_yamlcpp_README.html#src_plugins_yamlcpp_README_md">YAML CPP</a> will not be able to store data in the key with the name <code>user:/directory</code> directly. To work around this issue these plugin use the <a class="el" href="md_src_plugins_directoryvalue_README.html#src_plugins_directoryvalue_README_md">Directory Value plugin</a>. In the ReadMe of the <a href="https://www.libelektra.org/plugins/directoryvalue">Directory Value plugin</a> and <a href="https://www.libelektra.org/plugins/yamlcpp">YAML CPP</a> you will find more information about this issue, and how to handle it.</p>
<p>The following Markdown Shell Recorder test shows <b>the proper behavior</b>:</p>
<div class="fragment"><div class="line"># Mount plugin</div>
<div class="line">sudo kdb mount config.yaml user:/tests/storage yamlcpp</div>
<div class="line"> </div>
<div class="line"># Add key-value pair (leaf key)</div>
<div class="line">kdb set user:/tests/storage/root üêì</div>
<div class="line"># Since we add a key below `user:/tests/storage/root`, the key</div>
<div class="line"># `user:/tests/storage/root` turns from a leaf key to a directory key.</div>
<div class="line">kdb set user:/tests/storage/root/level1/level2/level3 üê£</div>
<div class="line"> </div>
<div class="line"># Make sure that the directory key still stores the correct value</div>
<div class="line">kdb get user:/tests/storage/root</div>
<div class="line">#&gt; üêì</div>
<div class="line"> </div>
<div class="line"># Check the value of the leaf key</div>
<div class="line">kdb get user:/tests/storage/root/level1/level2/level3</div>
<div class="line">#&gt; üê£</div>
<div class="line"> </div>
<div class="line"># Undo modifications to the key database</div>
<div class="line">kdb rm -r user:/tests/storage</div>
<div class="line">sudo kdb umount user:/tests/storage</div>
</div><!-- fragment --><p>. To make sure that your storage plugin works correctly, please just replace <code>yamlcpp</code> with the name of your plugin and verify that the test above still works.</p>
<h1><a class="anchor" id="autotoc_md3658"></a>
Support Array And Non-Array Data Properly</h1>
<p>You already learned about the array syntax and the mandatory <code>array</code> metakey in the <a class="el" href="doc_tutorials_arrays_md.html">array tutorial</a>. Now it is time to check, if your storage plugin supports array and non-array keys properly. Let us look at a concrete example. We use a key set that contains the following keys as example:</p>
<div class="fragment"><div class="line">user:/tests/storage/array</div>
<div class="line">user:/tests/storage/array/#0</div>
<div class="line">user:/tests/storage/array/#1</div>
<div class="line">user:/tests/storage/map</div>
<div class="line">user:/tests/storage/map/#0</div>
<div class="line">user:/tests/storage/map/#1</div>
</div><!-- fragment --><p>. If we assume that only <code>user:/tests/storage/array</code> stores the metakey <code>array</code>, then the keys</p>
<ul>
<li><code>user:/tests/storage/array/#0</code>, and</li>
<li><code>user:/tests/storage/array/#1</code></li>
</ul>
<p>represent array elements, while</p>
<ul>
<li><code>user:/tests/storage/map/#0</code>, and</li>
<li><code>user:/tests/storage/map/#1</code></li>
</ul>
<p>are normal key-value pairs. The following example shows that the storage plugin <a href="https://www.libelektra.org/plugins/yamlcpp">YAML CPP</a> handles this situation properly:</p>
<div class="fragment"><div class="line"># Mount plugin</div>
<div class="line">sudo kdb mount config.yaml user:/tests/storage yamlcpp</div>
<div class="line"> </div>
<div class="line"># Create an array containing two elements</div>
<div class="line">kdb meta-set user:/tests/storage/array array &#39;&#39;</div>
<div class="line">kdb set user:/tests/storage/array/#0 one</div>
<div class="line">kdb set user:/tests/storage/array/#1 two</div>
<div class="line"> </div>
<div class="line"># The array parent key stores the basename of the last element</div>
<div class="line">kdb meta-get user:/tests/storage/array array</div>
<div class="line">#&gt; #1</div>
<div class="line"> </div>
<div class="line"># If you do not add the metakey `array`, then keys</div>
<div class="line"># containing array syntax `#0`, `#1`, ‚Ä¶ will not be</div>
<div class="line"># interpreted as arrays.</div>
<div class="line">kdb set user:/tests/storage/map &quot;&quot;</div>
<div class="line">kdb set user:/tests/storage/map/#0 &quot;&quot;</div>
<div class="line">kdb set user:/tests/storage/map/#1 &quot;&quot;</div>
<div class="line">kdb meta-get user:/tests/storage/map array</div>
<div class="line"># RET: 2</div>
<div class="line"> </div>
<div class="line"># Undo modifications to the key database</div>
<div class="line">kdb rm -r user:/tests/storage</div>
<div class="line">sudo kdb umount user:/tests/storage</div>
</div><!-- fragment --></div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
