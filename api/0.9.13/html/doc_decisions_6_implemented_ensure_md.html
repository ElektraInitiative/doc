<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Ensure</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.9.13</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Ensure </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_decisions_6_implemented_ensure"></a> </p>
<h1><a class="anchor" id="autotoc_md2333"></a>
Problem</h1>
<p>Applications want to ensure that some functionality (hooks) is present in Elektra.</p>
<h1><a class="anchor" id="autotoc_md2334"></a>
Constraints</h1>
<h1><a class="anchor" id="autotoc_md2335"></a>
Assumptions</h1>
<h1><a class="anchor" id="autotoc_md2336"></a>
Considered Alternatives</h1>
<ul>
<li>Keep <code>kdbEnsure</code> (Rejected because it is too flexible and can be called many times. Furthermore, <code>kdbOpen</code> would build up configurations that get removed afterwards.)<ul>
<li>reduce for only global plugins, as the partial other functionality is confusing and not needed</li>
<li>find solution that list plugin is not needed</li>
<li>only as implementation detail below libraries (e.g. like done for notification)</li>
</ul>
</li>
<li>Specific APIs per plugin, Rejected because:<ul>
<li>difficult for application developers</li>
<li>every plugin would need to design new APIs</li>
</ul>
</li>
<li>Have a new API: <code>KDB * kdbOpen (Key * parent);</code> <code>int kdbConfigure (KDB * handle, KeySet * contract, Key * parentKey);</code> <code>KDB * kdbOpenDefault (Key * parent);</code> The new kdbOpen only does the absolute minimum work, in particular it doesn't set up any global plugins. If you use kdbOpen you must call kdbConfigure otherwise kdbGet will fail. kdbConfigure configures global plugins (basically just a renamed kdbEnsure). Lastly, kdbOpenDefault does more or less what the old kdbOpen does. It sets up the default case and you can call kdbGet immediately. But you cannot call kdbConfigure after kdbOpenDefault. Rejected because of API bloat and introduction of further state in <code>kdb</code>.</li>
</ul>
<h1><a class="anchor" id="autotoc_md2337"></a>
Decision</h1>
<p>Integrate <code>kdbEnsure</code> in <code>kdbOpen(Key *errorKey, KeySet *contract)</code> but only allow hooks.</p>
<h1><a class="anchor" id="autotoc_md2338"></a>
Rationale</h1>
<ul>
<li>can immediately build up correct plugin positioning</li>
<li>does not allow starting applications if the contract cannot be fulfilled</li>
<li>simplest and minimalistic solution</li>
</ul>
<h1><a class="anchor" id="autotoc_md2339"></a>
Implications</h1>
<p><code>elektraNotificationOpen</code> will be renamed and only return a contract KeySet:</p>
<div class="fragment"><div class="line">KeySet * errorKey = <a class="code" href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a> (<span class="stringliteral">&quot;/&quot;</span>, <a class="code" href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>);</div>
<div class="line">KeySet * contract = <a class="code" href="group__keyset.html#ga671e1aaee3ae9dc13b4834a4ddbd2c3c">ksNew</a> (0, <a class="code" href="group__keyset.html#ga7a28fce3773b2c873c94ac80b8b4cd54">KS_END</a>);</div>
<div class="line"><a class="code" href="notification_8c.html#ad9290f444f315d3eac3f7cfdaf4efcda">elektraNotificationContract</a> (contract, iobinding, errorKey);</div>
<div class="ttc" id="agroup__key_html_gad23c65b44bf48d773759e1f9a4d43b89"><div class="ttname"><a href="group__key.html#gad23c65b44bf48d773759e1f9a4d43b89">keyNew</a></div><div class="ttdeci">Key * keyNew(const char *name,...)</div><div class="ttdoc">A practical way to fully create a Key object in one step.</div><div class="ttdef"><b>Definition:</b> key.c:144</div></div>
<div class="ttc" id="agroup__key_html_gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403"><div class="ttname"><a href="group__key.html#gga9b703ca49f48b482def322b77d3e6bc8aa8adb6fcb92dec58fb19410eacfdd403">KEY_END</a></div><div class="ttdeci">@ KEY_END</div><div class="ttdef"><b>Definition:</b> kdbenum.c:95</div></div>
<div class="ttc" id="agroup__keyset_html_ga671e1aaee3ae9dc13b4834a4ddbd2c3c"><div class="ttname"><a href="group__keyset.html#ga671e1aaee3ae9dc13b4834a4ddbd2c3c">ksNew</a></div><div class="ttdeci">KeySet * ksNew(size_t alloc,...)</div><div class="ttdoc">Allocate, initialize and return a new KeySet object.</div><div class="ttdef"><b>Definition:</b> keyset.c:282</div></div>
<div class="ttc" id="agroup__keyset_html_ga7a28fce3773b2c873c94ac80b8b4cd54"><div class="ttname"><a href="group__keyset.html#ga7a28fce3773b2c873c94ac80b8b4cd54">KS_END</a></div><div class="ttdeci">#define KS_END</div><div class="ttdoc">End of a list of keys.</div><div class="ttdef"><b>Definition:</b> kdbenum.c:156</div></div>
<div class="ttc" id="anotification_8c_html_ad9290f444f315d3eac3f7cfdaf4efcda"><div class="ttname"><a href="notification_8c.html#ad9290f444f315d3eac3f7cfdaf4efcda">elektraNotificationContract</a></div><div class="ttdeci">int elektraNotificationContract(KeySet *contract)</div><div class="ttdoc">Creates a contract for use with kdbOpen() that sets up notifications.</div><div class="ttdef"><b>Definition:</b> notification.c:34</div></div>
</div><!-- fragment --><p>The same for gopts:</p>
<div class="fragment"><div class="line"><a class="code" href="contracts_8c.html#af4f606fc2179e917a10c77dab576d648">elektraGOptsContract</a> (contract, argc, argv, environ, errorKey);</div>
<div class="ttc" id="acontracts_8c_html_af4f606fc2179e917a10c77dab576d648"><div class="ttname"><a href="contracts_8c.html#af4f606fc2179e917a10c77dab576d648">elektraGOptsContract</a></div><div class="ttdeci">int elektraGOptsContract(KeySet *contract, int argc, const char *const *argv, const char *const *envp, const Key *parentKey, KeySet *goptsConfig)</div><div class="ttdoc">Sets up a contract for use with kdbOpen() that configures the gopts plugin.</div><div class="ttdef"><b>Definition:</b> contracts.c:41</div></div>
</div><!-- fragment --><p>Finally, we create <code>KDB</code> with the contracts we got before:</p>
<div class="fragment"><div class="line">KDB * <a class="code" href="namespacekdb.html">kdb</a> = <a class="code" href="group__kdb.html#ga844e1299a84c3fbf1d3a905c5c893ba5">kdbOpen</a> (contract, parentKey);</div>
<div class="ttc" id="agroup__kdb_html_ga844e1299a84c3fbf1d3a905c5c893ba5"><div class="ttname"><a href="group__kdb.html#ga844e1299a84c3fbf1d3a905c5c893ba5">kdbOpen</a></div><div class="ttdeci">KDB * kdbOpen(const KeySet *contract, Key *errorKey)</div><div class="ttdoc">Opens the session with the Key database.</div><div class="ttdef"><b>Definition:</b> kdb.c:924</div></div>
<div class="ttc" id="anamespacekdb_html"><div class="ttname"><a href="namespacekdb.html">kdb</a></div><div class="ttdoc">This is the main namespace for the C++ binding and libraries.</div><div class="ttdef"><b>Definition:</b> backend.hpp:31</div></div>
</div><!-- fragment --><p>Opening <code>KDB</code> will fail if any of the contracts cannot be ensured.</p>
<p>As the <code>contract</code> gets copied, at any point after <code>kdbOpen</code> the contract can be safely deleted:</p>
<div class="fragment"><div class="line">ksDel (contract);</div>
</div><!-- fragment --><p>The cleanup of the global plugins happens within:</p>
<div class="fragment"><div class="line"><a class="code" href="group__kdb.html#gadb54dc9fda17ee07deb9444df745c96f">kdbClose</a> (<a class="code" href="namespacekdb.html">kdb</a>, errorKey);</div>
<div class="ttc" id="agroup__kdb_html_gadb54dc9fda17ee07deb9444df745c96f"><div class="ttname"><a href="group__kdb.html#gadb54dc9fda17ee07deb9444df745c96f">kdbClose</a></div><div class="ttdeci">int kdbClose(KDB *handle, Key *errorKey)</div><div class="ttdoc">Closes the session with the Key database.</div><div class="ttdef"><b>Definition:</b> kdb.c:1045</div></div>
</div><!-- fragment --><p>It is safe to use the contract <code>KeySet</code> also for <code>kdbGet</code> and <code>kdbSet</code> invocations. Contract <code>KeySet</code>s only contain <code>Key</code>s below <code>system:/elektra/contract</code>. Therefore, normal <code>KeySet</code>s should not interfere.</p>
<h1><a class="anchor" id="autotoc_md2340"></a>
Related Decisions</h1>
<ul>
<li><a class="el" href="doc_decisions_5_partially_implemented_hooks_md.html">Hooks</a></li>
<li><a class="el" href="doc_decisions_0_drafts_notifications_md.html">Notifications</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md2341"></a>
Notes</h1>
<ul>
<li>Issue <a href="https://issues.libelektra.org/2764">#2764</a></li>
<li>Implemented in <a href="https://pull.libelektra.org/3651">#3651</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
