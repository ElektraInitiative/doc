<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$langISO">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Session Recording Technical Documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
$darkmode
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Add mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_color_doxygen.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Elektra<span id="projectnumber">&#160;0.11.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Session Recording Technical Documentation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_contrib_recording"></a> A recording session is a period of time during which changes to the Key Database (KDB) are tracked and accumulated. It begins when recording starts and ends when recording stops. Throughout the recording session, all changes made to the KDB are recorded, including additions, modifications, and deletions of keys and their associated values. The recording session provides a complete audit trail of all changes made to the KDB during the specified period of time.</p>
<p>After every <code>kdbSet</code>, changes are calculated using Elektra's powerful changetracking API. The result of the calculation is an <code>ElektraDiff</code> instance we'll call <em>part diff</em> throughout this document. The session recording plugin merges those <em>part diffs</em> together and creates and persists an overall <em>session diff</em>.</p>
<p>Conceptually, this is depicted in the following image:</p>
<p><img src="../images/elektra-record/recording-part-diff.svg" alt="Session vs Part diff" style="pointer-events: none;" class="inline"/></p>
<p>Importantly, the <em>session diff</em> is shared across processes. The <em>session diff</em> persistently records all changes made to the whole KDB from any process between the start and end of the session. Because of the cross-process nature of a <em>session diff</em>, it is also susceptible to "simultaneous write" conflicts.</p>
<p>We prevent inconsistent data by using locks. As long as recording is enabled, there is a global lock on write operations in Elektra. If a conflict occurs, it looks to the applications the same as if there was a conflict writing configuration data. The high-level Elektra bindings already resolve such conflicts transparently.</p>
<p>All persistable namespaces are monitored for changes.</p>
<p>An important concept for modified keys is the distinction between <em>old</em> and <em>new</em> keys. Old keys refer to the keys how they were (values, metadata) <em>before</em> the modifications. New keys, on the other hand, refer to how the keys are <em>after</em> the modifications. This concept does not apply to <em>added</em> or <em>removed</em> keys. You can think of added keys of only having new keys, and removed keys only having old keys.</p>
<p>We currently have no way of recording changes done outside of Elektra, i.e. when the configuration files got edited manually.</p>
<h1><a class="anchor" id="autotoc_md1726"></a>
Storage of the Session Diff</h1>
<p>The session diff is persisted in the respective namespace under <code>&lt;namespace&gt;:/elektra/record/session</code>. I.e. all keys in the diff of the <code>system</code> namespace are under <code>system:/elektra/record/session</code>.</p>
<p>The recording plugin needs its own KDB instance to store the session diff within Elektra. We provide hard coded default mountpoints for the</p>
<ul>
<li><code>dir:/elektra/record/session</code>,</li>
<li><code>system:/elektra/record/session</code>,</li>
<li><code>spec:/elektra/record/session</code> and</li>
<li><code>user:/elektra/record/session</code> keys.</li>
</ul>
<p>These mountpoints store the keys in the same storage format as the default mountpoints like <code>system:/</code> and <code>user:/</code>. The session storage file called <code>record-session.cfg</code> is located in the respective standard directories for their namespace.</p>
<p>The following list describes some important keys:</p>
<ul>
<li><code>/elektra/record/config/active</code><ul>
<li>If the key is present, session recording is active.</li>
<li>The keys value is the parent key of the session.</li>
<li>We will only record changes made to keys same or below of this parent key.</li>
</ul>
</li>
<li><code>/elektra/record/session</code><ul>
<li>Contains all the recorded data.</li>
<li>Should be mounted into separate files in each namespace.</li>
</ul>
</li>
<li><code>/elektra/record/session/diff/added</code><ul>
<li>Contains all added keys.</li>
</ul>
</li>
<li><code>/elektra/record/session/diff/modified/old</code><ul>
<li>Contains the <em>old</em> values and metadata for the keys that have been modified.</li>
</ul>
</li>
<li><code>/elektra/record/session/diff/modified/new</code><ul>
<li>Contains the <em>new</em> values and metadata for the keys that have been modified.</li>
</ul>
</li>
<li><code>/elektra/record/session/diff/removed</code><ul>
<li>Contains all removed keys.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md1727"></a>
Calculating the Session Diff</h1>
<p>Keys in a diff are divided into different categories:</p>
<ul>
<li>Added: the key is new and did not exist before</li>
<li>Modified: the key existed before and still exists but its value or metadata has been modified</li>
<li>Removed: the key has been removed</li>
</ul>
<p>Keys that stayed the same and therefore are not represented in a diff are called <em>unchanged</em> keys in the following paragraphs. The diagram below visualizes the state transitions when merging diffs.</p>
<p>The green ovals depict the state of a key in the session diff. The arrows depict the actions/state of a key in the new part diff.</p>
<p>For example, if a key is in <code>Added</code> state in the session diff, and it is in <code>Removed</code> state in the new part diff, then the key will be unchanged in the new version of the session diff. The transitions from <code>unchanged</code> to <code>Added</code>, <code>Modified</code> or <code>Removed</code> are not depicted, as they are quite trivial.</p>
<p><img src="../images/elektra-record/recording-key-states.svg" alt="Key states in recording" style="pointer-events: none;" class="inline"/></p>
<p>This functionality is quite generic and thus implemented as part of the normal diff API as <code>elektraDiffAppend</code>.</p>
<h1><a class="anchor" id="autotoc_md1728"></a>
Architecture</h1>
<p>The core recording feature has two main components:</p>
<ol type="1">
<li>Recording C API (<code>libelektra-record</code>): Implements everything the tooling needs.</li>
<li>Recording Plugin (<code>libelektra-recorder</code>): Gets loaded as a hook plugin and calls the appropriate functions in <code>libelektra-record</code>. </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark'
  });
</script>
</body>
</html>
