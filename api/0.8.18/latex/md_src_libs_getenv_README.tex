
\begin{DoxyItemize}
\item infos = Information about elektrify getenv below
\item infos/author = Markus Raab \href{mailto:elektra@libelektra.org}{\tt elektra@libelektra.\+org}
\item infos/description =
\end{DoxyItemize}

\section*{elektrify-\/getenv(1) -- elektrify the environment of applications }

{\ttfamily elektrify-\/getenv} $<$application$>$ $<$options$>$

\subsection*{E\+X\+A\+M\+P\+L\+E}

\begin{DoxyVerb}kdb elektrify-getenv curl --elektra-version
kdb elektrify-getenv curl http://www.libelektra.org
kdb set system/elektra/intercept/getenv/override/http_proxy http://www.example.com/
kdb elektrify-getenv curl http://www.libelektra.org
\end{DoxyVerb}


By using {\ttfamily elektrify-\/getenv} the last curl invocation will use a different http proxy. Or you can also reload while the application is running\+: \begin{DoxyVerb}ELEKTRA_RELOAD_TIMEOUT=100 kdb elektrify-getenv firefox
kdb set system/elektra/intercept/getenv/override/http_proxy http://www.example.com
\end{DoxyVerb}


\subsection*{D\+E\+S\+C\+R\+I\+P\+T\+I\+O\+N}

When an application is elektrified using libelektragetenv, it does not only request {\ttfamily environ}, but also Elektra for every getenv(3) and secure\+\_\+getenv(3) library call.

Its main purpose is to\+:


\begin{DoxyItemize}
\item have a standard ways to modify the environment
\item make relogin (or even restart!) of applications unnecessary
\item allow a hierarchical structure for environment
\item allow settings to only apply for individual applications or only in special context
\item still preserve the advantages (inheriting of environment to subprocesses)
\item availability of same environment in at, cron and similar scripts
\end{DoxyItemize}

It is implemented using a L\+D\+\_\+\+P\+R\+E\+L\+O\+A\+D technique, see \href{#USAGE}{\tt U\+S\+A\+G\+E} below for global activation.

\subsection*{L\+O\+O\+K\+U\+P\+S}

The main purpose of this approach is to finally have a well-\/defined way to set and get environment variables. Elektra's variables will be in use immediately for every newly started application (no relogin necessary).

To do so, getenv(3) will lookup multiple sources next to searching in the environment (environ). As running example will use {\ttfamily getenv(\char`\"{}\+H\+O\+M\+E\char`\"{}) -\/$>$ /path/to/home}\+:


\begin{DoxyEnumerate}
\item Given commandline parameters will always be preferred (see \href{#OPTIONS}{\tt O\+P\+T\+I\+O\+N\+S} below).

E.\+g. {\ttfamily elektrify-\/getenv $<$app$>$ -\/-\/elektra\+:H\+O\+M\+E=/path/to/home}
\item Then {\ttfamily /elektra/intercept/getenv/override/$<$key$>$} will be looked up, where $<$key$>$ is the parameter to {\ttfamily getenv}. If found, the key will be returned, if it is a null keys, {\ttfamily getenv} will return {\ttfamily N\+U\+L\+L}.

E.\+g. {\ttfamily kdb set user/elektra/intercept/getenv/override/\+H\+O\+M\+E /path/to/home}
\item Then environment will be requested.

E.\+g. {\ttfamily H\+O\+M\+E=/path/to/home elektrify-\/getenv $<$application$>$}
\item Then {\ttfamily /elektra/intercept/getenv/fallback/$<$key$>$} will be looked up. If found, the key will be returned, if it is a null keys, {\ttfamily getenv} will return {\ttfamily N\+U\+L\+L}.

E.\+g. {\ttfamily kdb set user/elektra/intercept/getenv/fallback/\+H\+O\+M\+E /path/to/home}
\end{DoxyEnumerate}

\subsection*{O\+P\+T\+I\+O\+N\+S}

When {\ttfamily elektrify-\/getenv} is active, every application additionally accepts Elektra's getenv options. Interleaving Elektra's and the application's options is allowed. Elektra will parse its options (starting with --elektra) first and discard them before the other application is started. Therefore the application will not see that they even existed, e.\+g.\+: given {\ttfamily elektrify-\/getenv $<$application$>$ -\/\+V -\/-\/elektra-\/debug -\/\+L} the application will be called with {\ttfamily $<$application$>$ -\/\+V -\/\+L}.

\subsubsection*{Internal Options}


\begin{DoxyItemize}
\item {\ttfamily -\/-\/elektra-\/help}\+: Outputs this help.
\item {\ttfamily -\/-\/elektra-\/version}\+: Gives version information.
\item {\ttfamily -\/-\/elektra-\/debug=file}, {\ttfamily E\+L\+E\+K\+T\+R\+A\+\_\+\+D\+E\+B\+U\+G} or {\ttfamily /elektra/intercept/getenv/option/debug}\+: Trace all getenv(3) calls to a file. stderr if no file is given, e.\+g. {\ttfamily kdb set user/elektra/intercept/getenv/option/debug \char`\"{}\char`\"{}}. Note that null values (no forth argument), will disable debug messages. See examples below.
\item {\ttfamily -\/-\/elektra-\/clearenv}, {\ttfamily E\+L\+E\+K\+T\+R\+A\+\_\+\+C\+L\+E\+A\+R\+E\+N\+V} or {\ttfamily /elektra/intercept/getenv/option/clearenv}\+: Call clearenv(3) before entering main. This is a recommended security feature. Elektra itself, if configured that way, will still be able to use the environment.
\item {\ttfamily -\/-\/elektra-\/reload-\/timeout=time\+\_\+in\+\_\+ms}, {\ttfamily E\+L\+E\+K\+T\+R\+A\+\_\+\+R\+E\+L\+O\+A\+D\+\_\+\+T\+I\+M\+E\+O\+U\+T} or {\ttfamily /elektra/intercept/getenv/option/reload\+\_\+timeout}\+: Activate a timeout based feature when a time is given in ms (and is not 0).
\end{DoxyItemize}

Internal Options are available in three different variants\+:


\begin{DoxyEnumerate}
\item as commandline parameter\+: {\ttfamily -\/-\/elektra-\/$<$option$>$}, which are {\itshape not} passed through exec(3) calls.
\item as environment variable\+: {\ttfamily E\+L\+E\+K\+T\+R\+A\+\_\+$<$O\+P\+T\+I\+O\+N$>$}. which might be passed through exec(3) calls, but are removed by clearenv(3) calls.
\item as Elektra K\+D\+B entry\+: {\ttfamily /elektra/intercept/getenv/option/$<$option$>$}, which are the way to achieve an option to be enabled for every application.

E.\+g. {\ttfamily kdb set user/elektra/intercept/getenv/option/clearenv \char`\"{}\char`\"{}} to clear the environment for all applications started by that user (note that at least {\ttfamily P\+A\+T\+H} should to be set using {\ttfamily kdb set user/elektra/intercept/getenv/fallback/\+P\+A\+T\+H \char`\"{}/bin\+:/usr/bin\char`\"{}} then).

Note, that null keys are equal to non-\/set options. E.\+g. {\ttfamily kdb set system/elektra/intercept/getenv/option/debug \char`\"{}/tmp/elektra.\+log\char`\"{}} and {\ttfamily kdb set user/elektra/intercept/getenv/option/debug} will activate logging for the system, except for the current user.
\end{DoxyEnumerate}

\subsubsection*{Contextual Options}


\begin{DoxyItemize}
\item {\ttfamily -\/-\/elektra\%$<$name$>$\%=$<$value$>$} or {\ttfamily /elektra/intercept/getenv/layer/$<$name$>$}\+: Add the contextual information (=layer) {\ttfamily \%$<$name$>$\%} with its value {\ttfamily $<$value$>$}. Note that {\ttfamily name\%} is predefined with {\ttfamily argv\mbox{[}0\mbox{]}} and {\ttfamily basename\%} with {\ttfamily basename(argv\mbox{[}0\mbox{]})}.
\end{DoxyItemize}

Values can contain / to form hierarchies, e.\+g. {\ttfamily -\/-\/elektraname\%=app/profile}

\subsubsection*{Options for Applications}


\begin{DoxyItemize}
\item {\ttfamily -\/-\/elektra\+:key=value}, {\ttfamily /elektra/intercept/getenv/override/$<$key$>$} or {\ttfamily /elektra/intercept/getenv/fallback/$<$key$>$}\+: set a key/value to be preferred, i.\+e. the first to considered as explained in \href{#LOOKUP}{\tt L\+O\+O\+K\+U\+P}.
\end{DoxyItemize}

Keys can contain / to form hierarchies, e.\+g. {\ttfamily -\/-\/elektra\+:my/\+H\+O\+M\+E=/path/to/home}.

\subsection*{U\+S\+A\+G\+E}

To always use Elektra's getenv environment, simply add the output to the file\+: \begin{DoxyVerb}elektrify-getenv | tail -1 | sudo tee -a /etc/ld.so.preload
\end{DoxyVerb}


this also can be done using Elektra\+: \begin{DoxyVerb}sudo kdb mount /etc/ld.so.preload system/ld/preload line null
sudo kdb set "system/ld/preload/new"  `elektrify-getenv | tail -1`
\end{DoxyVerb}


\subsection*{C\+O\+N\+T\+E\+X\+T}

The metadata {\ttfamily context} in the specification can be used to facilitate a context-\/dependent lookup. In its metavalue all replacements of {\ttfamily \%$<$name$>$\%} will be replaced by the given contextual options {\ttfamily -\/-\/elektra\%$<$name$>$\%=$<$value$>$} and {\ttfamily /elektra/intercept/getenv/layer/$<$name$>$} keys.

E.\+g. to have a different home directory for any user and application\+: \begin{DoxyVerb}kdb set user/elektra/intercept/getenv/layer/user markus
kdb set user/users/markus/konqueror/HOME /home/download
kdb setmeta spec/elektra/intercept/getenv/override/HOME context  /users/%user%/%name%/HOME
\end{DoxyVerb}


Or to have a different lock/suspend program per computer (that all have the same config)\+: \begin{DoxyVerb}kdb mount-info system/elektra/intercept/getenv/info            # must be below /elektra/intercept/getenv to be available
kdb setmeta spec/elektra/intercept/getenv/layer/hostname override/#0 system/elektra/intercept/getenv/info/uname/nodename
kdb setmeta spec/elektra/intercept/getenv/override/lock context /elektra/intercept/getenv/info/lock/%hostname%
kdb set user/elektra/intercept/getenv/info/lock/computer1 "systemctl suspend -i
kdb set user/elektra/intercept/getenv/info/lock/computer2 "xset dpms force off && xtrlock"
`kdb getenv lock`  # call the appropriate lock method for the current computer
\end{DoxyVerb}


\subsection*{B\+U\+G\+S}

Some applications do not use {\ttfamily getenv(3)} or {\ttfamily secure\+\_\+getenv(3)} for requesting the environment, e.\+g. shells. This approach cannot work for them.

In the startup-\/phase (before main is even entered), {\ttfamily getenv(3)} will not consider {\ttfamily /elektra/intercept/getenv/override/} or {\ttfamily /elektra/intercept/getenv/fallback}.

Elektra internally tries to avoid using the environment. Some resolvers, however, use it to conform to some specifications, e.\+g. X\+D\+G. Depending on the setup you use, these parameters might be used. For more information see\+: \begin{DoxyVerb}kdb info resolver
\end{DoxyVerb}


For these parameters, {\ttfamily /elektra/intercept/getenv/override/} or {\ttfamily /elektra/intercept/getenv/fallback} will {\itshape not} be used internally, but will be used if applications request them, too.

If you use the standard resolvers, the bug won't have any effect.

Also note that {\ttfamily -\/-\/elektra-\/debug} or {\ttfamily E\+L\+E\+K\+T\+R\+A\+\_\+\+D\+E\+B\+U\+G} does {\itshape not} log {\ttfamily getenv(3)} used by plugins during the startup-\/phase.

Command line arguments apply always to the outmost command, e.\+g. {\ttfamily nice ls -\/-\/elektra\+:C\+O\+L\+U\+M\+N\+S=20} won't have any effect because only for {\ttfamily nice} {\ttfamily C\+O\+L\+U\+M\+N\+S} will be set.

\subsection*{E\+X\+A\+M\+P\+L\+E\+S}

For illustration this section gives some more examples. \begin{DoxyVerb}elektrify-getenv man man --elektra:MANWIDTH=40
\end{DoxyVerb}


Will use M\+A\+N\+W\+I\+D\+T\+H 40 for this invocation of man man. This feature is handy, if an option is only available by environment, but not by command-\/line arguments, because sometimes environment variables are not trivial to set (e.\+g. in Makefiles).

Debugging\+: \begin{DoxyVerb}# system wide to stderr (not recommended!):
sudo kdb set system/elektra/intercept/getenv/option/debug ""
# system wide to /var/log/elektra.log:
sudo kdb set system/elektra/intercept/getenv/option/debug "/var/log/error.log"
# but for my user to ~/.elektra.log:
kdb set user/elektra/intercept/getenv/option/debug "$HOME/.elektra.log"
# or disable it for my user:
kdb set user/elektra/intercept/getenv/option/debug
\end{DoxyVerb}


Some more examples\+: \begin{DoxyVerb}kdb set user/elektra/intercept/getenv/override/MANOPT -- "--regex -LC"
elektrify-getenv getenv MANOPT   # to check if it is set as expected
kdb getenv MANOPT   # if /etc/ld.so.preload is active
\end{DoxyVerb}


Will permanently and user-\/wide change M\+A\+N\+O\+P\+T to include --regex, and -\/\+L\+C so that regular expressions will be used (note {\ttfamily man echo} will return many man pages then) and that they will be shown in English. This feature is handy to change the default behaviour of applications (either system, user or directory-\/wide).

\begin{DoxyVerb}kdb set system/elektra/intercept/getenv/override/HTTP_PROXY http://proxy.hogege.com:8000/
\end{DoxyVerb}


Will permanently and system-\/wide change the proxy for all applications that honor H\+T\+T\+P\+\_\+\+P\+R\+O\+X\+Y, e.\+g. w3m. We can also link {\ttfamily http\+\_\+proxy} to the value of {\ttfamily H\+T\+T\+P\+\_\+\+P\+R\+O\+X\+Y}\+: \begin{DoxyVerb}kdb setmeta spec/elektra/intercept/getenv/override/http_proxy "override/#0" /elektra/intercept/getenv/override/HTTP_PROXY
kdb get /elektra/intercept/getenv/override/http_proxy\end{DoxyVerb}
 