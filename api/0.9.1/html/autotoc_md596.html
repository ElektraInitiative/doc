<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Elektra: Plugin: reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Elektra
   &#160;<span id="projectnumber">0.9.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Plugin: reference </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>infos = Information about the reference plugin is in keys below</li>
<li>infos/author = Klemens BÃ¶swirth <a href="#" onclick="location.href='mai'+'lto:'+'k.b'+'oe'+'swi'+'rt'+'h+g'+'it'+'@gm'+'ai'+'l.c'+'om'; return false;">k.boe<span style="display: none;">.nosp@m.</span>swir<span style="display: none;">.nosp@m.</span>th+gi<span style="display: none;">.nosp@m.</span>t@gm<span style="display: none;">.nosp@m.</span>ail.c<span style="display: none;">.nosp@m.</span>om</a></li>
<li>infos/licence = BSD</li>
<li>infos/needs =</li>
<li>infos/provides =</li>
<li>infos/recommends =</li>
<li>infos/placements = presetstorage</li>
<li>infos/status = maintained unittest libc nodep writeonly</li>
<li>infos/metadata = check/reference check/reference/restrict check/reference/restrict/#</li>
<li>infos/description = Plugin for validating singular or recursive references</li>
</ul>
<p>This plugin serves one single purpose: the validation of references from key to another inside the KDB.</p>
<p>To specify a key as a reference add the metakey <code>check/reference</code>. Currently the metakey supports the three values <code>single</code>, <code>recursive</code> and <code>alternative</code>. While the value <code>alternative</code> only makes sense in a certain context inside the <code>recursive</code> mode, the other two values define to different modes of operation for the plugin.</p>
<p>If a key has the metakey <code>check/reference</code> with value <code>single</code>, the plugin reads the value of the key and produces an error, if the value is not a valid (i.e. resolvable) reference.</p>
<p>If a key has metakey <code>check/reference</code> with value <code>recursive</code>, the plugin constructs a reference graph starting with the marked key. (for the exact construction see below) In this reference graph each node corresponds to a key in the KDB, while each edge represents a reference between to keys. The plugin will produce an error, if this graph is not a directed acyclic graph or contains any invalid references.</p>
<p>The plugin will try to resolve all keys marked with the metakey <code>check/reference</code> as references. The only exception to this rule is, if the value of such a key is a valid array name (i.e. <code>#0</code>, <code>#_10</code>, ...). In that case, the plugin will try to resolve the values of the array elements, directly below the marked key. And treats the marked key as referencing multiple other keys.</p>
<p>The resolution of the references into key names goes as follows:</p>
<ul>
<li>If the reference value starts with <code>./</code> or <code>../</code>, it will be interpreted as relative to the current key or the parent of the current key.</li>
<li>If the reference value starts with <code>@/</code>, it will be relative to the parent-key used in the call to <code>kdbGet</code>.</li>
<li>All other values are treated as absolute and interpreted as a keyname directly.</li>
<li><code>.</code> and <code>..</code> will be treated the same way as in Unix paths. However, the plugin will emit warnings, if <code>.</code> is used anywhere other than before the first slash. Equally using <code>..</code> after a path segment other than <code>..</code> itself, will result in a warning. This is because these use cases are redundant and might be (or result in) mistakes. Here are a few examples of what results in warnings, and what doesn't:<ul>
<li><code>./system/key</code> no warning</li>
<li><code>system/key</code> no warning</li>
<li><code>system/./key</code> warning, redundant use of <code>.</code></li>
<li><code>../../../key</code> no warning</li>
<li><code>../key/../otherkey</code>warning, redundant use of <code>.</code></li>
</ul>
</li>
</ul>
<p>The process starts with a key <code>X</code>, which has the metakey <code>check/reference</code> set to the value <code>recursive</code>. This key <code>X</code> must be an array key. The basename of <code>X</code> will be called the <code>refname</code>. For each element in the array run the following process:</p>
<ol type="1">
<li>Interpret the current key <code>K</code>s value as a reference and throw an error, if the reference is not valid.</li>
<li>If there is no node for <code>K</code> in the reference graph create one. If there is no node for <code>R</code> in the reference graph create one. Insert an edge from <code>K</code> to <code>R</code> into the graph.</li>
<li>Find a key <code>K1</code> directly below <code>R</code> that has the <code>refname</code> as its basename. Interpret this key as an array if found. For each array element, start the process recursively from 1 and then continue with 4.</li>
<li>Find any key <code>K2</code> directly below <code>R</code> that has the metakey <code>check/reference</code> set to <code>alternative</code>. Interpret any such key as an array. For each array element, start the process recursively from 1, but this time using the basename of <code>K2</code> (the of the array) as the <code>refname</code>.</li>
</ol>
<p>Once the whole process is finished, we will have a graph of the whole reference structure stemming from <code>X</code>. This graph can then be check for acyclicity.</p>
<p>Without any additional intervention, the plugin accepts the name of any existing key as valid reference value. Existing in this context means, the key either has a value or metadata associated with it. In recursive mode a key is also said to exist, if a key with the current <code>refname</code> as a basename exists (has value or metadata) directly below the key in question. If, however, the key containing the reference value has the <code>check/reference/restrict</code> metakey set (even if the value is empty), its value has to be taken into account.</p>
<p>If the value <code>check/reference/restrict</code> is anything but a valid array-element-name, i.e. a <code>#</code> followed by <code>n</code> underscores (<code>_</code>) and <code>n+1</code> digits (<code>0-9</code>), its value will be used directly. Otherwise <code>check/reference/restrict</code> has to be a valid array and its elements will be treated as alternative restriction. Only one of these restriction has to be fulfilled for a reference to be valid.</p>
<p>Each restriction is first resolved as if it was a reference itself (see <a href="#resolution-of-references">Resolution of references</a>). The resolved value is then used as an Elektra-style globbing pattern. For the supported see elektra-globbing.</p>
<p>If a keyname matches the globbing expression it will be considered a valid reference (as long as the key actually exists).</p>
<p>Note: If the restriction is the empty string <code>""</code> <b>no</b> keyname will match, meaning the reference key annotated with this metadata has to be a leaf node in the reference graph, and therefore cannot have a value (other than the empty string <code>""</code>).</p>
<div class="fragment"><div class="line"># Mount the plugin</div><div class="line">sudo kdb mount referencetest.dump user/tests/reference dump reference</div><div class="line"></div><div class="line"># Mark a key as a single reference</div><div class="line">kdb meta-set user/tests/reference/singleref check/reference single</div><div class="line"></div><div class="line"># Try setting an invalid reference</div><div class="line">kdb set user/tests/reference/singleref user/tests/reference/referred1</div><div class="line"># RET: 5</div><div class="line"># STDERR: .*Reference &#39;user/tests/reference/referred1&#39;, set in key &#39;user/tests/reference/singleref&#39;, does not reference an existing key.*</div><div class="line"></div><div class="line"># Create referred key ...</div><div class="line">kdb set user/tests/reference/referred1 &quot;&quot;</div><div class="line">#&gt; Create a new key user/tests/reference/referred1 with string &quot;&quot;</div><div class="line"></div><div class="line"># ... and try again</div><div class="line">kdb set user/tests/reference/singleref user/tests/reference/referred1</div><div class="line">#&gt; Set string to &quot;user/tests/reference/referred1&quot;</div><div class="line"></div><div class="line"># Cleanup</div><div class="line">kdb rm user/tests/reference/singleref</div><div class="line">kdb rm user/tests/reference/referred1</div><div class="line"></div><div class="line"># Unmount the plugin</div><div class="line">sudo kdb umount user/tests/reference</div></div><!-- fragment --><p>The examples directory contains a few examples:</p>
<ul>
<li><a class="el" href="autotoc_md593.html#src_plugins_reference_examples_alternative_README_md">alternative</a> shows how the <code>alternative</code> value of <code>check/reference</code> gets processed.</li>
<li><a class="el" href="autotoc_md594.html#src_plugins_reference_examples_complex_README_md">complex</a> shows how the plugin can be used together with the spec plugin, to validate complex recursive structures. </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
